---
title: "SpringCloud Gateway"
date: "2021-07-29 18:00"
permalink: "2021-07-29-spring-cloud-gateway"

---

# SpringCloud Gatewayæ•™ç¨‹

:::tip

æœ¬ç« èŠ‚è®°å½•ä¸€ä¸‹ SpringCloud ä¸‹çš„å¾®æœåŠ¡ç½‘å…³ **Gateway** çš„å…¥é—¨æ•™ç¨‹ï¼Œç‰ˆæœ¬ç¯å¢ƒå¦‚ä¸‹ğŸ‘‡

:::

| æ¡†æ¶               | ç‰ˆæœ¬       |
| ------------------ | ---------- |
| *SpringBoot*       | **2.5.3**  |
| SpringCloud        | `2020.0.3` |
| SpringCloudAlibaba | **2021.1** |
| nacos              | 14.1       |
| Gateway            | `3.0.3`    |


## Gateway ç®€ä»‹

Spring Cloud Gateway æ˜¯ Spring Cloud çš„ä¸€ä¸ªå…¨æ–°é¡¹ç›®ï¼Œè¯¥é¡¹ç›®æ˜¯åŸºäº Spring 5.0ï¼ŒSpring Boot 2.0 å’Œ Project Reactor ç­‰æŠ€æœ¯å¼€å‘çš„ç½‘å…³ï¼Œå®ƒæ—¨åœ¨ä¸ºå¾®æœåŠ¡æ¶æ„æä¾›ä¸€ç§ç®€å•æœ‰æ•ˆçš„ç»Ÿä¸€çš„ API è·¯ç”±ç®¡ç†æ–¹å¼ã€‚

ç½‘å…³ä½œä¸ºæµé‡çš„å…¥å£ï¼Œå¸¸ç”¨åŠŸèƒ½åŒ…æ‹¬è·¯ç”±è½¬å‘ã€æƒé™æ ¡éªŒã€é™æµæ§åˆ¶ç­‰ã€‚è€Œ springcloud gateway ä½œä¸º SpringCloud å®˜æ–¹æ¨å‡ºçš„ç¬¬äºŒä»£ç½‘å…³æ¡†æ¶ï¼Œå–ä»£äº† Zuul ç½‘å…³

> å£°æ˜ï¼š**Spring Cloud Gateway åº•å±‚ä½¿ç”¨äº†é«˜æ€§èƒ½çš„é€šä¿¡æ¡†æ¶Netty**
>
> å®˜æ–¹ç½‘å€ï¼š[https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/](https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/)

## æ ¸å¿ƒæ¦‚å¿µ

- **Routeï¼ˆè·¯ç”±ï¼‰ï¼š** è¿™æ˜¯ç½‘å…³çš„åŸºæœ¬æ„å»ºå—ã€‚å®ƒç”±ä¸€ä¸ª IDï¼Œä¸€ä¸ªç›®æ ‡ URIï¼Œä¸€ç»„æ–­è¨€å’Œä¸€ç»„è¿‡æ»¤å™¨å®šä¹‰ã€‚å¦‚æœæ–­è¨€ä¸ºçœŸï¼Œåˆ™è·¯ç”±åŒ¹é…
- **Predicateï¼ˆæ–­è¨€ï¼‰ï¼š** Java8 ä¸­çš„æ–­è¨€å‡½æ•°ã€‚Spring Cloud Gateway ä¸­çš„æ–­è¨€å‡½æ•°è¾“å…¥ç±»å‹æ˜¯ Spring5.0 æ¡† æ¶ä¸­çš„ ServerWebExchangeã€‚Spring Cloud Gateway ä¸­çš„æ–­è¨€å‡½æ•°å…è®¸å¼€å‘è€…å»å®šä¹‰åŒ¹é… æ¥è‡ªäº http request ä¸­çš„ä»»ä½•ä¿¡æ¯ï¼Œæ¯”å¦‚è¯·æ±‚å¤´å’Œå‚æ•°ç­‰
- **Filterï¼ˆè¿‡æ»¤å™¨ï¼‰ï¼š** ä¸€ä¸ªæ ‡å‡†çš„ Spring webFilterã€‚Spring cloud gateway ä¸­çš„ filter åˆ†ä¸ºä¸¤ç§ç±»å‹çš„ Filterï¼Œåˆ†åˆ«æ˜¯ **`Gateway Filter`** å’Œ **`Global Filter`**ã€‚è¿‡æ»¤å™¨ Filter å°†ä¼šå¯¹è¯·æ±‚å’Œå“åº”è¿›è¡Œä¿®æ”¹ å¤„ç†

**å·¥ä½œåŸç†å¦‚ä¸‹å›¾ğŸ‘‡**

![21UTs0](https://media.zenghr.cn/blog/img/20210729/21UTs0.png)

å®¢æˆ·ç«¯å‘ Spring Cloud Gateway å‘å‡ºè¯·æ±‚ã€‚ç„¶ååœ¨ **Gateway Handler Mapping** ä¸­æ‰¾åˆ°ä¸è¯·æ±‚ç›¸åŒ¹é…çš„è·¯ç”±ï¼Œå°†å…¶å‘é€åˆ° Gateway Web Handler

Handler å†å°†è¯·æ±‚äº¤ç»™ä¸€ä¸ªè¿‡æ»¤å™¨é“¾ï¼Œè¯·æ±‚åˆ°è¾¾ç›®æ ‡æœåŠ¡ä¹‹å‰ï¼Œä¼šæ‰§è¡Œæ‰€æœ‰è¿‡æ»¤å™¨çš„ **pre** æ–¹æ³•ã€‚è¯·æ±‚åˆ°è¾¾ç›®æ ‡æœåŠ¡å¤„ç†ä¹‹åå†ä¾æ¬¡æ‰§è¡Œæ‰€æœ‰è¿‡æ»¤å™¨çš„ **post** æ–¹æ³•

> æ€»ä¹‹å°±æ˜¯ï¼š**æ»¡è¶³æŸäº›æ–­è¨€(predicates)å°±è·¯ç”±åˆ°æŒ‡å®šçš„åœ°å€(uri)ï¼Œä½¿ç”¨æŒ‡å®šçš„è¿‡æ»¤å™¨(filter)**

## æ­å»º Gateway ç¯å¢ƒ

è¦ä½¿ç”¨ SpringCloud Gateway éœ€è¦å¯¼å…¥ç›¸åº”çš„ä¾èµ–ï¼Œä¹‹åéœ€è¦è®¾ç½® **Gateway çš„è·¯ç”±é…ç½®**

æˆ‘ä½¿ç”¨äº† **`spring-boot 2.5.3`** ä½œä¸º parent ä¾èµ–

```xml
<parent>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-parent</artifactId>
    <version>2.5.3</version>
    <relativePath/> <!-- lookup parent from repository -->
</parent>
```

åœ¨ dependencyManagement ä¸­ï¼Œ**æˆ‘ä»¬éœ€è¦æŒ‡å®š SringCloud çš„ç‰ˆæœ¬**ï¼Œä»¥ä¾¿ä¿è¯æˆ‘ä»¬èƒ½å¤Ÿå¼•å…¥æˆ‘ä»¬æƒ³è¦çš„ SpringCloud Gatewayç‰ˆæœ¬ï¼Œæ‰€ä»¥éœ€è¦ç”¨åˆ° **dependencyManagement**

```xml
<properties>
    <spring-cloud.version>2020.0.3</spring-cloud.version>
</properties>
<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-dependencies</artifactId>
            <version>${spring-cloud.version}</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>
```

æœ€åå¯¼å…¥æˆ‘ä»¬çš„ Gateway ä¾èµ–

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-gateway</artifactId>
</dependency>
```

> æ­¤å¤–ï¼Œè¯·æ£€æŸ¥ä¸€ä¸‹ä½ çš„ä¾èµ–ä¸­æ˜¯å¦å«æœ‰ **spring-boot-starter-web**ï¼Œå¦‚æœæœ‰ï¼Œ**è¯·å¹²æ‰å®ƒ**ã€‚å› ä¸ºæˆ‘ä»¬çš„SpringCloud Gatewayæ˜¯ä¸€ä¸ª**netty+webflux** å®ç°çš„webæœåŠ¡å™¨ï¼Œå’Œ Springboot Web æœ¬èº«å°±æ˜¯å†²çªçš„

## åŸºç¡€ URI è·¯ç”±é…ç½®æ–¹å¼

å¦‚æœè¯·æ±‚çš„ç›®æ ‡åœ°å€ï¼Œæ˜¯å•ä¸ªçš„URIèµ„æºè·¯å¾„ï¼Œé…ç½®æ–‡ä»¶ç¤ºä¾‹å¦‚ä¸‹ï¼š

```yaml
server:
  port: 88
spring:
  application:
    name: api-gateway
  cloud:
    gateway:
      routes:
        -id: url-proxy-1
         uri: https://blog.zenghr.cn
         predicates:
           - Path=/blog
```

å‚æ•°è¯´æ˜ï¼š

- **idï¼š** æˆ‘ä»¬è‡ªå®šä¹‰çš„è·¯ç”± IDï¼Œä¿æŒå”¯ä¸€
- **uriï¼š** ç›®æ ‡æœåŠ¡åœ°å€
- **predicatesï¼š** è·¯ç”±æ¡ä»¶ï¼ŒPredicate æ¥å—ä¸€ä¸ªè¾“å…¥å‚æ•°ï¼Œè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ç»“æœ

ä¸Šé¢è¿™æ®µé…ç½®çš„æ„æ€æ˜¯ï¼Œé…ç½®äº†ä¸€ä¸ª id ä¸º **url-proxy-1** çš„URIä»£ç†è§„åˆ™ï¼Œè·¯ç”±çš„è§„åˆ™ä¸ºï¼š

å½“è®¿é—®åœ°å€ **`http://localhost:88/blog/1.html`** æ—¶ï¼Œä¼šè·¯ç”±åˆ°ä¸Šæ¸¸åœ°å€ **`https://blog.zenghr.cn/blog/1.html`**

## åŸºäºä»£ç çš„è·¯ç”±é…ç½®æ–¹å¼

è½¬å‘åŠŸèƒ½ä»£ç ä¹Ÿå¯ä»¥é€šè¿‡ä»£ç çš„æ–¹å¼æ¥å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ **`RouteLocator`** Bean å®ç°è‡ªå®šä¹‰åˆ¶è½¬å‘è§„åˆ™

```java
@Configuration
public class GatewayConfiguration {
    @Bean
    public RouteLocator customRouteLocator(RouteLocatorBuilder builder) {
        return builder.routes()
                .route("url-proxy-1",
                        p -> p.predicate(e -> e.getRequest().getURI().getPath().startsWith("/blog"))
                                .filters(f -> f.rewritePath("/blog/(?<remaining>.*)", "/${remaining}"))
                                .uri("https://blog.zenghr.cn"))
                .route("url-proxy-2", p -> p.path("/blog2").uri("https://blog.zenghr.cn"))
                .build();
    }
}
```

æˆ‘ä»¬æ³¨é‡Šæ‰ xml é…ç½®æ–‡ä»¶ä¸­çš„ Gateway è·¯ç”±è®¾ç½®ï¼Œé‡å¯æœåŠ¡ï¼Œ å½“è®¿é—®åœ°å€ **`http://localhost:88/blog/1.html`** æ—¶ï¼Œä¼šè·¯ç”±åˆ°ä¸Šæ¸¸åœ°å€ **`https://blog.zenghr.cn/1.html`** , èƒ½å¤Ÿè®¿é—®è¯´æ˜æˆ‘ä»¬çš„ä»£ç é…ç½®æˆåŠŸ

**å‚æ•°è¯´æ˜**

é€šè¿‡ **RouteLocatorBuilder** çš„routesï¼Œå¯ä»¥é€ä¸€å»ºç«‹è·¯ç”±ï¼Œæ¯è°ƒç”¨routeä¸€æ¬¡å¯å»ºç«‹ä¸€æ¡è·¯ç”±è§„åˆ™

p çš„ä»£è¡¨æ˜¯ PredicateSpecï¼Œå¯ä»¥é€è¿‡å®ƒçš„ **predicate** æ¥è¿›è¡Œæ–­è¨€ï¼Œè¦å®ç°çš„æ¥å£å°±æ˜¯Java 8çš„ **Predicate**ï¼Œé€šè¿‡ exchange å–å¾—äº†è·¯å¾„ï¼Œç„¶ååˆ¤æ–­å®ƒæ˜¯ä¸æ˜¯ä»¥ /blog å¼€å¤´ï¼Œå¯¹äºç®€å•çš„æƒ…å†µï¼Œä¹Ÿå¯ä»¥é€šè¿‡ **path** ç­‰æ¥è¿›è¡Œæ–­è¨€

**filters** æ˜¯ç”¨æ¥è®¾ç½®è¿‡æ»¤å™¨ï¼Œ**rewritePath** æ–¹æ³•ä¼šä½¿ç”¨å†…å»ºçš„è¿‡æ»¤å™¨é‡å†™è·¯å¾„



## æ³¨å†Œä¸­å¿ƒç›¸ç»“åˆçš„è·¯ç”±é…ç½®æ–¹å¼

åœ¨ uri çš„ schema åè®®éƒ¨åˆ†ä¸ºè‡ªå®šä¹‰çš„ **lb:ç±»å‹**ï¼Œè¡¨ç¤ºä»å¾®æœåŠ¡æ³¨å†Œä¸­å¿ƒï¼ˆå¦‚ Nacosï¼‰è®¢é˜…æœåŠ¡ï¼Œå¹¶ä¸”è¿›è¡ŒæœåŠ¡çš„è·¯ç”±

> åœ¨æˆ‘çš„é¡¹ç›®ä¸­ï¼Œä½¿ç”¨çš„æ˜¯ **gateway + nacos** çš„æ–¹å¼æ¥å®ç°çš„

å¯¼å…¥ nacos çš„æœåŠ¡æ³¨å†Œä¾èµ–ï¼Œéœ€è¦æŠŠ gateway æœåŠ¡æ³¨å†Œåˆ° nacosï¼Œæ‰èƒ½å‘ç°å…¶ä»–æœåŠ¡

```xml
<!-- nacos æœåŠ¡å‘ç° -->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
<!-- nacos é…ç½®ä¸­å¿ƒ -->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
</dependency>
```

å¦‚æœéœ€è¦ä½¿ç”¨ nacos ä½œä¸ºé…ç½®ä¸­å¿ƒï¼Œä¹Ÿå¯ä»¥å¯¼å…¥ç›¸åº”çš„ä¾èµ–

æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶å†…å®¹éœ€è¦å¦‚ä¸‹è®¾ç½®ğŸ‘‡

```yaml
spring:
  application:
    name: api-gateway
  cloud:
    nacos:
      discovery:
        server-addr: 127.0.0.1:8848
    gateway:
      discovery:
        locator:
          enabled: true # å¼€å¯æœåŠ¡å‘ç°åŠŸèƒ½ï¼Œé»˜è®¤ä¸º false
      routes:
        - id: member_route
          uri: lb://mall-member
          predicates:
            - Path=/api/member/**
          filters:
            - RewritePath=/api/member/(?<segment>.*),/$\{segment}
```

**å‚æ•°è¯´æ˜**

- **locator.enabledï¼š** å¼€å¯æœåŠ¡å‘ç°ï¼Œéœ€è¦å¼€å¯è¯¥é…ç½®
- **lb:** ä»£è¡¨ è´Ÿè½½å‡è¡¡

::: warning

ç”±äº **SpringCloud 2020** å¼ƒç”¨äº† Ribbonï¼Œå› æ­¤ Alibaba åœ¨ **`2021 ç‰ˆæœ¬ nacos`** ä¸­åˆ é™¤äº† Ribbonçš„ jar åŒ…ï¼Œå› æ­¤æ— æ³•é€šè¿‡**lbè·¯ç”±åˆ°æŒ‡å®šå¾®æœåŠ¡ï¼Œå‡ºç°äº†503æƒ…å†µ**

æ‰€ä»¥åªéœ€è¦å¼•å…¥ **springcloud loadbalancer** åŒ…å³å¯

:::

```xml
<!--å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡loadbalancer-->
<dependency>
	<groupId>org.springframework.cloud</groupId>
	<artifactId>spring-cloud-starter-loadbalancer</artifactId>
</dependency>
```

## Gateway åŒ¹é…è§„åˆ™

Spring Cloud Gateway æ˜¯é€šè¿‡ Spring WebFlux çš„ HandlerMapping åšä¸ºåº•å±‚æ”¯æŒæ¥åŒ¹é…åˆ°è½¬å‘è·¯ç”±ï¼ŒSpring Cloud Gateway å†…ç½®äº†å¾ˆå¤š Predicates å·¥å‚ï¼Œè¿™äº› Predicates å·¥å‚é€šè¿‡ä¸åŒçš„ HTTP è¯·æ±‚å‚æ•°æ¥åŒ¹é…ï¼Œå¤šä¸ª Predicates å·¥å‚å¯ä»¥ç»„åˆä½¿ç”¨

![U3Me4V](https://media.zenghr.cn/blog/img/20210729/U3Me4V.png)

æ¥ä¸‹æ¥æˆ‘ä»¬ä»‹ç» Spring Cloud GateWay å†…ç½®å‡ ç§ Predicate çš„ä½¿ç”¨

### é€šè¿‡è¯·æ±‚å‚æ•°åŒ¹é…

Query Route Predicate æ”¯æŒä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å±æ€§åä¸€ä¸ªä¸ºå±æ€§å€¼ï¼Œå±æ€§å€¼å¯ä»¥æ˜¯æ­£åˆ™è¡¨è¾¾å¼

```yaml
server:
  port: 88
spring:
  application:
    name: api-gateway
  cloud:
    gateway:
      routes:
        -id: url-proxy-1
         uri: https://blog.zenghr.cn
         predicates:
           - Query=url,blog
```

è¿™æ ·é…ç½®ï¼Œåªè¦è¯·æ±‚ä¸­åŒ…å« url å±æ€§çš„å‚æ•°ï¼Œå¹¶ä¸”å‚æ•°å€¼æ˜¯ blog å³å¯åŒ¹é…è·¯ç”±

### é€šè¿‡ Cookie åŒ¹é…

Cookie Route Predicate å¯ä»¥æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯ Cookie name ,ä¸€ä¸ªæ˜¯æ­£åˆ™è¡¨è¾¾å¼ï¼Œè·¯ç”±è§„åˆ™ä¼šé€šè¿‡è·å–å¯¹åº”çš„ Cookie name å€¼å’Œæ­£åˆ™è¡¨è¾¾å¼å»åŒ¹é…ï¼Œå¦‚æœåŒ¹é…ä¸Šå°±ä¼šæ‰§è¡Œè·¯ç”±ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…ä¸Šåˆ™ä¸æ‰§è¡Œ

```yaml
server:
  port: 88
spring:
  application:
    name: api-gateway
  cloud:
    gateway:
      routes:
        -id: url-proxy-1
         uri: https://blog.zenghr.cn
         order: 0
         predicates:
           - Cookie=sessionId, test
```

### é€šè¿‡ Header å±æ€§åŒ¹é…

Header Route Predicate å’Œ Cookie Route Predicate ä¸€æ ·ï¼Œä¹Ÿæ˜¯æ¥æ”¶ 2 ä¸ªå‚æ•°ï¼Œä¸€ä¸ª header ä¸­å±æ€§åç§°å’Œä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œè¿™ä¸ªå±æ€§å€¼å’Œæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…åˆ™æ‰§è¡Œ

```yaml
server:
  port: 88
spring:
  application:
    name: api-gateway
  cloud:
    gateway:
      routes:
        -id: url-proxy-1
         uri: https://blog.zenghr.cn
         order: 0
         predicates:
           - Header=X-Request-Id, \d+
```

### é€šè¿‡è¯·æ±‚æ–¹å¼åŒ¹é…

å¯ä»¥é€šè¿‡æ˜¯ POSTã€GETã€PUTã€DELETE ç­‰ä¸åŒçš„è¯·æ±‚æ–¹å¼æ¥è¿›è¡Œè·¯ç”±

```yaml
server:
  port: 88
spring:
  application:
    name: api-gateway
  cloud:
    gateway:
      routes:
        -id: url-proxy-1
         uri: https://blog.zenghr.cn
         order: 0
         predicates:
           - Method=GET
```

> è¿™é‡Œæˆ‘ä»¬å°±åªåˆ—å‡ºä¸€äº›å¸¸ç”¨çš„åŒ¹é…æ–¹å¼ï¼Œå¦‚æœéœ€è¦æŸ¥è¯¢å…¶ä»–åŒ¹é…æ–¹å¼ï¼Œå¯ä»¥æŸ¥çœ‹ [SpringCloud Gateway](https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gateway-request-predicates-factories) çš„å®˜æ–¹æ–‡æ¡£

## è¿‡æ»¤å™¨ Filter

è¿‡æ»¤å™¨å°±æ˜¯åœ¨è¯·æ±‚çš„ä¼ é€’è¿‡ç¨‹ä¸­,å¯¹è¯·æ±‚å’Œå“åº”åšä¸€äº›æ‰‹è„š

åœ¨ Gateway ä¸­ï¼ŒFilterçš„ç”Ÿå‘½å‘¨æœŸåªæœ‰ä¸¤ä¸ªï¼š`"pre"` å’Œ `"post"` 

- PREï¼š è¿™ç§è¿‡æ»¤å™¨åœ¨è¯·æ±‚è¢«è·¯ç”±ä¹‹å‰è°ƒç”¨ã€‚æˆ‘ä»¬å¯åˆ©ç”¨è¿™ç§è¿‡æ»¤å™¨å®ç°èº«ä»½éªŒè¯ã€åœ¨é›†ç¾¤ä¸­é€‰æ‹©è¯·æ±‚çš„å¾®æœåŠ¡ã€è®°å½•è°ƒè¯•ä¿¡æ¯ç­‰ã€‚

- POSTï¼šè¿™ç§è¿‡æ»¤å™¨åœ¨è·¯ç”±åˆ°å¾®æœåŠ¡ä»¥åæ‰§è¡Œã€‚è¿™ç§è¿‡æ»¤å™¨å¯ç”¨æ¥ä¸ºå“åº”æ·»åŠ æ ‡å‡†çš„HTTP Headerã€æ”¶é›†ç»Ÿè®¡ä¿¡æ¯å’ŒæŒ‡æ ‡ã€å°†å“åº”ä»å¾®æœåŠ¡å‘é€ç»™å®¢æˆ·ç«¯ç­‰

åœ¨ Gateway ä¸­ï¼ŒFilter çš„ä½œç”¨èŒƒå›´ä¸¤ç§:

- GatewayFilterï¼šåº”ç”¨åˆ°å•ä¸ªè·¯ç”±æˆ–è€…ä¸€ä¸ªåˆ†ç»„çš„è·¯ç”±ä¸Š
- GlobalFilterï¼šåº”ç”¨åˆ°æ‰€æœ‰çš„è·¯ç”±ä¸Š

### å®šä¹‰å±€éƒ¨è¿‡æ»¤å™¨

å±€éƒ¨è¿‡æ»¤å™¨æ˜¯é’ˆå¯¹å•ä¸ªè·¯ç”±çš„è¿‡æ»¤å™¨ï¼Œåœ¨SpringCloud Gatewayä¸­å†…ç½®äº†å¾ˆå¤šä¸åŒç±»å‹çš„ç½‘å…³è·¯ç”±è¿‡æ»¤å™¨

> å¼€å‘å° Tip ï¼šå¦‚æœä¸çŸ¥é“è‡ªå®šä¹‰å¯ä»¥æŸ¥çœ‹ Gateway ä¸­å†…ç½®çš„è¿‡æ»¤å™¨ï¼Œä½¿ç”¨ cv å¤§æ³• å’”å’”æ”¹é€ ä¸€é¡¿å°±å¥½äº†

*éœ€æ±‚ï¼šå®ç°è‡ªå®šä¹‰è¿‡æ»¤å™¨ç»Ÿè®¡è¯·æ±‚è€—æ—¶*

**ä¸€ã€ç¬¬ä¸€æ­¥ç¼–å†™ Filter ç±»ï¼Œæ ¹æ®å…¶å†…ç½®çš„è¿‡æ»¤å™¨å‘ç°åç§°æ ¼å¼æœ‰è§„å¾‹ï¼š`XxxGatewayFilterFactory`**

```yaml
spring:
  application:
    name: api-gateway
    gateway:
      routes:
        - id: product_route
          uri: lb://product-server
          predicates:
            - Path=/product-server/**
          filters:
            - StripPrefix=1
```

![451cP6](https://media.zenghr.cn/blog/img/20210906/451cP6.png)

ä¸‹é¢æ˜¯è‡ªå·±å†™çš„è‡ªå®šä¹‰è¿‡æ»¤å™¨ä»£ç 

```java
@Component
public class TimeGatewayFilterFactory extends AbstractGatewayFilterFactory<TimeGatewayFilterFactory.Config> {
    public static final String PARTS_KEY = "parts";

    public TimeGatewayFilterFactory() {
        super(TimeGatewayFilterFactory.Config.class);
    }

    public List<String> shortcutFieldOrder() {
        return Arrays.asList("parts");
    }

    public GatewayFilter apply(TimeGatewayFilterFactory.Config config) {
        return new GatewayFilter() {
            public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
                // ä¸å¯ç”¨æƒ…å†µ
                if (!config.parts) {
                    return chain.filter(exchange);
                }

                // å‰ç½®æ“ä½œ
                long startTime = System.currentTimeMillis();
                exchange.getAttributes().put("startTime", startTime);

                return chain.filter(exchange).then(Mono.fromRunnable(() -> {
                    // åç½®æ“ä½œ
                    long start = (long) exchange.getAttributes().get("startTime");
                    System.out.println("æ¥å£è€—æ—¶ï¼š" + (System.currentTimeMillis() - start) + "ms");
                }));
            }

            public String toString() {
                return GatewayToStringStyler.filterToStringCreator(TimeGatewayFilterFactory.this).append("parts", config.getParts()).toString();
            }
        };
    }

    public static class Config {
        private boolean parts;

        public Config() {
        }

        public boolean getParts() {
            return this.parts;
        }

        public void setParts(boolean parts) {
            this.parts = parts;
        }
    }
}
```

**äºŒã€åœ¨æŒ‡å®šçš„è·¯ç”±ä¸­æ·»åŠ è·¯ç”±è§„åˆ™**

```yaml
spring:
  application:
    name: api-gateway
    gateway:
      routes:
        - id: product_route
          uri: lb://product-server
          predicates:
            - Path=/product-server/**
          filters:
            - StripPrefix=1
            - Time=true
```

è®¿é—® product-server æœåŠ¡æ—¶å°†ä¼šæ‰“å°æ¥å£è€—æ—¶æ—¥å¿—

### è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨

å…¨å±€è¿‡æ»¤å™¨ä½œç”¨äºæ‰€æœ‰è·¯ç”±ï¼Œæ— éœ€é…ç½®ï¼Œé€šè¿‡å…¨å±€è¿‡æ»¤å™¨å¯ä»¥å®ç°å¯¹æƒé™çš„ç»Ÿä¸€æ ¡éªŒï¼Œå®‰å…¨æ€§éªŒè¯ç­‰åŠŸèƒ½ã€‚

SpringCloud Gatewayå†…éƒ¨ä¹Ÿæ˜¯é€šè¿‡ä¸€ç³»åˆ—çš„å†…ç½®å…¨å±€è¿‡æ»¤å™¨å¯¹æ•´ä¸ªè·¯ç”±è½¬å‘è¿›è¡Œå¤„ç†å¦‚ä¸‹ï¼š

![h27xKu](https://media.zenghr.cn/blog/img/20210906/h27xKu.jpg)

**ç¼–å†™å…¨å±€è¿‡æ»¤å™¨ï¼Œç»§æ‰¿äº *GlobalFilter* ç±»**

```java
@Component
public class AuthGlobalFilter implements GlobalFilter {
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        // ä¸šåŠ¡ä»£ç ...
        return chain.filter(exchange);
    }
}
```



## Gateway å®ç°åŠ¨æ€è·¯ç”±åˆ·æ–°

:::tip

é€šå¸¸åœ¨Nacosæ¥å…¥äº†Spring Cloudçš„Gatewayåè¿˜éœ€è‡ªå®šä¹‰å®ç°åŠ¨æ€çš„è·¯ç”±é…ç½®æ¥æä¾›åç»­æ›´ä¸ºçµæ´»çš„æ¥å£å‘å¸ƒä¸ç»´æŠ¤ï¼Œè¿™é‡Œä¸»è¦è®°å½•å®ç°æ­¥éª¤

å‚è€ƒæ–‡æ¡£ï¼š

[Spring Cloud Gatewayæ¥å…¥nacosåŠ¨æ€è·¯ç”±åˆ·æ–°](https://noir-lattice.github.io/2020/10/01/Spring-Cloud-Gateway%E6%8E%A5%E5%85%A5nacos%E5%8A%A8%E6%80%81%E8%B7%AF%E7%94%B1%E5%88%B7%E6%96%B0/)

[SpringCloud Gateway åŸºäº Nacos å®ç°åŠ¨æ€è·¯ç”±](https://kqkd.vip/archives/springcloudgateway%E5%9F%BA%E4%BA%8Enacos%E5%AE%9E%E7%8E%B0%E5%8A%A8%E6%80%81%E8%B7%AF%E7%94%B1)

:::

é›†æˆ Nacos çš„ç›¸å…³æ“ä½œè¯·çœ‹ä¸Šæ–‡çš„ [æ³¨å†Œä¸­å¿ƒç›¸ç»“åˆçš„è·¯ç”±é…ç½®æ–¹å¼](/passages/2021-07-29-spring-cloud-gateway.html#æ³¨å†Œä¸­å¿ƒç›¸ç»“åˆçš„è·¯ç”±é…ç½®æ–¹å¼) ï¼Œè¿™é‡Œå°±ä¸å†è¯¦ç»†è¯´æ˜

### Nacos é…ç½®æ–‡ä»¶

![M8f7ep](https://media.zenghr.cn/blog/img/20210730/M8f7ep.png)

**application.yml é…ç½®å¦‚ä¸‹**

```yaml
# è‡ªå®šä¹‰çš„é…ç½®é¡¹ï¼Œç”¨äºè®¾ç½®è·¯ç”±ä¿¡æ¯æ‰€è½½çš„é…ç½®æ–‡ä»¶ï¼Œæ¯”å¦‚è¿™é‡Œæ˜¯ group + dataId
gateway:
  dynamicRoute:
    dataId: gateway.yaml
    group: dev
```

### åŠ¨æ€æ›´æ–°é…ç½®æ–‡ä»¶

æŒ‡å®šè·¯ç”±é…ç½®æ–‡ä»¶ï¼Œç”¨äºå¯åŠ¨æ—¶åˆ›å»ºNacos Configæ–‡ä»¶ç›‘å¬

```java
import lombok.Data;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Configuration;

@Data
@Configuration
public class DynamicRoutingFileProperties {
    /**
     * é…ç½®æ–‡ä»¶id
     */
    @Value("${gateway.dynamicRoute.dataId}")
    private String dataId;

    /**
     * é…ç½®åˆ†ç»„
     */
    @Value("${gateway.dynamicRoute.group}")
    private String groupId;

    private Long timeout = 3000L;
}
```

### åŠ¨æ€è·¯ç”±ç›‘å¬

```java
/**
 * åŠ¨æ€è·¯ç”±ç›‘å¬
 *
 * æ·»åŠ å¯¹å¯¹åº”é…ç½®æ–‡ä»¶æ›´æ–°æ—¶çš„ç›‘å¬ï¼Œå®ç°åŠ¨æ€è·¯ç”±åˆ·æ–°ã€‚ä¸€èˆ¬çš„ï¼Œä¸ºäº†ä¿è¯
 * ä»…åœ¨å¯åŠ¨æ—¶æ³¨å†ŒæŒ‡å®šçš„å¯¹åº”æ–‡ä»¶ï¼ˆé€šå¸¸è¿™ä¸ªæ–‡ä»¶ä¹Ÿæ˜¯åŠ¨æ€é…ç½®ï¼Œè¿™é‡Œæš‚æ—¶æ²¡
 * æœ‰å®ç°å½“æ›´æ¢è·¯ç”±é…ç½®æ–‡ä»¶æ—¶çš„åˆ·æ–°ï¼‰æ›´æ–°æ—¶å¯¹æ­£åœ¨è¿è¡Œçš„è·¯ç”±ä¿¡æ¯è¿›è¡Œåˆ·
 * æ–°ã€‚
 *
 * è¯¥ç±»ä¸»è¦å®ç°yamlè§£æï¼Œå¹¶æ„å»ºdefinitionå¯¹è±¡ï¼Œå¯¹äºå…·ä½“çš„åˆ·æ–°é€»è¾‘
 * @see DynamicRouteService
 */
@Slf4j
@Component
@RefreshScope
public class DynamicRouteServiceListener implements CommandLineRunner {

    @Autowired
    private DynamicRouteService dynamicRouteService;

    @Autowired
    NacosConfigManager nacosConfigManager;

    @Autowired
    private DynamicRoutingFileProperties dynamicRoutingFileProperties;

    /**
     * æ·»åŠ é…ç½®æ–‡ä»¶æ›´æ–°ç›‘å¬
     */
    private void dynamicRouteListener () {
        try {
            ConfigService configService = nacosConfigManager.getConfigService();
            // first process ed add listener
            processConfigInfo(configService.getConfigAndSignListener(
                    dynamicRoutingFileProperties.getDataId(),
                    dynamicRoutingFileProperties.getGroupId(),
                    dynamicRoutingFileProperties.getTimeout(),
                    new Listener()  {
                        @Override
                        public void receiveConfigInfo(String configInfo) {
                            processConfigInfo(configInfo);
                        }

                        @Override
                        public Executor getExecutor() {
                            return null;
                        }
                    }
            ));
        } catch (NacosException e) {
            log.error("add config listener fail !!!");
            e.printStackTrace();
        }
    }

    /**
     * å¤„ç†é…ç½®ä¿¡æ¯
     *
     * @param configInfo é…ç½®string
     */
    private void processConfigInfo(String configInfo) {
        if (Objects.isNull(configInfo)) return;
        // è§£æyamlæ–‡ä»¶è·å–è·¯ç”±å®šä¹‰
        List<RouteDefinition> targetRouteDefinitions = getRouteDefinitionsByYaml(configInfo);
        // æ›´æ–°è·¯ç”±ä¿¡æ¯
        dynamicRouteService.refresh(targetRouteDefinitions);
    }

    /**
     * é€šè¿‡yaml strè§£æå‡ºrouteå®šä¹‰
     *
     * @param configInfo yaml str
     * @return RouteDefinition array
     */
    private List<RouteDefinition> getRouteDefinitionsByYaml(String configInfo) {
        Yaml yaml = new Yaml();
        Map<Object, Object> document = yaml.load(configInfo);
        List<Map<String, Object>> routeList = (List<Map<String, Object>>) document.get("routes");
        List<RouteDefinition> targetRouteDefinitions = new ArrayList<>(routeList.size());
        for (Map<String, Object> routeItem : routeList) {
            RouteDefinition routeDefinition = new RouteDefinition();
            routeDefinition.setId((String) routeItem.get("id"));
            routeDefinition.setUri(URI.create((String) routeItem.get("uri")));
            List<String> predicateStrList = (List<String>) routeItem.get("predicates");
            List<PredicateDefinition> predicateDefinitions = predicateStrList.stream().map(PredicateDefinition::new).collect(Collectors.toList());
            routeDefinition.setPredicates(predicateDefinitions);
            List<String> filterStrList = (List<String>) routeItem.get("filters");
            if (CollectionUtils.isNotEmpty(filterStrList)) {
                List<FilterDefinition> filterDefinitions = filterStrList.stream().map(FilterDefinition::new).collect(Collectors.toList());
                routeDefinition.setFilters(filterDefinitions);
            }
            Object orderObj = routeItem.get("order");
            int order = Objects.isNull(orderObj) ? 0 : (int) orderObj;
            routeDefinition.setOrder(order);
            targetRouteDefinitions.add(routeDefinition);
        }

        return targetRouteDefinitions;
    }

    @Override
    public void run(String... args) {
        Long startTime = System.currentTimeMillis();
        dynamicRouteListener();
        Long completeTime = System.currentTimeMillis();
        log.info("dynamic router cost {}ms to initialization routes and registered configurer.", completeTime - startTime);
    }
}
```



### åŠ¨æ€è·¯ç”±æœåŠ¡å®ç°

```java
/**
 * åŠ¨æ€è·¯ç”±æœåŠ¡å®ç°
 *
 * å…·ä½“çš„è·¯ç”±ä¿¡æ¯å˜æ›´åˆ·æ–°ï¼Œå› ç›‘å¬æ–‡ä»¶æ›´æ–°ä»…å¯æ‹¿åˆ°å…¨é‡çš„è·¯ç”±é…ç½®ï¼Œ
 * ä¸ºäº†å‡è½»æ•´ä½“é€»è¾‘è´Ÿæ‹…ï¼Œä½¿ç”¨mergeé€»è¾‘æ›´æ–°definitionå¹¶å‘å‡ºå˜
 * æ›´é€šçŸ¥ã€‚
 *
 * è™½ç„¶ä»…å˜æ›´ä¸é€šçŸ¥ï¼Œå¯ä»¥ç®€æ˜“çš„é€šè¿‡å…¨é‡åˆ é™¤å¹¶å…¨é‡æ·»åŠ å³å¯å®ç°è·¯ç”±
 * æ›´æ–°ï¼Œä½†å¹¶ä¸ä¿è¯åç»­æ˜¯å¦å­˜åœ¨å¯¹å†å²definitionå¯¹è±¡çš„å¼•ç”¨ï¼Œæ•…æ­¤
 * å¤„ä½¿ç”¨æ›´ä¿é™©çš„ç­–ç•¥ã€‚
 *
 * åˆå› ä¸ºmergeç­–ç•¥ï¼Œå¯èƒ½å¯¼è‡´å¯¹éƒ¨åˆ†definitionæ›´æ–°åä¼šå½±å“é»˜è®¤çš„
 * order,æ‰€ä»¥åœ¨æ·»åŠ æ³¨å†Œæ—¶ä¼šå¡«å……æœªæ ‡è®°çš„orderã€‚
 */
@Slf4j
@Component
public class DynamicRouteService implements ApplicationEventPublisherAware {

    @Resource
    private RouteDefinitionRepository routeDefinitionRepository;

    private ApplicationEventPublisher publisher;

    /**
     * mergeæ›´æ–°è·¯ç”±
     *
     * ä¿è¯åˆ·æ–°é€»è¾‘ä¸å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œåˆ·æ–°è·¯ç”±å¹¶æ²¡æœ‰å¾ˆé«˜çš„æ€§èƒ½éœ€æ±‚ï¼Œæ­¤å¤„é”ä½æ•´ä¸ªrefreshæ–¹æ³•ã€‚
     * @param definitions è·¯ç”±è¯¦æƒ…é›†åˆ
     */
    public synchronized void refresh(List<RouteDefinition> definitions) {
        // å¡«å……ç”Ÿæˆorder
        fillTargetRouteOrder(definitions);
        // ç›®æ ‡routes idé›†åˆ
        List<String> targetDefIds = definitions.stream().map(RouteDefinition::getId).collect(Collectors.toList());
        // è·å–ç°å­˜æ‰€æœ‰è·¯ç”±map
        Map<String, RouteDefinition> aliveRouteMap = getAliveRouteMap();
        // åˆ é™¤å¤±æ•ˆçš„routes
        removeDefinitions(targetDefIds, aliveRouteMap);
        // æ›´æ–°definitions
        updateDefinitions(definitions, aliveRouteMap);
        // æ·»åŠ definitions
        createDefinitions(definitions, aliveRouteMap);
        // å‘å¸ƒè·¯ç”±å·²æ›´æ–°æ—¶é—´
        publishRouteChangedEvent();
    }

    /**
     * å¡«å……ç›®æ ‡è·¯ç”±order
     *
     * @param definitions è·¯ç”±è¯¦æƒ…é›†åˆ
     */
    private void fillTargetRouteOrder(List<RouteDefinition> definitions) {
        int order = 1;
        for (RouteDefinition route : definitions) {
            if (route.getOrder() == 0) {
                route.setOrder(order++);
            }
        }
    }

    /**
     * å‘å¸ƒè·¯ç”±å·²æ›´æ–°æ¶ˆæ¯
     */
    private void publishRouteChangedEvent() {
        this.publisher.publishEvent(new RefreshRoutesEvent(this));
    }

    /**
     * æ·»åŠ routes
     *
     * @param definitions ç›®æ ‡routes
     * @param aliveRouteMap å½“å‰å­˜æ´»è·¯ç”±map
     */
    private void createDefinitions(List<RouteDefinition> definitions, Map<String, RouteDefinition> aliveRouteMap) {
        // è·å–æ–°æ·»åŠ çš„definitions
        Set<String> aliveRouteIdSet = aliveRouteMap.keySet();
        List<RouteDefinition> needCreateDefs =
                definitions
                        .stream()
                        .filter(route -> !aliveRouteIdSet.contains(route.getId()))  // ä¸å­˜åœ¨ä¸å½“å‰å­˜æ´»é›†åˆ
                        .collect(Collectors.toList());
        doCreateDefinitions(needCreateDefs);
    }

    /**
     * æ‰§è¡Œæ·»åŠ è·¯ç”±
     *
     * @param needCreateDefs éœ€è¦æ–°å¢çš„è·¯ç”±é›†åˆ
     */
    private void doCreateDefinitions(List<RouteDefinition> needCreateDefs) {
        needCreateDefs.forEach(createDef -> {
            try {
                this.routeDefinitionRepository.save(Mono.just(createDef)).subscribe();
                log.info("created route: {}", createDef.getId());
            } catch (Exception e) {
                e.printStackTrace();
                log.info("create route {} fail", createDef.getId());
            }
        });
    }

    /**
     * æ›´æ–°è·¯ç”±
     *
     * @param definitions ç›®æ ‡routes
     * @param aliveRouteMap å½“å‰å­˜æ´»è·¯ç”±map
     */
    private void updateDefinitions(List<RouteDefinition> definitions, Map<String, RouteDefinition> aliveRouteMap) {
        Set<String> aliveRouteIdSet = aliveRouteMap.keySet();
        List<RouteDefinition> needUpdateDefs =
                definitions
                        .stream()
                        .filter(route -> aliveRouteIdSet.contains(route.getId())
                                && !route.equals(aliveRouteMap.get(route.getId())))  // å½“å‰å­˜æ´»ä¸”ä¸å½“å‰definitionä¸åŒåˆ™ä¸ºæ›´æ–°
                        .collect(Collectors.toList());
        doUpdateDefinitions(needUpdateDefs);
    }

    /**
     * åˆ é™¤å¹¶é‡æ–°åˆ›å»ºè·¯ç”±å®ç°æ›´æ–°
     *
     * route repoæ— updaterçš„ç»“å±€æ–¹æ³•
     * @param needUpdateDefs éœ€è¦æ›´æ–°routeé›†åˆ
     */
    private void doUpdateDefinitions(List<RouteDefinition> needUpdateDefs) {
        needUpdateDefs.forEach(updateDefinition -> {
            try {
                this.routeDefinitionRepository
                        .delete(Mono.just(updateDefinition.getId()))
                        .subscribe();
                log.info("removed old route(will be recreate): {}", updateDefinition.getId());
            } catch (Exception e) {
                e.printStackTrace();
                log.info("can't clean route(will be create): {}", updateDefinition.getId());
            }
            try {
                this.routeDefinitionRepository.save(Mono.just(updateDefinition)).subscribe();
                log.info("updated route: {}", updateDefinition.getId());
            } catch (Exception e) {
                e.printStackTrace();
                log.info("updated route {} fail", updateDefinition.getId());
            }
        });
    }

    /**
     * è·å–å½“å‰å­˜æ´»çš„è·¯ç”±æè¿°map
     *
     * @return å½“å‰å­˜æ´»çš„è·¯ç”±æè¿°map
     */
    private Map<String, RouteDefinition> getAliveRouteMap() {
        return routeDefinitionRepository
                .getRouteDefinitions()
                .toStream()
                .collect(Collectors.toMap(RouteDefinition::getId, Function.identity()));
    }

    /**
     * åˆ é™¤å‰”é™¤çš„routes
     *
     * @param targetDefIds ç›®æ ‡route idé›†åˆ
     * @param aliveRouteMap å½“å‰å­˜æ´»çš„è·¯ç”±map
     */
    private void removeDefinitions(List<String> targetDefIds, Map<String, RouteDefinition> aliveRouteMap) {
        List<String> removedDefinitionIds =
                aliveRouteMap
                        .keySet()
                        .stream()
                        .filter(routeId -> !targetDefIds.contains(routeId)) // ä¸å­˜åœ¨äºç›®æ ‡idé›†åˆåˆ¤å®šä¸ºåˆ é™¤
                        .collect(Collectors.toList());
        doRemoveDefinitions(removedDefinitionIds);
    }

    /**
     * åˆ é™¤å‰”é™¤çš„routes
     *
     * @param removedDefinitionIds éœ€è¦è¢«å‰”é™¤çš„route idé›†åˆ
     */
    private void doRemoveDefinitions(List<String> removedDefinitionIds) {
        removedDefinitionIds.forEach(removedId -> {
            this.routeDefinitionRepository
                    .delete(Mono.just(removedId))
                    .subscribe();
            log.info("removed route: {}", removedId);
        });
    }


    /**
     * å¼€å¯ç›‘å¬
     *
     * @param applicationEventPublisher publisher instance
     */
    @Override
    public void setApplicationEventPublisher(ApplicationEventPublisher applicationEventPublisher) {
        this.publisher = applicationEventPublisher;
    }
}
```
