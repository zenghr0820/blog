---
title: "SpringCloud Gateway"
date: "2021-07-29 18:00"
permalink: "2021-07-29-spring-cloud-gateway"

---

# SpringCloud Gatewayæ•™ç¨‹

:::tip

æœ¬ç« èŠ‚è®°å½•ä¸€ä¸‹ SpringCloud ä¸‹çš„å¾®æœåŠ¡ç½‘å…³ **Gateway** çš„å…¥é—¨æ•™ç¨‹ï¼Œç‰ˆæœ¬ç¯å¢ƒå¦‚ä¸‹ğŸ‘‡

***SpringBootï¼š2.5.3***

***SpringCloudï¼š`2020.0.3`***

***SpringCloudAlibabaï¼š2021.1***

***nacosï¼š14.1***

***Gatewayï¼š`3.0.3`***

:::

## Gateway ç®€ä»‹

Spring Cloud Gateway æ˜¯ Spring Cloud çš„ä¸€ä¸ªå…¨æ–°é¡¹ç›®ï¼Œè¯¥é¡¹ç›®æ˜¯åŸºäº Spring 5.0ï¼ŒSpring Boot 2.0 å’Œ Project Reactor ç­‰æŠ€æœ¯å¼€å‘çš„ç½‘å…³ï¼Œå®ƒæ—¨åœ¨ä¸ºå¾®æœåŠ¡æ¶æ„æä¾›ä¸€ç§ç®€å•æœ‰æ•ˆçš„ç»Ÿä¸€çš„ API è·¯ç”±ç®¡ç†æ–¹å¼ã€‚

ç½‘å…³ä½œä¸ºæµé‡çš„å…¥å£ï¼Œå¸¸ç”¨åŠŸèƒ½åŒ…æ‹¬è·¯ç”±è½¬å‘ã€æƒé™æ ¡éªŒã€é™æµæ§åˆ¶ç­‰ã€‚è€Œ springcloud gateway ä½œä¸º SpringCloud å®˜æ–¹æ¨å‡ºçš„ç¬¬äºŒä»£ç½‘å…³æ¡†æ¶ï¼Œå–ä»£äº† Zuul ç½‘å…³

> å£°æ˜ï¼š**Spring Cloud Gateway åº•å±‚ä½¿ç”¨äº†é«˜æ€§èƒ½çš„é€šä¿¡æ¡†æ¶Netty**
>
> å®˜æ–¹ç½‘å€ï¼š[https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/](https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/)

## æ ¸å¿ƒæ¦‚å¿µ

- **Routeï¼ˆè·¯ç”±ï¼‰ï¼š** è¿™æ˜¯ç½‘å…³çš„åŸºæœ¬æ„å»ºå—ã€‚å®ƒç”±ä¸€ä¸ª IDï¼Œä¸€ä¸ªç›®æ ‡ URIï¼Œä¸€ç»„æ–­è¨€å’Œä¸€ç»„è¿‡æ»¤å™¨å®šä¹‰ã€‚å¦‚æœæ–­è¨€ä¸ºçœŸï¼Œåˆ™è·¯ç”±åŒ¹é…
- **Predicateï¼ˆæ–­è¨€ï¼‰ï¼š** Java8 ä¸­çš„æ–­è¨€å‡½æ•°ã€‚Spring Cloud Gateway ä¸­çš„æ–­è¨€å‡½æ•°è¾“å…¥ç±»å‹æ˜¯ Spring5.0 æ¡† æ¶ä¸­çš„ ServerWebExchangeã€‚Spring Cloud Gateway ä¸­çš„æ–­è¨€å‡½æ•°å…è®¸å¼€å‘è€…å»å®šä¹‰åŒ¹é… æ¥è‡ªäº http request ä¸­çš„ä»»ä½•ä¿¡æ¯ï¼Œæ¯”å¦‚è¯·æ±‚å¤´å’Œå‚æ•°ç­‰
- **Filterï¼ˆè¿‡æ»¤å™¨ï¼‰ï¼š** ä¸€ä¸ªæ ‡å‡†çš„ Spring webFilterã€‚Spring cloud gateway ä¸­çš„ filter åˆ†ä¸ºä¸¤ç§ç±»å‹çš„ Filterï¼Œåˆ†åˆ«æ˜¯ **`Gateway Filter`** å’Œ **`Global Filter`**ã€‚è¿‡æ»¤å™¨ Filter å°†ä¼šå¯¹è¯·æ±‚å’Œå“åº”è¿›è¡Œä¿®æ”¹ å¤„ç†

**å·¥ä½œåŸç†å¦‚ä¸‹å›¾ğŸ‘‡**

![21UTs0](https://media.zenghr.cn/blog/img/20210729/21UTs0.png)

å®¢æˆ·ç«¯å‘ Spring Cloud Gateway å‘å‡ºè¯·æ±‚ã€‚ç„¶ååœ¨ **Gateway Handler Mapping** ä¸­æ‰¾åˆ°ä¸è¯·æ±‚ç›¸åŒ¹é…çš„è·¯ç”±ï¼Œå°†å…¶å‘é€åˆ° Gateway Web Handler

Handler å†å°†è¯·æ±‚äº¤ç»™ä¸€ä¸ªè¿‡æ»¤å™¨é“¾ï¼Œè¯·æ±‚åˆ°è¾¾ç›®æ ‡æœåŠ¡ä¹‹å‰ï¼Œä¼šæ‰§è¡Œæ‰€æœ‰è¿‡æ»¤å™¨çš„ **pre** æ–¹æ³•ã€‚è¯·æ±‚åˆ°è¾¾ç›®æ ‡æœåŠ¡å¤„ç†ä¹‹åå†ä¾æ¬¡æ‰§è¡Œæ‰€æœ‰è¿‡æ»¤å™¨çš„ **post** æ–¹æ³•

> æ€»ä¹‹å°±æ˜¯ï¼š**æ»¡è¶³æŸäº›æ–­è¨€(predicates)å°±è·¯ç”±åˆ°æŒ‡å®šçš„åœ°å€(uri)ï¼Œä½¿ç”¨æŒ‡å®šçš„è¿‡æ»¤å™¨(filter)**

## æ­å»º Gateway ç¯å¢ƒ

è¦ä½¿ç”¨ SpringCloud Gateway éœ€è¦å¯¼å…¥ç›¸åº”çš„ä¾èµ–ï¼Œä¹‹åéœ€è¦è®¾ç½® **Gateway çš„è·¯ç”±é…ç½®**

æˆ‘ä½¿ç”¨äº†**`spring-boot 2.5.3`** ä½œä¸º parent ä¾èµ–

```xml
<parent>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-parent</artifactId>
    <version>2.5.3</version>
    <relativePath/> <!-- lookup parent from repository -->
</parent>
```

åœ¨ dependencyManagement ä¸­ï¼Œ**æˆ‘ä»¬éœ€è¦æŒ‡å®š SringCloud çš„ç‰ˆæœ¬**ï¼Œä»¥ä¾¿ä¿è¯æˆ‘ä»¬èƒ½å¤Ÿå¼•å…¥æˆ‘ä»¬æƒ³è¦çš„ SpringCloud Gatewayç‰ˆæœ¬ï¼Œæ‰€ä»¥éœ€è¦ç”¨åˆ° **dependencyManagement**

```xml
<properties>
    <spring-cloud.version>2020.0.3</spring-cloud.version>
</properties>
<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-dependencies</artifactId>
            <version>${spring-cloud.version}</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>
```

æœ€åå¯¼å…¥æˆ‘ä»¬çš„ Gateway ä¾èµ–

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-gateway</artifactId>
</dependency>
```

> æ­¤å¤–ï¼Œè¯·æ£€æŸ¥ä¸€ä¸‹ä½ çš„ä¾èµ–ä¸­æ˜¯å¦å«æœ‰ **spring-boot-starter-web**ï¼Œå¦‚æœæœ‰ï¼Œ**è¯·å¹²æ‰å®ƒ**ã€‚å› ä¸ºæˆ‘ä»¬çš„SpringCloud Gatewayæ˜¯ä¸€ä¸ª**netty+webflux** å®ç°çš„webæœåŠ¡å™¨ï¼Œå’Œ Springboot Web æœ¬èº«å°±æ˜¯å†²çªçš„

## åŸºç¡€ URI è·¯ç”±é…ç½®æ–¹å¼

å¦‚æœè¯·æ±‚çš„ç›®æ ‡åœ°å€ï¼Œæ˜¯å•ä¸ªçš„URIèµ„æºè·¯å¾„ï¼Œé…ç½®æ–‡ä»¶ç¤ºä¾‹å¦‚ä¸‹ï¼š

```yaml
server:
  port: 88
spring:
  application:
    name: api-gateway
  cloud:
    gateway:
      routes:
        -id: url-proxy-1
         uri: https://blog.zenghr.cn
         predicates:
           - Path=/blog
```

å‚æ•°è¯´æ˜ï¼š

- **idï¼š** æˆ‘ä»¬è‡ªå®šä¹‰çš„è·¯ç”± IDï¼Œä¿æŒå”¯ä¸€
- **uriï¼š** ç›®æ ‡æœåŠ¡åœ°å€
- **predicatesï¼š** è·¯ç”±æ¡ä»¶ï¼ŒPredicate æ¥å—ä¸€ä¸ªè¾“å…¥å‚æ•°ï¼Œè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ç»“æœ

ä¸Šé¢è¿™æ®µé…ç½®çš„æ„æ€æ˜¯ï¼Œé…ç½®äº†ä¸€ä¸ª id ä¸º **url-proxy-1** çš„URIä»£ç†è§„åˆ™ï¼Œè·¯ç”±çš„è§„åˆ™ä¸ºï¼š

å½“è®¿é—®åœ°å€ **`http://localhost:88/blog/1.html`** æ—¶ï¼Œä¼šè·¯ç”±åˆ°ä¸Šæ¸¸åœ°å€ **`https://blog.zenghr.cn/blog/1.html`**

## åŸºäºä»£ç çš„è·¯ç”±é…ç½®æ–¹å¼

è½¬å‘åŠŸèƒ½ä»£ç ä¹Ÿå¯ä»¥é€šè¿‡ä»£ç çš„æ–¹å¼æ¥å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ **`RouteLocator`** Bean å®ç°è‡ªå®šä¹‰åˆ¶è½¬å‘è§„åˆ™

```java
@Configuration
public class GatewayConfiguration {
    @Bean
    public RouteLocator customRouteLocator(RouteLocatorBuilder builder) {
        return builder.routes()
                .route("url-proxy-1",
                        p -> p.predicate(e -> e.getRequest().getURI().getPath().startsWith("/blog"))
                                .filters(f -> f.rewritePath("/blog/(?<remaining>.*)", "/${remaining}"))
                                .uri("https://blog.zenghr.cn"))
                .route("url-proxy-2", p -> p.path("/blog2").uri("https://blog.zenghr.cn"))
                .build();
    }
}
```

æˆ‘ä»¬æ³¨é‡Šæ‰ xml é…ç½®æ–‡ä»¶ä¸­çš„ Gateway è·¯ç”±è®¾ç½®ï¼Œé‡å¯æœåŠ¡ï¼Œ å½“è®¿é—®åœ°å€ **`http://localhost:88/blog/1.html`** æ—¶ï¼Œä¼šè·¯ç”±åˆ°ä¸Šæ¸¸åœ°å€ **`https://blog.zenghr.cn/1.html`** , èƒ½å¤Ÿè®¿é—®è¯´æ˜æˆ‘ä»¬çš„ä»£ç é…ç½®æˆåŠŸ

**å‚æ•°è¯´æ˜**

é€šè¿‡ **RouteLocatorBuilder** çš„routesï¼Œå¯ä»¥é€ä¸€å»ºç«‹è·¯ç”±ï¼Œæ¯è°ƒç”¨routeä¸€æ¬¡å¯å»ºç«‹ä¸€æ¡è·¯ç”±è§„åˆ™

p çš„ä»£è¡¨æ˜¯ PredicateSpecï¼Œå¯ä»¥é€è¿‡å®ƒçš„ **predicate** æ¥è¿›è¡Œæ–­è¨€ï¼Œè¦å®ç°çš„æ¥å£å°±æ˜¯Java 8çš„ **Predicate**ï¼Œé€šè¿‡ exchange å–å¾—äº†è·¯å¾„ï¼Œç„¶ååˆ¤æ–­å®ƒæ˜¯ä¸æ˜¯ä»¥ /blog å¼€å¤´ï¼Œå¯¹äºç®€å•çš„æƒ…å†µï¼Œä¹Ÿå¯ä»¥é€šè¿‡ **path** ç­‰æ¥è¿›è¡Œæ–­è¨€

**filters** æ˜¯ç”¨æ¥è®¾ç½®è¿‡æ»¤å™¨ï¼Œ**rewritePath** æ–¹æ³•ä¼šä½¿ç”¨å†…å»ºçš„è¿‡æ»¤å™¨é‡å†™è·¯å¾„



## æ³¨å†Œä¸­å¿ƒç›¸ç»“åˆçš„è·¯ç”±é…ç½®æ–¹å¼

åœ¨ uri çš„ schema åè®®éƒ¨åˆ†ä¸ºè‡ªå®šä¹‰çš„ **lb:ç±»å‹**ï¼Œè¡¨ç¤ºä»å¾®æœåŠ¡æ³¨å†Œä¸­å¿ƒï¼ˆå¦‚ Nacosï¼‰è®¢é˜…æœåŠ¡ï¼Œå¹¶ä¸”è¿›è¡ŒæœåŠ¡çš„è·¯ç”±

> åœ¨æˆ‘çš„é¡¹ç›®ä¸­ï¼Œä½¿ç”¨çš„æ˜¯ **gateway + nacos** çš„æ–¹å¼æ¥å®ç°çš„

å¯¼å…¥ nacos çš„æœåŠ¡æ³¨å†Œä¾èµ–ï¼Œéœ€è¦æŠŠ gateway æœåŠ¡æ³¨å†Œåˆ° nacosï¼Œæ‰èƒ½å‘ç°å…¶ä»–æœåŠ¡

```xml
<!-- nacos æœåŠ¡å‘ç° -->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
<!-- nacos é…ç½®ä¸­å¿ƒ -->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
</dependency>
```

å¦‚æœéœ€è¦ä½¿ç”¨ nacos ä½œä¸ºé…ç½®ä¸­å¿ƒï¼Œä¹Ÿå¯ä»¥å¯¼å…¥ç›¸åº”çš„ä¾èµ–

æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶å†…å®¹éœ€è¦å¦‚ä¸‹è®¾ç½®ğŸ‘‡

```yaml
spring:
  application:
    name: api-gateway
  cloud:
    nacos:
      discovery:
        server-addr: 127.0.0.1:8848
    gateway:
      discovery:
        locator:
          enabled: true # å¼€å¯æœåŠ¡å‘ç°åŠŸèƒ½ï¼Œé»˜è®¤ä¸º false
      routes:
        - id: member_route
          uri: lb://mall-member
          predicates:
            - Path=/api/member/**
          filters:
            - RewritePath=/api/member/(?<segment>.*),/$\{segment}
```

**å‚æ•°è¯´æ˜**

- **locator.enabledï¼š** å¼€å¯æœåŠ¡å‘ç°ï¼Œéœ€è¦å¼€å¯è¯¥é…ç½®
- **lb:** ä»£è¡¨ è´Ÿè½½å‡è¡¡

::: warning

ç”±äº **SpringCloud 2020** å¼ƒç”¨äº† Ribbonï¼Œå› æ­¤ Alibaba åœ¨ **`2021 ç‰ˆæœ¬ nacos`** ä¸­åˆ é™¤äº† Ribbo nçš„ jar åŒ…ï¼Œå› æ­¤æ— æ³•é€šè¿‡**lbè·¯ç”±åˆ°æŒ‡å®šå¾®æœåŠ¡ï¼Œå‡ºç°äº†503æƒ…å†µ**

æ‰€ä»¥åªéœ€è¦å¼•å…¥ **springcloud loadbalancer** åŒ…å³å¯

:::

```xml
<!--å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡loadbalancer-->
<dependency>
	<groupId>org.springframework.cloud</groupId>
	<artifactId>spring-cloud-starter-loadbalancer</artifactId>
</dependency>
```

## Gateway åŒ¹é…è§„åˆ™

Spring Cloud Gateway æ˜¯é€šè¿‡ Spring WebFlux çš„ HandlerMapping åšä¸ºåº•å±‚æ”¯æŒæ¥åŒ¹é…åˆ°è½¬å‘è·¯ç”±ï¼ŒSpring Cloud Gateway å†…ç½®äº†å¾ˆå¤š Predicates å·¥å‚ï¼Œè¿™äº› Predicates å·¥å‚é€šè¿‡ä¸åŒçš„ HTTP è¯·æ±‚å‚æ•°æ¥åŒ¹é…ï¼Œå¤šä¸ª Predicates å·¥å‚å¯ä»¥ç»„åˆä½¿ç”¨

![U3Me4V](https://media.zenghr.cn/blog/img/20210729/U3Me4V.png)

æ¥ä¸‹æ¥æˆ‘ä»¬ä»‹ç» Spring Cloud GateWay å†…ç½®å‡ ç§ Predicate çš„ä½¿ç”¨

### é€šè¿‡è¯·æ±‚å‚æ•°åŒ¹é…

Query Route Predicate æ”¯æŒä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å±æ€§åä¸€ä¸ªä¸ºå±æ€§å€¼ï¼Œå±æ€§å€¼å¯ä»¥æ˜¯æ­£åˆ™è¡¨è¾¾å¼

```yaml
server:
  port: 88
spring:
  application:
    name: api-gateway
  cloud:
    gateway:
      routes:
        -id: url-proxy-1
         uri: https://blog.zenghr.cn
         predicates:
           - Query=url,blog
```

è¿™æ ·é…ç½®ï¼Œåªè¦è¯·æ±‚ä¸­åŒ…å« url å±æ€§çš„å‚æ•°ï¼Œå¹¶ä¸”å‚æ•°å€¼æ˜¯ blog å³å¯åŒ¹é…è·¯ç”±

### é€šè¿‡ Cookie åŒ¹é…

Cookie Route Predicate å¯ä»¥æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯ Cookie name ,ä¸€ä¸ªæ˜¯æ­£åˆ™è¡¨è¾¾å¼ï¼Œè·¯ç”±è§„åˆ™ä¼šé€šè¿‡è·å–å¯¹åº”çš„ Cookie name å€¼å’Œæ­£åˆ™è¡¨è¾¾å¼å»åŒ¹é…ï¼Œå¦‚æœåŒ¹é…ä¸Šå°±ä¼šæ‰§è¡Œè·¯ç”±ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…ä¸Šåˆ™ä¸æ‰§è¡Œ

```yaml
server:
  port: 88
spring:
  application:
    name: api-gateway
  cloud:
    gateway:
      routes:
        -id: url-proxy-1
         uri: https://blog.zenghr.cn
         order: 0
         predicates:
           - Cookie=sessionId, test
```

### é€šè¿‡ Header å±æ€§åŒ¹é…

Header Route Predicate å’Œ Cookie Route Predicate ä¸€æ ·ï¼Œä¹Ÿæ˜¯æ¥æ”¶ 2 ä¸ªå‚æ•°ï¼Œä¸€ä¸ª header ä¸­å±æ€§åç§°å’Œä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œè¿™ä¸ªå±æ€§å€¼å’Œæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…åˆ™æ‰§è¡Œ

```yaml
server:
  port: 88
spring:
  application:
    name: api-gateway
  cloud:
    gateway:
      routes:
        -id: url-proxy-1
         uri: https://blog.zenghr.cn
         order: 0
         predicates:
           - Header=X-Request-Id, \d+
```

### é€šè¿‡è¯·æ±‚æ–¹å¼åŒ¹é…

å¯ä»¥é€šè¿‡æ˜¯ POSTã€GETã€PUTã€DELETE ç­‰ä¸åŒçš„è¯·æ±‚æ–¹å¼æ¥è¿›è¡Œè·¯ç”±

```yaml
server:
  port: 88
spring:
  application:
    name: api-gateway
  cloud:
    gateway:
      routes:
        -id: url-proxy-1
         uri: https://blog.zenghr.cn
         order: 0
         predicates:
           - Method=GET
```

> è¿™é‡Œæˆ‘ä»¬å°±åªåˆ—å‡ºä¸€äº›å¸¸ç”¨çš„åŒ¹é…æ–¹å¼ï¼Œå¦‚æœéœ€è¦æŸ¥è¯¢å…¶ä»–åŒ¹é…æ–¹å¼ï¼Œå¯ä»¥æŸ¥çœ‹ [SpringCloud Gateway](https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gateway-request-predicates-factories) çš„å®˜æ–¹æ–‡æ¡£

## Gateway é«˜çº§åŠŸèƒ½

### å®ç°ç†”æ–­é™çº§<Badge text="TODO"/>



### åˆ†å¸ƒå¼é™æµ<Badge text="TODO"/>

