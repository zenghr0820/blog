---
title: "æœåŠ¡å‘ç° Nacos"
date: "2021-07-27 20:11"
permalink: "2021-07-27-spring-cloud-alibaba-nacos"
---

# æœåŠ¡å‘ç° Nacos

**Nacos** æ˜¯é˜¿é‡Œå·´å·´å¼€æºçš„ä¸€ä¸ªæ›´æ˜“äºæ„å»ºäº‘åŸç”Ÿåº”ç”¨çš„åŠ¨æ€æœåŠ¡å‘ç°ã€é…ç½®ç®¡ç†å’ŒæœåŠ¡ç®¡ç† å¹³å°

**å‚è€ƒæ–‡æ¡£å¦‚ä¸‹ğŸ‘‡**

> Nacos å®˜ç½‘æ–‡æ¡£åœ°å€ï¼š[https://nacos.io/zh-cn/docs/what-is-nacos.html](https://nacos.io/zh-cn/docs/what-is-nacos.html)
>
> Nacos Spring Cloud å¿«é€Ÿå¼€å§‹ï¼š[https://nacos.io/zh-cn/docs/quick-start-spring-cloud.html](https://nacos.io/zh-cn/docs/quick-start-spring-cloud.html)

## Nacos æ­å»º

æ ¹æ® Nacos å®˜ç½‘çš„ç‰ˆæœ¬é€‰æ‹©æè¿°ä¸­ï¼Œå¯ä»¥æ ¹æ® [releases](https://github.com/alibaba/nacos/releases) ä¸­æ‰¾åˆ°æ¯ä¸ªç‰ˆæœ¬çš„ä»‹ç»ï¼ŒSpring Cloud ç‰ˆæœ¬å¯¹åº”å…³ç³»å¯ä»¥æŸ¥çœ‹ [ç‰ˆæœ¬è¯´æ˜Wiki](https://github.com/alibaba/spring-cloud-alibaba/wiki/%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E)

### è·å– Nacos

- ä¸‹è½½åœ°å€ï¼š[https://github.com/alibaba/nacos/releases](https://github.com/alibaba/nacos/releases)
- æ­å»ºæ–‡æ¡£ï¼š[https://nacos.io/zh-cn/docs/quick-start.html](https://nacos.io/zh-cn/docs/quick-start.html)

### å¯åŠ¨ã€å…³é—­æœåŠ¡

**Linux/Unix/Mac**

```sh
# Linux/Unix/Mac
# å¯åŠ¨å‘½ä»¤(standaloneä»£è¡¨ç€å•æœºæ¨¡å¼è¿è¡Œï¼Œéé›†ç¾¤æ¨¡å¼):
sh startup.sh -m standalone
sh shutdown.sh
```

**Window**

```sh
# å¯åŠ¨å‘½ä»¤(standaloneä»£è¡¨ç€å•æœºæ¨¡å¼è¿è¡Œï¼Œéé›†ç¾¤æ¨¡å¼):
startup.cmd -m standalone
shutdown.cmd
```

### è®¿é—® Nacos åå°ç•Œé¢

å½“æˆ‘ä»¬çš„ Nacos è¿è¡Œèµ·æ¥æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è®¿é—® [http://127.0.0.1:8848/nacos](http://127.0.0.1:8848/nacos) åœ°å€ï¼Œè¾“å…¥è´¦å·å¯†ç ï¼š**`nacos`** ç™»å½•ç³»ç»Ÿ

![XOjON2](https://media.zenghr.cn/blog/img/20210727/XOjON2.png)

![ZoWv68](https://media.zenghr.cn/blog/img/20210727/ZoWv68.png)

## ç¯å¢ƒè¯´æ˜

:::tip

**Spring Cloudï¼š** 2020.0.3

**Nacosï¼š** 14.2

**spring-cloud-alibabaï¼š** 2021.1

:::

å…³äº Nacos Spring Cloud çš„è¯¦ç»†æ–‡æ¡£è¯·å‚çœ‹ï¼š[Nacos Config](https://github.com/spring-cloud-incubator/spring-cloud-alibaba/wiki/Nacos-config) å’Œ [Nacos Discovery](https://github.com/spring-cloud-incubator/spring-cloud-alibaba/wiki/Nacos-discovery)ã€‚

- é€šè¿‡ Nacos Server å’Œ spring-cloud-starter-alibaba-nacos-config å®ç°é…ç½®çš„åŠ¨æ€å˜æ›´ã€‚
- é€šè¿‡ Nacos Server å’Œ spring-cloud-starter-alibaba-nacos-discovery å®ç°æœåŠ¡çš„æ³¨å†Œä¸å‘ç°ã€‚

## æœåŠ¡å‘ç°æ˜¯ä»€ä¹ˆ

### æœåŠ¡æä¾›è€…ä¸æœåŠ¡æ¶ˆè´¹è€…

- æœåŠ¡æä¾›è€…ï¼šæœåŠ¡çš„è¢«è°ƒç”¨æ–¹ï¼ˆå³ï¼šä¸ºå…¶ä»–å¾®æœåŠ¡æä¾›æ¥å£çš„å¾®æœåŠ¡ï¼‰
- æœåŠ¡æ¶ˆè´¹è€…ï¼šæœåŠ¡çš„è°ƒç”¨æ–¹ï¼ˆå³ï¼šè°ƒç”¨å…¶ä»–å¾®æœåŠ¡æ¥å£çš„å¾®æœåŠ¡ï¼‰

### æœåŠ¡å‘ç°åŸç†

- æœåŠ¡å‘ç°æœºåˆ¶å°±æ˜¯é€šè¿‡ä¸€ä¸ªä¸­é—´ä»¶å»è®°å½•æœåŠ¡æä¾›è€…çš„ipåœ°å€ï¼ŒæœåŠ¡åä»¥åŠå¿ƒè·³ç­‰æ•°æ®ï¼ˆæ¯”å¦‚ç”¨mysqlå»å­˜å‚¨è¿™äº›ä¿¡æ¯ï¼‰ï¼Œç„¶åæœåŠ¡æ¶ˆè´¹è€…ä¼šå»è¿™ä¸ªä¸­é—´å¹³å°å»æŸ¥è¯¢ç›¸å…³ä¿¡æ¯ï¼Œç„¶åå†å»è®¿é—®å¯¹åº”çš„åœ°å€ï¼Œè¿™å°±æ˜¯æœåŠ¡æ³¨å†Œå’ŒæœåŠ¡å‘ç°ã€‚
- å½“ç”¨æˆ·åœ°å€å‘ç”Ÿäº†å˜åŒ–ä¹Ÿæ²¡æœ‰å½±å“ï¼Œå› ä¸ºæœåŠ¡æä¾›æ–¹ä¿®æ”¹äº†ç”¨æˆ·åœ°å€ï¼Œåœ¨ä¸­é—´ä»¶ä¸­ä¼šè¢«æ›´æ–°ï¼Œå½“æœåŠ¡æ¶ˆè´¹æ–¹å»è®¿é—®ä¸­é—´ä»¶æ—¶å°±èƒ½åŠæ—¶è·å–æœ€æ–°çš„ç”¨æˆ·åœ°å€ï¼Œå°±ä¸ä¼šå‡ºç°ç”¨æˆ·åœ°å€å‘ç”Ÿå˜åŒ–å¯¼è‡´æœåŠ¡æ‰¾ä¸åˆ°

## å¯åŠ¨æœåŠ¡å‘ç°

æˆ‘ä»¬é€šè¿‡ spring-cloud-starter-alibaba-nacos-discovery æ¥å®ç°æœåŠ¡æ³¨å†Œå’Œå‘ç°

::: warning

æ³¨æ„ï¼šå¦‚æœä½ çš„ Spring Cloud ç‰ˆæœ¬æ˜¯ 2020ï¼Œé‚£ä¹ˆ é…ç½®æ–‡ä»¶ **bootstrap.yml** å°†ä¼šä¸èµ·ä½œç”¨ï¼Œä¼šå¯¼è‡´ nacos çš„é…ç½®ç®¡ç†ã€æœåŠ¡å‘ç°ç­‰é…ç½®å¤±æ•ˆï¼Œéœ€è¦æ·»åŠ ä¾èµ–ï¼Œè¯¦ç»†æ–¹æ¡ˆè¯·çœ‹ [Spring Cloud è¶Ÿå‘è®°å½•](/passages/2021-07-27-spring-cloud-error.html#spring-cloud-2020-bootstrap-é…ç½®æ–‡ä»¶å¤±æ•ˆ)

:::

### æ·»åŠ ä¾èµ–

```xml
<!-- nacos æœåŠ¡å‘ç° -->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
```

> æ›´å¤šç‰ˆæœ¬å¯¹åº”å…³ç³»å‚è€ƒï¼š[ç‰ˆæœ¬è¯´æ˜ Wiki](https://github.com/spring-cloud-incubator/spring-cloud-alibaba/wiki/ç‰ˆæœ¬è¯´æ˜)

### æ·»åŠ é…ç½®

é€šè¿‡ Nacos çš„æœåŠ¡æ³¨å†Œå‘ç°åŠŸèƒ½å°†å…¶æœåŠ¡æ³¨å†Œåˆ° Nacos server ä¸Š

**åœ¨ `bootstrap.yml` ä¸­é…ç½® Nacos server çš„åœ°å€**

```yaml
spring:
  cloud:
    nacos:
      discovery:
        server-addr: 127.0.0.1:8848
  application:
    name: mall-order
```

> æ³¨æ„ï¼šéœ€è¦é…ç½® application.name å±æ€§ï¼Œå› ä¸º Nacos æ³¨å†ŒæœåŠ¡é»˜è®¤å– **${spring.application.name}** çš„å€¼

### æ·»åŠ æ³¨è§£

**æ—©æœŸåœ¨å¯åŠ¨ç±»ä¸Šéœ€è¦åŠ ä¸Š @EnableDiscoveryClientæ³¨è§£ï¼Œç°åœ¨å·²ç»å¯ä»¥ä¸éœ€è¦åŠ äº†**

![Hpj6v9](https://media.zenghr.cn/blog/img/20210727/Hpj6v9.png)

## å¯åŠ¨é…ç½®ç®¡ç†

æˆ‘ä»¬é€šè¿‡ Nacos Server å’Œ **spring-cloud-starter-alibaba-nacos-config** å®ç°é…ç½®çš„åŠ¨æ€å˜æ›´

### æ·»åŠ ä¾èµ–

```xml
<!-- nacos é…ç½®ä¸­å¿ƒ -->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
</dependency>
```

> æ›´å¤šç‰ˆæœ¬å¯¹åº”å…³ç³»å‚è€ƒï¼š[ç‰ˆæœ¬è¯´æ˜ Wiki](https://github.com/spring-cloud-incubator/spring-cloud-alibaba/wiki/ç‰ˆæœ¬è¯´æ˜)

### æ·»åŠ é…ç½®

**åœ¨ `bootstrap.properties` ä¸­é…ç½® Nacos server çš„åœ°å€å’Œåº”ç”¨å**

```yaml
spring:
  cloud:
    nacos:
      discovery:
        server-addr: 127.0.0.1:8848
      config:
        server-addr: 127.0.0.1:8848
        file-extension: yaml
  application:
    name: mall-order
```

:::tip

è¯´æ˜ï¼šä¹‹æ‰€ä»¥éœ€è¦é…ç½® `spring.application.name` ï¼Œæ˜¯å› ä¸ºå®ƒæ˜¯æ„æˆ Nacos é…ç½®ç®¡ç† `dataId`å­—æ®µçš„ä¸€éƒ¨åˆ†

**dataId = ${prefix}-${spring.profiles.active}.${file-extension}**

:::

- **prefixï¼š**  é»˜è®¤ä¸º `spring.application.name` çš„å€¼ï¼Œä¹Ÿå¯ä»¥é€šè¿‡é…ç½®é¡¹ `spring.cloud.nacos.config.prefix`æ¥é…ç½®ã€‚
- **spring.profiles.activeï¼š** å³ä¸ºå½“å‰ç¯å¢ƒå¯¹åº”çš„ profileï¼Œè¯¦æƒ…å¯ä»¥å‚è€ƒ [Spring Bootæ–‡æ¡£](https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-profiles.html#boot-features-profiles)ã€‚ **æ³¨æ„ï¼šå½“ spring.profiles.active ä¸ºç©ºæ—¶ï¼Œå¯¹åº”çš„è¿æ¥ç¬¦ `-` ä¹Ÿå°†ä¸å­˜åœ¨ï¼ŒdataId çš„æ‹¼æ¥æ ¼å¼å˜æˆ `${prefix}.${file-extension}`**
- **file-exetensionï¼š** ä¸ºé…ç½®å†…å®¹çš„æ•°æ®æ ¼å¼ï¼Œå¯ä»¥é€šè¿‡é…ç½®é¡¹ `spring.cloud.nacos.config.file-extension` æ¥é…ç½®ã€‚ç›®å‰åªæ”¯æŒ `properties` å’Œ `yaml` ç±»å‹ã€‚

> å³ï¼Œé‡‡ç”¨ä¸Šè¿°é…ç½®ï¼Œ`nacosconfig` ä¼šä» Nacos Server è¯»å– Data Id ä¸º `nacosconfig.yaml` çš„é…ç½®ã€‚

### Nacos æ§åˆ¶å°æ·»åŠ é…ç½®æ–‡ä»¶

åœ¨ Nacos æ§åˆ¶å°æ·»åŠ ä¸€ä¸ªæ–°çš„é…ç½®ï¼Œå…¶ä¸­ï¼š

- Data Idï¼š`nacosconfig`
- Groupï¼š`DEFAULT_GROUP`
- é…ç½®æ ¼å¼ï¼š`YAML`

![JnlTaf](https://media.zenghr.cn/blog/img/20210727/JnlTaf.png)

![hlPcGj](https://media.zenghr.cn/blog/img/20210727/hlPcGj.png)

### è¯»å– Nacos å˜é‡é…ç½®

```java
@RefreshScope
@RestController
public class ConfigController {
    private static final Logger logger = LoggerFactory.getLogger(ConfigController.class);

    @Value("${order.name:test}")
    private String name;

    @RequestMapping(value = "/config", method = RequestMethod.GET)
    public String index() {
        logger.info("get order config value from nacos: {}", name);
        return name;
    }
}
```

- **RefreshScopeï¼š** å®ç°é…ç½®è‡ªåŠ¨æ›´æ–°ï¼Œåœ¨ nacos ä¸­ä¿®æ”¹äº†é…ç½®ï¼Œä¼šåŠ¨æ€æ›´æ–°æ•°æ®

