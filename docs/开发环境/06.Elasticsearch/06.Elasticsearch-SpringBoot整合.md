---
title: "SpringBooté›†æˆElasticsearch"
date: "2021-08-18 21:00"
permalink: "2021-08-18-elasticsearch-integrate-springboot"
---

# SpringBooté›†æˆElasticsearch

SpringBooté»˜è®¤æ”¯æŒä¸¤ç§æŠ€æœ¯æ¥å’Œ ES äº¤äº’ï¼›

- Jestï¼ˆé»˜è®¤ä¸ç”Ÿæ•ˆï¼‰
  - éœ€è¦å¯¼å…¥jestçš„å·¥å…·åŒ…ï¼ˆio.searchbox.client.JestClientï¼‰
  - ä»springboot 2.2.0ä»¥åè¢«å¼ƒç”¨
- SpringData ElasticSearch

ç‰ˆæœ¬é€‚é…è¯´æ˜:

å‚è€ƒåœ°å€ï¼š[https://github.com/spring-projects/spring-data-elasticsearch/blob/main/src/main/asciidoc/preface.adoc](https://github.com/spring-projects/spring-data-elasticsearch/blob/main/src/main/asciidoc/preface.adoc)

| Spring Data Release Train | Spring Data Elasticsearch | Elasticsearch | Spring Framework | Spring Boot |
| ------------------------- | ------------------------- | ------------- | ---------------- | ----------- |
| 2021.1                    | 4.3.x                     | 7.13.4        | 5.3.x            | 2.5.x       |
| 2021.0 (Pascal)           | 4.2.x                     | 7.12.0        | 5.3.x            | 2.5.x       |
| 2020.0 (Ockham)           | 4.1.x                     | 7.9.3         | 5.3.2            | 2.4.x       |
| Neumann                   | 4.0.x                     | 7.6.2         | 5.2.12           | 2.3.x       |
| Moore                     | 3.2.x                     | 6.8.12        | 5.2.12           | 2.2.x       |
| Lovelace                  | 3.1.x                     | 6.2.2         | 5.1.19           | 2.1.x       |
| Kay                       | 3.0.x                     | 5.5.0         | 5.0.13           | 2.0.x       |
| Ingalls                   | 2.1.x                     | 2.4.0         | 4.3.25           | 1.5.x       |

## é…ç½®ç¯å¢ƒ

:::tip

å¼€å‘ç¯å¢ƒé…ç½®å¦‚ä¸‹ğŸ‘‡

:::

| æ¡†æ¶                      | ç‰ˆæœ¬   |
| ------------------------- | ------ |
| SpringBoot                | 2.5.3  |
| Elasticsearch             | 7.14.0 |
| Spring Data Elasticsearch | 4.2.3  |

## å¯¼å…¥ pom æ–‡ä»¶

æˆ‘ä»¬æƒ³è¦åœ¨ SpringBoot ä¸­é›†æˆ Elasticsearchï¼Œç¬¬ä¸€æ­¥â˜ï¸å°±æ˜¯å¯¼å…¥ç›¸åº”çš„ pom æ–‡ä»¶

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-elasticsearch</artifactId>
</dependency>
```

## é…ç½®æ–‡ä»¶

```yaml
# å…¨æ–‡æœç´¢é…ç½®
spring:
  elasticsearch:
    rest:
      uris: http://localhost:9200
```

> é»˜è®¤çš„åœ°å€å°±æ˜¯ï¼šhttp://localhost:9200 å¦‚æœä½ çš„ç«¯å£åœ°å€ä¸ä¸€è‡´æˆ–è€…ä½ è®¾ç½®äº†è´¦å·å¯†ç éªŒè¯ï¼Œéœ€è¦é…ç½®ä½ çš„ä¿¡æ¯

## å¼€å¯æ³¨è§£

```java
@EnableElasticsearchRepositories(basePackages = "xx.xxx.xxx")
```

å› ä¸ºä½¿ç”¨äº† Spring-data æ¡†æ¶ï¼Œæ‰€ä»¥éœ€è¦å¼€å¯æ³¨è§£æ‰«æ Repository ç±»

## ç¼–å†™å¯¹åº”çš„ JavaBean

å…ˆå®šä¹‰ä¸€ä¸ª JavaBean ç±»ï¼ŒæŒ‡å®šç´¢å¼•åå’Œ ~~ç±»å‹(type å³å°†åºŸç”¨)~~

> **æ³¨æ„ï¼šSpringBootå¯åŠ¨æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºæ˜ å°„ï¼Œä½†è¦æ³¨æ„å¦‚æœå·²ç»å­˜åœ¨ç›¸åŒçš„index**

```java
@Data
@Document(indexName = "strategy_es")
public class StrategyEs {
    //@Field æ¯ä¸ªæ–‡æ¡£çš„å­—æ®µé…ç½®ï¼ˆç±»å‹ã€æ˜¯å¦åˆ†è¯ã€æ˜¯å¦å­˜å‚¨ã€åˆ†è¯å™¨ ï¼‰
    @Id
    @Field(store = true, index = false, type = FieldType.Long)
    private Long id;  // æ”»ç•¥id

    @Field(analyzer = "ik_max_word", store = true, searchAnalyzer = "ik_max_word", type = FieldType.Text)
    private String title;  // æ”»ç•¥æ ‡é¢˜

    @Field(analyzer = "ik_max_word", store = true, searchAnalyzer = "ik_max_word", type = FieldType.Text)
    private String subTitle;  // æ”»ç•¥æ ‡é¢˜

    @Field(analyzer = "ik_max_word", store = true, searchAnalyzer = "ik_max_word", type = FieldType.Text)
    private String summary; // æ”»ç•¥ç®€ä»‹
}
```

### @Documnet æ³¨è§£

```java
public @interface Document {
    // ç´¢å¼•åç§°
    String indexName();
    @Deprecated
    boolean useServerConfiguration() default false;
    @Deprecated
    short shards() default 1;
    @Deprecated
    short replicas() default 1;
    @Deprecated
    String refreshInterval() default "1s";
    @Deprecated
    String indexStoreType() default "fs";
    boolean createIndex() default true;
    VersionType versionType() default VersionType.EXTERNAL;
}
```

### @Field æ³¨è§£

```java
public @interface Field {
    @AliasFor("name")
    String value() default "";
    @AliasFor("value")
    String name() default "";
	// è‡ªåŠ¨æ£€æµ‹å±æ€§çš„ç±»å‹ï¼Œå¯ä»¥æ ¹æ®å®é™…æƒ…å†µè‡ªå·±è®¾ç½®
    FieldType type() default FieldType.Auto;
	// é»˜è®¤æƒ…å†µä¸‹åˆ†è¯ï¼Œä¸€èˆ¬é»˜è®¤åˆ†è¯å°±å¥½ï¼Œé™¤éè¿™ä¸ªå­—æ®µä½ ç¡®å®šæŸ¥è¯¢æ—¶ä¸ä¼šç”¨åˆ°
    boolean index() default true;
	// æ—¶é—´æ ¼å¼åŒ–
    DateFormat[] format() default {DateFormat.date_optional_time, DateFormat.epoch_millis};
	// é»˜è®¤æƒ…å†µä¸‹ä¸å­˜å‚¨åŸæ–‡
    boolean store() default false;
	// æŒ‡å®šå­—æ®µæœç´¢æ—¶ä½¿ç”¨çš„åˆ†è¯å™¨
    String searchAnalyzer() default "";
	// æŒ‡å®šåˆ†è¯å™¨
    String analyzer() default "";
}
```

## åˆ›å»º Repository

> **æ³¨æ„ï¼š** æ²¡æœ‰è¿™ä¸€æ­¥ï¼Œå³ä¾¿åœ¨å®ä½“ä¸Šæ–¹è®¾ç½®@Documentï¼ŒSpringBoot å¯åŠ¨ä¹Ÿä¸ä¼šåˆ›å»º mapping

```java
@Repository
public interface StrategyEsRepository extends ElasticsearchRepository<StrategyEs, Long> {
}
```

æ˜ å°„ç»“æ„å¦‚ä¸‹ğŸ‘‡

```json
{
  "mappings": {
    "_doc": {
      "properties": {
        "_class": {
          "type": "keyword",
          "index": false,
          "doc_values": false
        },
        "id": {
          "type": "keyword"
        },
        "subTitle": {
          "type": "text",
          "store": true,
          "analyzer": "ik_max_word"
        },
        "summary": {
          "type": "text",
          "store": true,
          "analyzer": "ik_max_word"
        },
        "title": {
          "type": "text",
          "store": true,
          "analyzer": "ik_max_word"
        }
      }
    }
  }
}
```

## Crud æ“ä½œ

```java
public class ElasticsearchTest {
    @Autowired
    private StrategyEsRepository strategyEsRepository;
    
    @Test
    void createStrategyEsTest() {
        StrategyEs strategyEs = new StrategyEs();
        // æ·»åŠ  and ä¿®æ”¹
        strategyEsRepository.save(strategyEs);
        strategyEsRepository.deleteById(1L);
        strategyEsRepository.delete(strategyEs);
    }
}
```

## ElasticsearchRestTemplate

ESæœ‰ä¸¤ä¸ªæ¨¡æ¿ï¼Œåˆ†åˆ«ä¸º`ElasticsearchRestTemplate`å’Œ ~~`ElasticsearchTemplate`~~

åˆ†åˆ«å¯¹åº”äº**High Level REST Client**å’Œ ~~**Transport Client**(å¼ƒç”¨)~~ï¼Œä¸¤ä¸ªæ¨¡æ¿éƒ½å®ç°äº†`ElasticsearchOperations`æ¥å£ï¼Œç”±äº ElasticsearchTemplate å¼ƒç”¨ï¼Œå› æ­¤ä½¿ç”¨æ—¶æˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨ **ElasticsearchRestTemplate**

**æ³¨å…¥æ¨¡æ¿**

```java
@Autowired
private ElasticsearchRestTemplate restTemplate;
```

### Crud ç´¢å¼•

```java
@Test
void crudIndexTest() {
    // åˆ›å»ºç´¢å¼•
    restTemplate.indexOps(IndexCoordinates.of("es_test")).create();
    // ç´¢å¼•æ˜¯å¦å­˜åœ¨
    restTemplate.indexOps(indexCoordinates).exists();
    // åˆ é™¤ç´¢å¼•
    restTemplate.indexOps(indexCoordinates).delete();
}
```

