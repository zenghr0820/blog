---
title: "Activiti7 å¸¸ç”¨ Api"
date: "2021-07-22 14:50"
permalink: "2021-07-22-activiti7-common-api"
---

# Activiti7 å¸¸ç”¨ Api

:::tip

è®°å½•ä¸€ä¸‹å¸¸ç”¨çš„ Api ä½¿ç”¨

:::

## ä¸€ã€æµç¨‹å®šä¹‰ç›¸å…³ Api

> ä»¥ä¸‹ Api è·Ÿæµç¨‹å®šä¹‰ç›¸å…³

## æ ¹æ®æµç¨‹å®šä¹‰ KeyæŸ¥è¯¢æµç¨‹

```java
public ProcessDefinition selectProcessDefinitionByKey(String definitionKey) {
    List<ProcessDefinition> processDefinitions = repositoryService.createProcessDefinitionQuery()
        .processDefinitionKey(definitionKey)
        .orderByProcessDefinitionVersion()
        .desc()
        .list();

    ProcessDefinition processDefinition = null;
    if (processDefinitions.size() > 0) {
        processDefinition = processDefinitions.get(0);
    }
    return processDefinition;
}
```

**Api è¯´æ˜ï¼š**

- æ ¹æ®éƒ¨ç½²ç‰ˆæœ¬å€’åºæ’åºï¼Œè·å–æ‰€æœ‰æµç¨‹éƒ¨ç½²ä¿¡æ¯ï¼Œå–æœ€æ–°çš„æ•°æ®

## æ ¹æ®éƒ¨ç½² Id æŸ¥è¯¢æµç¨‹

```java
public ProcessDefinition selectProcessDefinitionByDeploymentId(String deploymentId) {
    return repositoryService.createProcessDefinitionQuery()
        .deploymentId(deploymentId)
        .singleResult();
}
```

## è·å–æµç¨‹ XML æ–‡ä»¶

```java
public InputStream getResourceAsStream(String deploymentId, String resourceName) {
    return repositoryService.getResourceAsStream(deploymentId, resourceName);
}
```

**å‚æ•°è¯´æ˜ï¼š** å‚æ•°éƒ½ä»æµç¨‹å®šä¹‰ä¸­è·å– processDefinition

- **deploymentId** - æµç¨‹éƒ¨ç½² ID
- **resourceName** - èµ„æºåç§°

## è·å–å½“å‰æµç¨‹çš„æµç¨‹å›¾(é«˜äº®æ˜¾ç¤º)

```java
public InputStream getProcessImage(String processDefinitionId,
                                   List<String> highLightedActivities,
                                   List<String> highLightedFlows) {
    BpmnModel model = repositoryService.getBpmnModel(processDefinitionId);
    ProcessDiagramGenerator generator = new DefaultProcessDiagramGenerator();
    //generateDiagram(æµç¨‹æ¨¡å‹,éœ€è¦é«˜äº®çš„èŠ‚ç‚¹,éœ€è¦é«˜äº®çš„çº¿æ¡,åé¢ä¸‰ä¸ªå‚æ•°éƒ½è¡¨ç¤ºæ˜¯å­—ä½“)
    InputStream inputStream = generator.generateDiagram(model, highLightedActivities, highLightedFlows, "å®‹ä½“", "å®‹ä½“", "å®‹ä½“");
    return inputStream;
}
```

**å‚æ•°è¯´æ˜ï¼š**

- **highLightedActivities** - éœ€è¦é«˜äº®çš„èŠ‚ç‚¹åˆ—è¡¨ï¼Œå­˜èŠ‚ç‚¹ ID
- **highLightedFlows** - éœ€è¦é«˜äº®çš„è¿çº¿ï¼Œå­˜è¿çº¿ ID

> å¦‚æœæµç¨‹ä¸­æœ‰ä¸­æ–‡ï¼Œéœ€è¦ä¼ å…¥èƒ½è¯†åˆ«ä¸­æ–‡çš„å­—ä½“ï¼Œä¾‹å¦‚ï¼šå®‹ä½“

## è·å–æµç¨‹ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ä¿¡æ¯

```java
public void findUserTaskNode() {
    // è·å–æµç¨‹ä¿¡æ¯ï¼Œè·å–æ–¹æ³•æŸ¥çœ‹ä¸Šé¢ğŸ‘†æå¾—åˆ°çš„ Api
    ProcessDefinition processDefinition = selectProcessDefinitionByKey("XXXKey");
    BpmnModel model = repositoryService.getBpmnModel(processDefinition.getId());
    if (model != null) {
        // è·å–æ‰€æœ‰èŠ‚ç‚¹ä¿¡æ¯
        Collection<FlowElement> flowElements = model.getMainProcess().getFlowElements();
		// æŸ¥æ‰¾æŒ‡å®š UserTask ç±»å‹çš„èŠ‚ç‚¹
        for (FlowElement e : flowElements) {
            // åˆ¤æ–­èŠ‚ç‚¹ç±»å‹
            if (e instanceof UserTask) {
                // å®¡æ‰¹äºº
                String sp1 = ((UserTask) e).getAssignee();
                // å€™é€‰äºº
                List<String> sp2 = ((UserTask) e).getCandidateUsers();
            }
        }
    }
}
```

**Api è¯´æ˜ï¼š**

- å¯ä»¥è·å–èŠ‚ç‚¹çš„ IDã€åç§°ã€è´Ÿè´£äººã€å€™é€‰äººç­‰ä¿¡æ¯

## äºŒã€æµç¨‹å®ä¾‹ç›¸å…³ Api

> ä»¥ä¸‹ Api è·Ÿæµç¨‹å®ä¾‹ç›¸å…³

## è·å–æµç¨‹å®ä¾‹

```java
public ProcessInstance getProcessInstanceById(String processInstanceId) {
    return runtimeService.createProcessInstanceQuery()
        .processInstanceId(processInstanceId)
        .singleResult();
}
```

## åˆ é™¤æµç¨‹å®ä¾‹

```java
/**
  * åˆ é™¤éƒ¨ç½²çš„æµç¨‹å®ä¾‹
  *
  * @param instanceId æµç¨‹å®ä¾‹ID
  * @param deleteReason åˆ é™¤åŸå› ï¼Œå¯ä¸ºç©º
  */
 public void deleteProcIns(String instanceId, String deleteReason) {
   runtimeService.deleteProcessInstance(instanceId, deleteReason);
 }
```

## æ ¹æ®æµç¨‹å®ä¾‹è·å–ç›®å‰æ´»åŠ¨èŠ‚ç‚¹

```java
public List<String> getActiveActivityIds(String processInstanceId) {
    return runtimeService.getActiveActivityIds(processInstanceId);
}
```

## è·å–å†å²æµç¨‹å®ä¾‹

```java
public HistoricProcessInstance getHistoricProcessInstanceById(String processInstanceId) {
    return historyService
        .createHistoricProcessInstanceQuery()
        .processInstanceId(processInstanceId)
        .singleResult();
}
```

## è·å–å†å²æ‰¹æ³¨ä¿¡æ¯

```java
public String getTaskComments(String taskId) {
    List<Comment> taskComments = taskService.getTaskComments(taskId);
    if (taskComments == null) {
        return "æš‚æ— æ‰¹æ³¨";
    }

    return taskComments.stream()
        .map(Comment::getFullMessage)
        .collect(Collectors.joining(";"));
}
```



## è·å–æµç¨‹å®ä¾‹çš„å†å²ä»»åŠ¡

```java
public List<HistoricActivityInstance> selectHistoryTaskList(String instanceId) {
    return historyService.createHistoricActivityInstanceQuery()
        .processInstanceId(instanceId)
        .activityType("userTask")
        .finished()
        .orderByHistoricActivityInstanceStartTime()
        .desc()
        .list();
}
```

**å‚æ•°è¯´æ˜ï¼š**

- **instanceId** - æµç¨‹å®ä¾‹ ID
- **activityType** - èŠ‚ç‚¹ç±»å‹
- **finished** - å·²å®Œæˆ
- æ ¹æ®åˆ›å»ºæ—¶é—´æ’åº



## æŸ¥è¯¢ä»»åŠ¡ç›¸å…³ Api

> ä»¥ä¸‹ API è·Ÿ Task ä»»åŠ¡æœ‰å…³

## æ ¹æ®æµç¨‹å®ä¾‹ ID æŸ¥è¯¢å½“å‰ Task

```java
public List<Task> getTaskByInstanceId(String instanceId) {
    return taskService.createTaskQuery().processInstanceId(instanceId).List();
}
```

## ä¸‰ã€Task æ·»åŠ å€™é€‰äºº

```java
public void addCandidateUser(String taskId, String candidateUser) {
    taskService.addCandidateUser(taskId, candidateUser);
}
```

## æŸ¥è¯¢å€™é€‰äººå¾…åŠä»»åŠ¡

```java
public List<Task> selectTodoTaskList(String definitionKey, String candidateUser) {
    return taskService.createTaskQuery()
        .processDefinitionKey(definitionKey)
        .taskCandidateUser(candidateUser)
        .orderByTaskCreateTime()
        .desc()
        .listPage();
}
```

**å‚æ•°è¯´æ˜ï¼š**

- **definitionKey** - æµç¨‹å®šä¹‰ Key
- **candidateUser** - å€™é€‰äºº
- æ ¹æ® task åˆ›å»ºæ—¶é—´æ’åº

## æ ¹æ® TaskId è·å– Task

```java
public Task getTaskByTaskId(String taskId) {
    return taskService.createTaskQuery().taskId(taskId).singleResult();
}
```

## é¢†å–ä»»åŠ¡ä»¥åŠå®Œæˆä»»åŠ¡æ·»åŠ æ‰¹æ³¨

```java
public void claimAndComplateTask(Task task, String userId, boolean auditStatusBoolean, String commentStr) {
    String taskId = task.getId();
    // å¦‚æœå€™é€‰ä»»åŠ¡æ²¡æœ‰è¿›è¡Œé¢†å–å°±ç›´æ¥å®Œæˆçš„è¯ï¼Œé‚£ä¹ˆåœ¨å†å²è®°å½•ä¸­å°±ä¸ä¼šè®°å½•æ˜¯å“ªä¸ªç”¨æˆ·æ‰§è¡Œäº†è¿™ä¸ªä»»åŠ¡.
    taskService.claim(taskId, userId);
    // æ·»åŠ æ‰¹æ³¨
    taskService.addComment(taskId, task.getProcessInstanceId(), commentStr);
    // æ·»åŠ æµç¨‹å˜é‡
    taskService.setVariable(taskId, task.getTaskDefinitionKey(), auditStatusBoolean);
    // å®Œæˆä»»åŠ¡
    taskService.complete(taskId);
}
```

## Task æ·»åŠ æµç¨‹å˜é‡

```java
public void setVariable(String taskId, String variableName, Object variableValue) {
    taskService.setVariable(taskId, variableName, variableValue);
}
```

## æŸ¥è¯¢ç”¨æˆ·å·²åŠä»»åŠ¡åˆ—è¡¨

```java
public List<HistoricTaskInstance> selectDoneTaskList(String definitionKey, String userId) {
    return historyService
        .createHistoricTaskInstanceQuery()
        .processDefinitionKey(definitionKey)
        .taskAssignee(userId)
        .finished()
        .orderByHistoricTaskInstanceEndTime()
        .desc()
        .list();
}
```

**å‚æ•°è¯´æ˜:**

- **definitionKey** - æµç¨‹å®šä¹‰ Key
- **userId** - å“ªä¸ªç”¨æˆ·çš„å·²åŠ
- **finished** - çŠ¶æ€å·²å®Œæˆ
- æ ¹æ®å®Œæˆæ—¶é—´æ’åº