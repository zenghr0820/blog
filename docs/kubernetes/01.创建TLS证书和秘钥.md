---
title: "åˆ›å»ºTLSè¯ä¹¦å’Œç§˜é’¥"
date: "2020-08-12 17:50"
parentlevel: "kubernetes"
permalink: "2020-08-12-kubernetes-generate-tls"
---

# åˆ›å»ºTLSè¯ä¹¦å’Œç§˜é’¥

**å¦‚æœæ‚¨ä¸æƒ³çœ‹è®¤è¯æˆæƒçš„è§£é‡Šï¼Œè¯·ç›´æ¥çœ‹**  [å®‰è£… CFSSL](#ä¸‰ã€å®‰è£…-cfssl)

[[TOC]]

## ä¸€ã€ç†è§£è®¤è¯æˆæƒ

> è¯¥æ®µç†è§£å¼•ç”¨ [kubernetes-with-ca](https://github.com/liuyi01/kubernetes-starter/blob/master/docs/3-kubernetes-with-ca.md)

### 1.1 ä¸ºä»€ä¹ˆè¦è®¤è¯

æƒ³ç†è§£è®¤è¯ï¼Œæˆ‘ä»¬å¾—ä»è®¤è¯è§£å†³ä»€ä¹ˆé—®é¢˜ã€é˜²æ­¢ä»€ä¹ˆé—®é¢˜çš„å‘ç”Ÿå…¥æ‰‹ã€‚
é˜²æ­¢ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿæ˜¯é˜²æ­¢æœ‰äººå…¥ä¾µä½ çš„é›†ç¾¤ï¼Œrootä½ çš„æœºå™¨åè®©æˆ‘ä»¬é›†ç¾¤ä¾ç„¶å®‰å…¨å—ï¼Ÿä¸æ˜¯å§ï¼Œrootéƒ½åˆ°æ‰‹äº†ï¼Œé‚£å°±ä¸ºæ‰€æ¬²ä¸ºï¼Œé˜²ä¸èƒœé˜²äº†ã€‚
å…¶å®ç½‘ç»œå®‰å…¨æœ¬èº«å°±æ˜¯ä¸ºäº†è§£å†³åœ¨æŸäº›å‡è®¾æˆç«‹çš„æ¡ä»¶ä¸‹å¦‚ä½•é˜²èŒƒçš„é—®é¢˜ã€‚æ¯”å¦‚ä¸€ä¸ªéå¸¸é‡è¦çš„å‡è®¾å°±æ˜¯ä¸¤ä¸ªèŠ‚ç‚¹æˆ–è€…ipä¹‹é—´çš„é€šè®¯ç½‘ç»œæ˜¯ä¸å¯ä¿¡ä»»çš„ï¼Œå¯èƒ½ä¼šè¢«ç¬¬ä¸‰æ–¹çªƒå–ï¼Œä¹Ÿå¯èƒ½ä¼šè¢«ç¬¬ä¸‰æ–¹ç¯¡æ”¹ã€‚å°±åƒæˆ‘ä»¬ä¸Šå­¦æ—¶å€™ç»™å¿ƒä»ªçš„å¥³å­©ä¼ çº¸æ¡ï¼Œä¼ é€çš„è¿‡ç¨‹å¯èƒ½ä¼šè¢«åˆ«çš„åŒå­¦å·çœ‹ï¼Œç”šè‡³å†…å®¹å¯èƒ½ä¼šä»æˆ‘å–œæ¬¢ä½ ä¿®æ”¹æˆæˆ‘ä¸å–œæ¬¢ä½ äº†ã€‚å½“ç„¶è¿™ç§å‡è®¾ä¸æ˜¯éšä¾¿æƒ³å‡ºæ¥çš„ï¼Œè€Œæ˜¯ä»ç½‘ç»œæŠ€æœ¯ç°çŠ¶å’Œå®é™…å‘ç”Ÿçš„é—®é¢˜ä¸­å‘ç°ã€æ€»ç»“å‡ºæ¥çš„ã€‚kubernetesçš„è®¤è¯ä¹Ÿæ˜¯ä»è¿™ä¸ªé—®é¢˜å‡ºå‘æ¥å®ç°çš„ã€‚

### 1.2 æ¦‚å¿µæ¢³ç†

ä¸ºäº†è§£å†³ä¸Šé¢è¯´çš„é—®é¢˜ï¼Œkuberneteså¹¶ä¸éœ€è¦è‡ªå·±æƒ³åŠæ³•ï¼Œæ¯•ç«Ÿæ˜¯ç½‘ç»œå®‰å…¨å±‚é¢çš„é—®é¢˜ï¼Œæ˜¯æ¯ä¸ªæœåŠ¡éƒ½ä¼šé‡åˆ°çš„é—®é¢˜ï¼Œä¸šå†…ä¹Ÿæœ‰æˆç†Ÿçš„æ–¹æ¡ˆæ¥è§£å†³ã€‚è¿™é‡Œæˆ‘ä»¬ä¸€èµ·äº†è§£ä¸€ä¸‹ä¸šå†…æ–¹æ¡ˆå’Œç›¸å…³çš„æ¦‚å¿µã€‚

- **å¯¹ç§°åŠ å¯†/éå¯¹ç§°åŠ å¯†** è¿™ä¸¤ä¸ªæ¦‚å¿µå±äºå¯†ç å­¦çš„ä¸œè¥¿ï¼Œå¯¹äºæ²¡æ¥è§¦è¿‡çš„åŒå­¦ä¸å¤ªå®¹æ˜“ç†è§£ã€‚å¯ä»¥å‚è€ƒçŸ¥ä¹å¤§ç¥çš„ç”ŸåŠ¨è®²è§£ï¼š[ã€Šå¦‚ä½•ç”¨é€šä¿—æ˜“æ‡‚çš„è¯æ¥è§£é‡Šéå¯¹ç§°åŠ å¯†ã€‹](https://www.zhihu.com/question/33645891/answer/57721969)
- **SSL/TLS** äº†è§£äº†å¯¹ç§°åŠ å¯†å’Œéå¯¹ç§°åŠ å¯†åï¼Œæˆ‘ä»¬å°±å¯ä»¥äº†è§£ä¸€ä¸‹SSL/TLSäº†ã€‚åŒæ ·ï¼Œå·²ç»æœ‰å¤§ç¥æ€»ç»“äº†éå¸¸å¥½çš„å…¥é—¨æ–‡ç« ï¼š[ã€ŠSSL/TLSåè®®è¿è¡Œæœºåˆ¶çš„æ¦‚è¿°ã€‹](http://www.ruanyifeng.com/blog/2014/02/ssl_tls.html)

### 1.3 ä»€ä¹ˆæ˜¯æˆæƒ

æˆæƒçš„æ¦‚å¿µå°±ç®€å•å¤šäº†ï¼Œå°±æ˜¯ä»€ä¹ˆäººå…·æœ‰ä»€ä¹ˆæ ·çš„æƒé™ï¼Œä¸€èˆ¬é€šè¿‡è§’è‰²ä½œä¸ºçº½å¸¦æŠŠä»–ä»¬ç»„åˆåœ¨ä¸€èµ·ã€‚ä¹Ÿå°±æ˜¯ä¸€ä¸ªè§’è‰²ä¸€è¾¹æ‹¥æœ‰å¤šç§æƒé™ï¼Œä¸€è¾¹æ‹¥æœ‰å¤šä¸ªäººã€‚è¿™æ ·å°±æŠŠäººå’Œæƒé™å»ºç«‹äº†ä¸€ä¸ªå…³ç³»ã€‚

## äºŒã€kubernetesçš„è®¤è¯æˆæƒ

Kubernetesé›†ç¾¤çš„æ‰€æœ‰æ“ä½œåŸºæœ¬ä¸Šéƒ½æ˜¯é€šè¿‡kube-apiserverè¿™ä¸ªç»„ä»¶è¿›è¡Œçš„ï¼Œå®ƒæä¾›HTTP RESTfulå½¢å¼çš„APIä¾›é›†ç¾¤å†…å¤–å®¢æˆ·ç«¯è°ƒç”¨ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼šè®¤è¯æˆæƒè¿‡ç¨‹åªå­˜åœ¨HTTPSå½¢å¼çš„APIä¸­ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœå®¢æˆ·ç«¯ä½¿ç”¨HTTPè¿æ¥åˆ°kube-apiserverï¼Œé‚£ä¹ˆæ˜¯ä¸ä¼šè¿›è¡Œè®¤è¯æˆæƒçš„ã€‚æ‰€ä»¥è¯´ï¼Œå¯ä»¥è¿™ä¹ˆè®¾ç½®ï¼Œåœ¨é›†ç¾¤å†…éƒ¨ç»„ä»¶é—´é€šä¿¡ä½¿ç”¨HTTPï¼Œé›†ç¾¤å¤–éƒ¨å°±ä½¿ç”¨HTTPSï¼Œè¿™æ ·æ—¢å¢åŠ äº†å®‰å…¨æ€§ï¼Œä¹Ÿä¸è‡³äºå¤ªå¤æ‚ã€‚
å¯¹APIServerçš„è®¿é—®è¦ç»è¿‡çš„ä¸‰ä¸ªæ­¥éª¤ï¼Œå‰é¢ä¸¤ä¸ªæ˜¯è®¤è¯å’Œæˆæƒï¼Œç¬¬ä¸‰ä¸ªæ˜¯ Admission Controlï¼Œå®ƒä¹Ÿèƒ½åœ¨ä¸€å®šç¨‹åº¦ä¸Šæé«˜å®‰å…¨æ€§ï¼Œä¸è¿‡æ›´å¤šæ˜¯èµ„æºç®¡ç†æ–¹é¢çš„ä½œç”¨ã€‚

### 2.1 kubernetesçš„è®¤è¯

kubernetesæä¾›äº†å¤šç§è®¤è¯æ–¹å¼ï¼Œæ¯”å¦‚å®¢æˆ·ç«¯è¯ä¹¦ã€é™æ€tokenã€é™æ€å¯†ç æ–‡ä»¶ã€ServiceAccountTokensç­‰ç­‰ã€‚ä½ å¯ä»¥åŒæ—¶ä½¿ç”¨ä¸€ç§æˆ–å¤šç§è®¤è¯æ–¹å¼ã€‚åªè¦é€šè¿‡ä»»ä½•ä¸€ä¸ªéƒ½è¢«è®¤ä½œæ˜¯è®¤è¯é€šè¿‡ã€‚ä¸‹é¢æˆ‘ä»¬å°±è®¤è¯†å‡ ä¸ªå¸¸è§çš„è®¤è¯æ–¹å¼ã€‚

- **å®¢æˆ·ç«¯è¯ä¹¦è®¤è¯** å®¢æˆ·ç«¯è¯ä¹¦è®¤è¯å«ä½œTLSåŒå‘è®¤è¯ï¼Œä¹Ÿå°±æ˜¯æœåŠ¡å™¨å®¢æˆ·ç«¯äº’ç›¸éªŒè¯è¯ä¹¦çš„æ­£ç¡®æ€§ï¼Œåœ¨éƒ½æ­£ç¡®çš„æƒ…å†µä¸‹åè°ƒé€šä¿¡åŠ å¯†æ–¹æ¡ˆã€‚ ä¸ºäº†ä½¿ç”¨è¿™ä¸ªæ–¹æ¡ˆï¼Œapi-serveréœ€è¦ç”¨--client-ca-fileé€‰é¡¹æ¥å¼€å¯ã€‚
- **å¼•å¯¼Token** å½“æˆ‘ä»¬æœ‰éå¸¸å¤šçš„nodeèŠ‚ç‚¹æ—¶ï¼Œæ‰‹åŠ¨ä¸ºæ¯ä¸ªnodeèŠ‚ç‚¹é…ç½®TLSè®¤è¯æ¯”è¾ƒéº»çƒ¦ï¼Œè¿™æ—¶å°±å¯ä»¥ç”¨åˆ°å¼•å¯¼tokençš„è®¤è¯æ–¹å¼ï¼Œå‰ææ˜¯éœ€è¦åœ¨api-serverå¼€å¯ experimental-bootstrap-token-auth ç‰¹æ€§ï¼Œå®¢æˆ·ç«¯çš„tokenä¿¡æ¯ä¸é¢„å…ˆå®šä¹‰çš„tokenåŒ¹é…è®¤è¯é€šè¿‡åï¼Œè‡ªåŠ¨ä¸ºnodeé¢å‘è¯ä¹¦ã€‚å½“ç„¶å¼•å¯¼tokenæ˜¯ä¸€ç§æœºåˆ¶ï¼Œå¯ä»¥ç”¨åˆ°å„ç§åœºæ™¯ä¸­ã€‚
- **Service Account Tokens è®¤è¯** æœ‰äº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨podå†…éƒ¨è®¿é—®api-serverï¼Œè·å–é›†ç¾¤çš„ä¿¡æ¯ï¼Œç”šè‡³å¯¹é›†ç¾¤è¿›è¡Œæ”¹åŠ¨ã€‚é’ˆå¯¹è¿™ç§æƒ…å†µï¼Œkubernetesæä¾›äº†ä¸€ç§ç‰¹æ®Šçš„è®¤è¯æ–¹å¼ï¼šService Accountã€‚ Service Account å’Œ podã€serviceã€deployment ä¸€æ ·æ˜¯ kubernetes é›†ç¾¤ä¸­çš„ä¸€ç§èµ„æºï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥åˆ›å»ºè‡ªå·±çš„ Service Accountã€‚ ServiceAccount ä¸»è¦åŒ…å«äº†ä¸‰ä¸ªå†…å®¹ï¼šnamespaceã€Token å’Œ CAã€‚namespace æŒ‡å®šäº† pod æ‰€åœ¨çš„ namespaceï¼ŒCA ç”¨äºéªŒè¯ apiserver çš„è¯ä¹¦ï¼Œtoken ç”¨ä½œèº«ä»½éªŒè¯ã€‚å®ƒä»¬éƒ½é€šè¿‡ mount çš„æ–¹å¼ä¿å­˜åœ¨ pod çš„æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚

### 2.2 kubernetesçš„æˆæƒ

åœ¨Kubernetes1.6ç‰ˆæœ¬ä¸­æ–°å¢è§’è‰²è®¿é—®æ§åˆ¶æœºåˆ¶ï¼ˆRole-Based Accessï¼ŒRBACï¼‰è®©é›†ç¾¤ç®¡ç†å‘˜å¯ä»¥é’ˆå¯¹ç‰¹å®šä½¿ç”¨è€…æˆ–æœåŠ¡è´¦å·çš„è§’è‰²ï¼Œè¿›è¡Œæ›´ç²¾ç¡®çš„èµ„æºè®¿é—®æ§åˆ¶ã€‚åœ¨RBACä¸­ï¼Œæƒé™ä¸è§’è‰²ç›¸å…³è”ï¼Œç”¨æˆ·é€šè¿‡æˆä¸ºé€‚å½“è§’è‰²çš„æˆå‘˜è€Œå¾—åˆ°è¿™äº›è§’è‰²çš„æƒé™ã€‚è¿™å°±æå¤§åœ°ç®€åŒ–äº†æƒé™çš„ç®¡ç†ã€‚åœ¨ä¸€ä¸ªç»„ç»‡ä¸­ï¼Œè§’è‰²æ˜¯ä¸ºäº†å®Œæˆå„ç§å·¥ä½œè€Œåˆ›é€ ï¼Œç”¨æˆ·åˆ™ä¾æ®å®ƒçš„è´£ä»»å’Œèµ„æ ¼æ¥è¢«æŒ‡æ´¾ç›¸åº”çš„è§’è‰²ï¼Œç”¨æˆ·å¯ä»¥å¾ˆå®¹æ˜“åœ°ä»ä¸€ä¸ªè§’è‰²è¢«æŒ‡æ´¾åˆ°å¦ä¸€ä¸ªè§’è‰²ã€‚ ç›®å‰ Kubernetes ä¸­æœ‰ä¸€ç³»åˆ—çš„é‰´æƒæœºåˆ¶ï¼Œå› ä¸ºKubernetesç¤¾åŒºçš„æŠ•å…¥å’Œåå¥½ï¼Œç›¸å¯¹äºå…¶å®ƒé‰´æƒæœºåˆ¶è€Œè¨€ï¼ŒRBACæ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚å…·ä½“RBACæ˜¯å¦‚ä½•ä½“ç°åœ¨kubernetesç³»ç»Ÿä¸­çš„æˆ‘ä»¬ä¼šåœ¨åé¢çš„éƒ¨ç½²ä¸­é€æ­¥çš„æ·±å…¥äº†è§£ã€‚

### 2.3 kubernetesçš„AdmissionControl

AdmissionControl - å‡†å…¥æ§åˆ¶æœ¬è´¨ä¸Šä¸ºä¸€æ®µå‡†å…¥ä»£ç ï¼Œåœ¨å¯¹kubernetes apiçš„è¯·æ±‚è¿‡ç¨‹ä¸­ï¼Œé¡ºåºä¸ºï¼šå…ˆç»è¿‡è®¤è¯ & æˆæƒï¼Œç„¶åæ‰§è¡Œå‡†å…¥æ“ä½œï¼Œæœ€åå¯¹ç›®æ ‡å¯¹è±¡è¿›è¡Œæ“ä½œã€‚è¿™ä¸ªå‡†å…¥ä»£ç åœ¨api-serverä¸­ï¼Œè€Œä¸”å¿…é¡»è¢«ç¼–è¯‘åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ä¸­æ‰èƒ½è¢«æ‰§è¡Œã€‚ åœ¨å¯¹é›†ç¾¤è¿›è¡Œè¯·æ±‚æ—¶ï¼Œæ¯ä¸ªå‡†å…¥æ§åˆ¶ä»£ç éƒ½æŒ‰ç…§ä¸€å®šé¡ºåºæ‰§è¡Œã€‚å¦‚æœæœ‰ä¸€ä¸ªå‡†å…¥æ§åˆ¶æ‹’ç»äº†æ­¤æ¬¡è¯·æ±‚ï¼Œé‚£ä¹ˆæ•´ä¸ªè¯·æ±‚çš„ç»“æœå°†ä¼šç«‹å³è¿”å›ï¼Œå¹¶æç¤ºç”¨æˆ·ç›¸åº”çš„errorä¿¡æ¯ã€‚ å¸¸ç”¨ç»„ä»¶ï¼ˆæ§åˆ¶ä»£ç ï¼‰å¦‚ä¸‹ï¼š

- AlwaysAdmitï¼šå…è®¸æ‰€æœ‰è¯·æ±‚
- AlwaysDenyï¼šç¦æ­¢æ‰€æœ‰è¯·æ±‚ï¼Œå¤šç”¨äºæµ‹è¯•ç¯å¢ƒ
- ServiceAccountï¼šå®ƒå°†serviceAccountså®ç°äº†è‡ªåŠ¨åŒ–ï¼Œå®ƒä¼šè¾…åŠ©serviceAccountåšä¸€äº›äº‹æƒ…ï¼Œæ¯”å¦‚å¦‚æœpodæ²¡æœ‰serviceAccountå±æ€§ï¼Œå®ƒä¼šè‡ªåŠ¨æ·»åŠ ä¸€ä¸ªdefaultï¼Œå¹¶ç¡®ä¿podçš„serviceAccountå§‹ç»ˆå­˜åœ¨
- LimitRangerï¼šä»–ä¼šè§‚å¯Ÿæ‰€æœ‰çš„è¯·æ±‚ï¼Œç¡®ä¿æ²¡æœ‰è¿åå·²ç»å®šä¹‰å¥½çš„çº¦æŸæ¡ä»¶ï¼Œè¿™äº›æ¡ä»¶å®šä¹‰åœ¨namespaceä¸­LimitRangeå¯¹è±¡ä¸­ã€‚å¦‚æœåœ¨kubernetesä¸­ä½¿ç”¨LimitRangeå¯¹è±¡ï¼Œåˆ™å¿…é¡»ä½¿ç”¨è¿™ä¸ªæ’ä»¶ã€‚
- NamespaceExistsï¼šå®ƒä¼šè§‚å¯Ÿæ‰€æœ‰çš„è¯·æ±‚ï¼Œå¦‚æœè¯·æ±‚å°è¯•åˆ›å»ºä¸€ä¸ªä¸å­˜åœ¨çš„namespaceï¼Œåˆ™è¿™ä¸ªè¯·æ±‚è¢«æ‹’ç»ã€‚



## ä¸‰ã€å®‰è£… CFSSL

**éœ€è¦å‡†å¤‡çš„è¯ä¹¦ï¼š**

- ca-key.pem
- ca.pem
- etcd-key.pem
- etcd.pem
- server-key.pem
- server.pem
- admin.pem
- admin-key.pem
- kube-proxy-key.pem
- kube-proxy.pem

**ä½¿ç”¨è¯ä¹¦çš„ç»„ä»¶å¦‚ä¸‹ï¼š**

- etcdï¼šä½¿ç”¨ ca.pemã€server-key.pemã€server.pem
- kube-apiserverï¼šä½¿ç”¨ ca.pemã€server-key.pemã€server.pem
- kubeletï¼šä½¿ç”¨ ca.pem
- kube-proxyï¼šä½¿ç”¨ ca.pemã€kube-proxy-key.pemã€kube-proxy.pem
- kubectlï¼šä½¿ç”¨ ca.pemã€admin-key.pemã€admin.pem
- kube-controller-managerï¼šä½¿ç”¨ ca-key.pemã€ca.pem

æˆ‘ä»¬ä½¿ç”¨CFSSLæ¥åˆ¶ä½œè¯ä¹¦ï¼Œå®ƒæ˜¯cloudflareå¼€å‘çš„ä¸€ä¸ªå¼€æºçš„PKIå·¥å…·ï¼Œæ˜¯ä¸€ä¸ªå®Œå¤‡çš„CAæœåŠ¡ç³»ç»Ÿï¼Œå¯ä»¥ç­¾ç½²ã€æ’¤é”€è¯ä¹¦ç­‰ï¼Œè¦†ç›–äº†ä¸€ä¸ªè¯ä¹¦çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œåé¢åªç”¨åˆ°äº†å®ƒçš„å‘½ä»¤è¡Œå·¥å…·ã€‚

::: tip

æ³¨ï¼šä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒK8Sä¸­è¯ä¹¦åªéœ€è¦åˆ›å»ºä¸€æ¬¡ï¼Œä»¥ååœ¨å‘é›†ç¾¤ä¸­æ·»åŠ æ–°èŠ‚ç‚¹æ—¶åªè¦å°†/etc/kubernetes/caç›®å½•ä¸‹çš„è¯ä¹¦æ‹·è´åˆ°æ–°èŠ‚ç‚¹ä¸Šå³å¯ã€‚

:::

cfsslæ˜¯éå¸¸å¥½ç”¨çš„CAå·¥å…·ï¼Œæˆ‘ä»¬ç”¨å®ƒæ¥ç”Ÿæˆè¯ä¹¦å’Œç§˜é’¥æ–‡ä»¶ï¼Œ**ç›´æ¥ä½¿ç”¨äºŒè¿›åˆ¶æºç åŒ…å®‰è£…ï¼š**

```bash
#ä¸‹è½½
$ wget -q --show-progress --https-only --timestamping \
  https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 \
  https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64
  
#ä¿®æ”¹ä¸ºå¯æ‰§è¡Œæƒé™
$ chmod +x cfssl_linux-amd64 cfssljson_linux-amd64

#ç§»åŠ¨åˆ°binç›®å½•
$ mv cfssl_linux-amd64 /usr/local/bin/cfssl
$ mv cfssljson_linux-amd64 /usr/local/bin/cfssljson

#éªŒè¯
$ cfssl version
```



## è¯ä¹¦ä½ç½®

```bash
#æ‰€æœ‰è¯ä¹¦ç›¸å…³çš„ä¸œè¥¿éƒ½æ”¾åœ¨è¿™, åé¢æ‰€æœ‰çš„è¯ä¹¦éƒ½æ”¾åœ¨è¯¥ç›®å½•ä¸‹, ä½ å¯ä»¥è‡ªå®šä¹‰
mkdir -p /etc/kubernetes/ca
```



## å››ã€åˆ›å»º CA (æ ¹è¯ä¹¦)

### 4.1 åˆ›å»º CA é…ç½®æ–‡ä»¶

```bash
cd /etc/kubernetes/ca
# åˆ›å»ºå¦‚ä¸‹çš„ca-config.jsonæ–‡ä»¶(* ä¹Ÿå¯ä»¥ä¸æ‰§è¡Œè¯¥å‘½ä»¤ï¼Œç›´æ¥åˆ›å»ºä¸‹é¢ğŸ‘‡çš„æ–‡ä»¶)
cfssl print-defaults config > ca-config.json
# ä¿®æ”¹ ca-config.json æ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š
vim ca-config.json
# è¿‡æœŸæ—¶é—´è®¾ç½®æˆäº† 87600h
{
  "signing": {
    "default": {
      "expiry": "87600h"
    },
    "profiles": {
      "kubernetes": {
        "usages": [
            "signing",
            "key encipherment",
            "server auth",
            "client auth"
        ],
        "expiry": "87600h"
      }
    }
  }
}

```

å­—æ®µè¯´æ˜

- `ca-config.json`ï¼šå¯ä»¥å®šä¹‰å¤šä¸ª profilesï¼Œåˆ†åˆ«æŒ‡å®šä¸åŒçš„è¿‡æœŸæ—¶é—´ã€ä½¿ç”¨åœºæ™¯ç­‰å‚æ•°ï¼›åç»­åœ¨ç­¾åè¯ä¹¦æ—¶ä½¿ç”¨æŸä¸ª profileï¼›
- `signing`ï¼šè¡¨ç¤ºè¯¥è¯ä¹¦å¯ç”¨äºç­¾åå…¶å®ƒè¯ä¹¦ï¼›ç”Ÿæˆçš„ ca.pem è¯ä¹¦ä¸­ `CA=TRUE`ï¼›
- `server auth`ï¼šè¡¨ç¤ºclientå¯ä»¥ç”¨è¯¥ CA å¯¹serveræä¾›çš„è¯ä¹¦è¿›è¡ŒéªŒè¯ï¼›
- `client auth`ï¼šè¡¨ç¤ºserverå¯ä»¥ç”¨è¯¥CAå¯¹clientæä¾›çš„è¯ä¹¦è¿›è¡ŒéªŒè¯ï¼›

### 4.2 åˆ›å»º CA è¯ä¹¦ç­¾åè¯·æ±‚

```bash
# åˆ›å»ºå¦‚ä¸‹çš„ca-csr.jsonæ–‡ä»¶
cfssl print-defaults csr > ca-csr.json
# ä¿®æ”¹ ca-csr.json æ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š
vim ca-csr.json
# ca-csr.josn æ–‡ä»¶å†…å®¹å¦‚ä¸‹
{
  "CN": "kubernetes",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "BeiJing",
      "L": "BeiJing",
      "O": "k8s",
      "OU": "System"
    }
  ],
    "ca": {
       "expiry": "87600h"
    }
}
```

å­—æ®µè¯´æ˜

- "CN"ï¼š`Common Name`ï¼Œkube-apiserver ä»è¯ä¹¦ä¸­æå–è¯¥å­—æ®µä½œä¸ºè¯·æ±‚çš„ç”¨æˆ·å (User Name)ï¼›æµè§ˆå™¨ä½¿ç”¨è¯¥å­—æ®µéªŒè¯ç½‘ç«™æ˜¯å¦åˆæ³•ï¼›
- "O"ï¼š`Organization`ï¼Œkube-apiserver ä»è¯ä¹¦ä¸­æå–è¯¥å­—æ®µä½œä¸ºè¯·æ±‚ç”¨æˆ·æ‰€å±çš„ç»„ (Group)ï¼›

### 4.3 ç”Ÿæˆ CA è¯ä¹¦å’Œç§é’¥

```bash
cfssl gencert -initca ca-csr.json | cfssljson -bare ca
# ç”Ÿæˆå®Œæˆåä¼šæœ‰ä»¥ä¸‹æ–‡ä»¶ï¼ˆæˆ‘ä»¬æœ€ç»ˆæƒ³è¦çš„å°±æ˜¯ca-key.pemå’Œca.pemï¼Œä¸€ä¸ªç§˜é’¥ï¼Œä¸€ä¸ªè¯ä¹¦ï¼‰
> ls
> ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem
```



## äº”ã€åˆ›å»º ETCD è¯ä¹¦

### 5.1 ç”Ÿæˆ etcd è¯ä¹¦é…ç½®

```bash
# etcdè¯ä¹¦æ”¾åœ¨è¿™
mkdir -p /etc/kubernetes/ca/etcd
cd /etc/kubernetes/ca/etcd
vim etcd-csr.json
# æ–‡ä»¶å†…å®¹å¦‚ä¸‹
{
  "CN": "etcd",
  "hosts": [
    "127.0.0.1",
    "192.168.10.102"
  ],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "Beijing",
      "L": "XS",
      "O": "k8s",
      "OU": "System"
    }
  ]
}
```

å­—æ®µè¯´æ˜

- `hosts`ï¼šæŒ‡å®šæˆæƒä½¿ç”¨è¯¥è¯ä¹¦çš„ **IP æˆ–åŸŸååˆ—è¡¨**ï¼Œå¦‚æœæœ‰éƒ¨ç½²å¤šä¸ª etcdï¼Œé‚£ä¹ˆå°±éœ€è¦å¡«å…¥å…¶ä»– etcd çš„ **IP æˆ–åŸŸååˆ—è¡¨**ï¼Œæˆ‘è¿™é‡Œåªéƒ¨ç½²ä¸€å°æ‰€ä»¥å°±å†™ä¸€ä¸ªâ˜ï¸

::: tip 

æ³¨ï¼šä¸Šè¿°æ–‡ä»¶hostså­—æ®µä¸­IPä¸ºæ‰€æœ‰etcdèŠ‚ç‚¹çš„é›†ç¾¤å†…éƒ¨é€šä¿¡IPï¼Œä¸€ä¸ªéƒ½ä¸èƒ½å°‘ï¼ä¸ºäº†æ–¹ä¾¿åæœŸæ‰©å®¹å¯ä»¥å¤šå†™å‡ ä¸ªé¢„ç•™çš„IPã€‚

:::

### 5.2 ä½¿ç”¨æ ¹è¯ä¹¦(ca.pem)ç­¾å‘etcdè¯ä¹¦

```bash
cfssl gencert \
        -ca=/etc/kubernetes/ca/ca.pem \
        -ca-key=/etc/kubernetes/ca/ca-key.pem \
        -config=/etc/kubernetes/ca/ca-config.json \
        -profile=kubernetes etcd-csr.json | cfssljson -bare etcd
   
# è·Ÿä¹‹å‰ç±»ä¼¼ç”Ÿæˆä¸‰ä¸ªæ–‡ä»¶etcd.csræ˜¯ä¸ªä¸­é—´è¯ä¹¦è¯·æ±‚æ–‡ä»¶ï¼Œæˆ‘ä»¬æœ€ç»ˆè¦çš„æ˜¯etcd-key.pemå’Œetcd.pem
> ls
> etcd.csr  etcd-csr.json  etcd-key.pem  etcd.pem
```



## å…­ã€åˆ›å»º Api-server è¯ä¹¦

- **controller-managerï¼š** ä¸€èˆ¬ä¸api-serveråœ¨åŒä¸€å°æœºå™¨ä¸Šï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨éå®‰å…¨ç«¯å£ä¸api-serveré€šè®¯ï¼Œä¸éœ€è¦ç”Ÿæˆè¯ä¹¦å’Œç§é’¥
- **schedulerï¼š** ä¸€èˆ¬ä¸apiserveråœ¨åŒä¸€å°æœºå™¨ä¸Šï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨éå®‰å…¨ç«¯å£ä¸apiserveré€šè®¯ã€‚ä¸éœ€è¦ç”Ÿæˆè¯ä¹¦å’Œç§é’¥ã€‚



### 6.1 ç”Ÿæˆ Api-server è¯ä¹¦é…ç½®

```bash
# api-serverè¯ä¹¦æ”¾åœ¨è¿™
mkdir -p /etc/kubernetes/ca/server
cd /etc/kubernetes/ca/server
vim server-csr.json
# å†…å®¹å¦‚ä¸‹
{
  "CN": "kubernetes",
  "hosts": [
    "127.0.0.1",
    "10.0.0.1",
    "192.168.10.101",
    "192.168.10.102",
    "192.168.10.103",
    "kubernetes",
    "kubernetes.default",
    "kubernetes.default.svc",
    "kubernetes.default.svc.cluster",
    "kubernetes.default.svc.cluster.local"
  ],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "Beijing",
      "L": "XS",
      "O": "k8s",
      "OU": "System"
    }
  ]
}
```

- **`kubernetes` æœåŠ¡çš„æœåŠ¡ IP**ï¼ˆä¸€èˆ¬æ˜¯ `kube-apiserver` æŒ‡å®šçš„ `service-cluster-ip-range` ç½‘æ®µçš„ç¬¬ä¸€ä¸ªIPï¼Œå¦‚ 10.0.0.1ï¼‰

### 6.2 ä½¿ç”¨æ ¹è¯ä¹¦(ca.pem)ç­¾å‘ apiserver è¯ä¹¦

```bash
cfssl gencert \
        -ca=/etc/kubernetes/ca/ca.pem \
        -ca-key=/etc/kubernetes/ca/ca-key.pem \
        -config=/etc/kubernetes/ca/ca-config.json \
        -profile=kubernetes server-csr.json | cfssljson -bare server
        
# è·Ÿä¹‹å‰ç±»ä¼¼ç”Ÿæˆä¸‰ä¸ªæ–‡ä»¶server.csræ˜¯ä¸ªä¸­é—´è¯ä¹¦è¯·æ±‚æ–‡ä»¶ï¼Œæˆ‘ä»¬æœ€ç»ˆè¦çš„æ˜¯server-key.pemå’Œserver.pem
> ls
> server-csr.json server.csr server.pem server-key.pem
```



## ä¸ƒã€åˆ›å»º Admin è¯ä¹¦

### 7.1 ç”Ÿæˆ Admin è¯ä¹¦é…ç½®

```bash
# kubectlè¯ä¹¦æ”¾åœ¨è¿™ï¼Œç”±äºkubectlç›¸å½“äºç³»ç»Ÿç®¡ç†å‘˜ï¼Œæˆ‘ä»¬ä½¿ç”¨adminå‘½å
mkdir -p /etc/kubernetes/ca/admin
cd /etc/kubernetes/ca/admin
vim admin-csr.json
# å†…å®¹å¦‚ä¸‹
{
  "CN": "admin",
  "hosts": [],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "BeiJing",
      "L": "BeiJing",
      "O": "system:masters",
      "OU": "System"
    }
  ]
}
```

### 7.2 ä½¿ç”¨æ ¹è¯ä¹¦(ca.pem)ç­¾å‘adminè¯ä¹¦

```bash
cfssl gencert \
        -ca=/etc/kubernetes/ca/ca.pem \
        -ca-key=/etc/kubernetes/ca/ca-key.pem \
        -config=/etc/kubernetes/ca/ca-config.json \
        -profile=kubernetes admin-csr.json | cfssljson -bare admin
        
# æˆ‘ä»¬æœ€ç»ˆè¦çš„æ˜¯admin-key.pemå’Œadmin.pem
> ls
> admin.csr  admin-csr.json  admin-key.pem  admin.pem
```



## å…«ã€åˆ›å»º kube-proxy è¯ä¹¦

### 8.1 ç”Ÿæˆ kube-proxy è¯ä¹¦é…ç½®

```bash
# proxyè¯ä¹¦æ”¾åœ¨è¿™
mkdir -p /etc/kubernetes/ca/kube-proxy
cd /etc/kubernetes/ca/kube-proxy
vim kube-proxy-csr.json
# å†…å®¹å¦‚ä¸‹
{
  "CN": "system:kube-proxy",
  "hosts": [],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "Beijing",
      "L": "BeiJing",
      "O": "k8s",
      "OU": "System"
    }
  ]
}
```

å­—æ®µè¯´æ˜ï¼š

- CN æŒ‡å®šè¯¥è¯ä¹¦çš„ User ä¸º `system:kube-proxy`

- `kube-apiserver` é¢„å®šä¹‰çš„ RoleBinding `system:node-proxy` å°†User `system:kube-proxy` ä¸ Role `system:node-proxier` ç»‘å®šï¼Œæˆäºˆäº†è°ƒç”¨ `kube-api-server` proxyçš„ç›¸å…³ API çš„æƒé™



### 8.2 ä½¿ç”¨æ ¹è¯ä¹¦(ca.pem)ç­¾å‘proxyè¯ä¹¦

```bash
cfssl gencert \
        -ca=/etc/kubernetes/ca/ca.pem \
        -ca-key=/etc/kubernetes/ca/ca-key.pem \
        -config=/etc/kubernetes/ca/ca-config.json \
        -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy
        
# æˆ‘ä»¬æœ€ç»ˆè¦çš„æ˜¯kube-proxy-key.pemå’Œkube-proxy.pem
> ls
> kube-proxy.csr  kube-proxy-csr.json  kube-proxy-key.pem  kube-proxy.pem
```



## ä¹ã€åˆ†å‘è¯ä¹¦

å°†ç”Ÿæˆçš„è¯ä¹¦å’Œç§˜é’¥æ–‡ä»¶ï¼ˆåç¼€åä¸º`.pem`ï¼‰æ‹·è´åˆ°æ‰€æœ‰æœºå™¨çš„ `/etc/kubernetes/ca` ç›®å½•ä¸‹å¤‡ç”¨ï¼›

```bash
# æœ€åæŸ¥çœ‹ç”Ÿæˆçš„è¯ä¹¦ç›®å½•
> ls /etc/kubernetes/ca
> admin  ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem  etcd  kube-proxy  apiserver
# åˆ†å‘è¯ä¹¦
scp -r /etc/kubernetes/ca root@å…¶ä»–èŠ‚ç‚¹ip:/etc/kubernetes/
```





## åã€å¯ç”¨ TLS Bootstrapping æœºåˆ¶

TLS Bootstrapingï¼šMaster apiserverå¯ç”¨TLSè®¤è¯åï¼ŒNodeèŠ‚ç‚¹kubeletå’Œkube-proxyè¦ä¸kube-apiserverè¿›è¡Œé€šä¿¡ï¼Œå¿…é¡»ä½¿ç”¨CAç­¾å‘çš„æœ‰æ•ˆè¯ä¹¦æ‰å¯ä»¥ï¼Œå½“NodeèŠ‚ç‚¹å¾ˆå¤šæ—¶ï¼Œè¿™ç§å®¢æˆ·ç«¯è¯ä¹¦é¢å‘éœ€è¦å¤§é‡å·¥ä½œï¼ŒåŒæ ·ä¹Ÿä¼šå¢åŠ é›†ç¾¤æ‰©å±•å¤æ‚åº¦ã€‚ä¸ºäº†ç®€åŒ–æµç¨‹ï¼ŒKuberneteså¼•å…¥äº†TLS bootstrapingæœºåˆ¶æ¥è‡ªåŠ¨é¢å‘å®¢æˆ·ç«¯è¯ä¹¦ï¼Œkubeletä¼šä»¥ä¸€ä¸ªä½æƒé™ç”¨æˆ·è‡ªåŠ¨å‘apiserverç”³è¯·è¯ä¹¦ï¼Œkubeletçš„è¯ä¹¦ç”±apiserveråŠ¨æ€ç­¾ç½²ã€‚æ‰€ä»¥å¼ºçƒˆå»ºè®®åœ¨Nodeä¸Šä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œç›®å‰ä¸»è¦ç”¨äºkubeletï¼Œkube-proxyè¿˜æ˜¯ç”±æˆ‘ä»¬ç»Ÿä¸€é¢å‘ä¸€ä¸ªè¯ä¹¦ã€‚

**TLS bootstraping å·¥ä½œæµç¨‹ï¼š**

<img src="https://media.zenghr.cn/blog/img/TLS bootstraping å·¥ä½œæµç¨‹.png" alt="TLSbootstrapingå·¥ä½œæµç¨‹" style="zoom:67%;" />

### 10.1 ç”Ÿæˆtokenè®¤è¯æ–‡ä»¶

```bash
# ç”Ÿæˆéšæœºtoken
head -c 16 /dev/urandom | od -An -t x | tr -d ' '
# æŒ‰ç…§å›ºå®šæ ¼å¼å†™å…¥token.csvï¼Œæ³¨æ„æ›¿æ¢tokenå†…å®¹
echo "734883758a7159caba1d9501c22f1408,kubelet-bootstrap,10001,\"system:kubelet-bootstrap\"" > /etc/kubernetes/ca/server/token.csv
```

