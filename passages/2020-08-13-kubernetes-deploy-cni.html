<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>部署CNI网络 | Zenghr</title>
    <meta name="generator" content="VuePress 1.9.7">
    <script type="text/javascript" src="/scripts/baidu-analytics.js" async=""></script>
    <link rel="icon" href="/favicon.ico">
    <link rel="manifest" href="/manifest.json">
    <meta name="description" content="kubernetes 要求集群内各节点(包括 master 节点)能通过 Pod 网段互联互通">
    <meta name="image" content="https://media.zenghr.cn/blog/img/20200813/qUxtPP.png">
    <meta name="twitter:title" content="部署CNI网络">
    <meta name="twitter:description" content="kubernetes 要求集群内各节点(包括 master 节点)能通过 Pod 网段互联互通">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://media.zenghr.cn/blog/img/20200813/qUxtPP.png">
    <meta name="twitter:url" content="https://blog.zenghr.cn/passages/2020-08-13-kubernetes-deploy-cni.html">
    <meta property="og:type" content="article">
    <meta property="og:title" content="部署CNI网络">
    <meta property="og:description" content="kubernetes 要求集群内各节点(包括 master 节点)能通过 Pod 网段互联互通">
    <meta property="og:image" content="https://media.zenghr.cn/blog/img/20200813/qUxtPP.png">
    <meta property="og:url" content="https://blog.zenghr.cn/passages/2020-08-13-kubernetes-deploy-cni.html">
    <meta property="article:author" content="zenghr">
    <meta property="article:published_time" content="2020-08-13 07:12">
    <meta itemprop="name" content="部署CNI网络">
    <meta itemprop="description" content="kubernetes 要求集群内各节点(包括 master 节点)能通过 Pod 网段互联互通">
    <meta itemprop="image" content="https://media.zenghr.cn/blog/img/20200813/qUxtPP.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="google-site-verification" content="YaZkTUj_yooTpG-N5B8hieXvHDRpHs7xfqTLvGl6nHs">
    
    <link rel="preload" href="/assets/css/0.styles.40e6d409.css" as="style"><link rel="preload" href="/assets/js/app.61497e9b.js" as="script"><link rel="preload" href="/assets/js/2.3bcbf9c7.js" as="script"><link rel="preload" href="/assets/js/4.6ca913cf.js" as="script"><link rel="preload" href="/assets/js/48.e4b6da20.js" as="script"><link rel="preload" href="/assets/js/5.df73da89.js" as="script"><link rel="prefetch" href="/assets/js/10.04153bc9.js"><link rel="prefetch" href="/assets/js/11.2608d821.js"><link rel="prefetch" href="/assets/js/12.0daeaa9b.js"><link rel="prefetch" href="/assets/js/13.d4603cae.js"><link rel="prefetch" href="/assets/js/14.30263e34.js"><link rel="prefetch" href="/assets/js/15.f9ad01e5.js"><link rel="prefetch" href="/assets/js/16.373121db.js"><link rel="prefetch" href="/assets/js/17.002f322b.js"><link rel="prefetch" href="/assets/js/18.cbced4fe.js"><link rel="prefetch" href="/assets/js/19.db5ad804.js"><link rel="prefetch" href="/assets/js/20.9c9513c7.js"><link rel="prefetch" href="/assets/js/21.ac7e1cf3.js"><link rel="prefetch" href="/assets/js/22.98d19f1a.js"><link rel="prefetch" href="/assets/js/23.81f244b7.js"><link rel="prefetch" href="/assets/js/24.1750ff92.js"><link rel="prefetch" href="/assets/js/25.3c622977.js"><link rel="prefetch" href="/assets/js/26.96fc3699.js"><link rel="prefetch" href="/assets/js/27.7c9e5429.js"><link rel="prefetch" href="/assets/js/28.d7c941a5.js"><link rel="prefetch" href="/assets/js/29.52dbf6fa.js"><link rel="prefetch" href="/assets/js/3.5ded679c.js"><link rel="prefetch" href="/assets/js/30.46dc896c.js"><link rel="prefetch" href="/assets/js/31.001750af.js"><link rel="prefetch" href="/assets/js/32.63a5326c.js"><link rel="prefetch" href="/assets/js/33.71a3cc0a.js"><link rel="prefetch" href="/assets/js/34.56944fe3.js"><link rel="prefetch" href="/assets/js/35.efb1f471.js"><link rel="prefetch" href="/assets/js/36.ccec69fe.js"><link rel="prefetch" href="/assets/js/37.2926ec61.js"><link rel="prefetch" href="/assets/js/38.660b4175.js"><link rel="prefetch" href="/assets/js/39.8e208f76.js"><link rel="prefetch" href="/assets/js/40.61b8034e.js"><link rel="prefetch" href="/assets/js/41.beac8270.js"><link rel="prefetch" href="/assets/js/42.fd79480a.js"><link rel="prefetch" href="/assets/js/43.070ef247.js"><link rel="prefetch" href="/assets/js/44.90098dd8.js"><link rel="prefetch" href="/assets/js/45.fb7f04d9.js"><link rel="prefetch" href="/assets/js/46.9f5c61eb.js"><link rel="prefetch" href="/assets/js/47.5150f37e.js"><link rel="prefetch" href="/assets/js/49.4f1ba364.js"><link rel="prefetch" href="/assets/js/50.3b48478e.js"><link rel="prefetch" href="/assets/js/51.61dd55c8.js"><link rel="prefetch" href="/assets/js/52.5feca2c2.js"><link rel="prefetch" href="/assets/js/53.5ae3f14e.js"><link rel="prefetch" href="/assets/js/54.1f5e32a5.js"><link rel="prefetch" href="/assets/js/55.6fb4760b.js"><link rel="prefetch" href="/assets/js/56.50b28b75.js"><link rel="prefetch" href="/assets/js/57.67574ed0.js"><link rel="prefetch" href="/assets/js/58.4fbf7cf1.js"><link rel="prefetch" href="/assets/js/59.ff6daca7.js"><link rel="prefetch" href="/assets/js/6.eaefe7ba.js"><link rel="prefetch" href="/assets/js/60.902afb3d.js"><link rel="prefetch" href="/assets/js/61.89357986.js"><link rel="prefetch" href="/assets/js/62.e4d4b952.js"><link rel="prefetch" href="/assets/js/63.5909108c.js"><link rel="prefetch" href="/assets/js/64.0a252c1f.js"><link rel="prefetch" href="/assets/js/65.f24ea9a7.js"><link rel="prefetch" href="/assets/js/66.8291859c.js"><link rel="prefetch" href="/assets/js/67.7403743f.js"><link rel="prefetch" href="/assets/js/68.bee74822.js"><link rel="prefetch" href="/assets/js/69.87dda0ad.js"><link rel="prefetch" href="/assets/js/7.944d5a58.js"><link rel="prefetch" href="/assets/js/70.d0c54e2e.js"><link rel="prefetch" href="/assets/js/71.6eaec73e.js"><link rel="prefetch" href="/assets/js/72.31c0d947.js"><link rel="prefetch" href="/assets/js/73.c19147ed.js"><link rel="prefetch" href="/assets/js/74.1e8dc310.js"><link rel="prefetch" href="/assets/js/75.05f42dff.js"><link rel="prefetch" href="/assets/js/76.4ccb0e6f.js"><link rel="prefetch" href="/assets/js/77.12d8c7e4.js"><link rel="prefetch" href="/assets/js/78.826a2622.js"><link rel="prefetch" href="/assets/js/79.26a4eed7.js"><link rel="prefetch" href="/assets/js/8.5d7c5743.js"><link rel="prefetch" href="/assets/js/80.f9e49a14.js"><link rel="prefetch" href="/assets/js/81.4b6741de.js"><link rel="prefetch" href="/assets/js/82.718be8a0.js"><link rel="prefetch" href="/assets/js/83.fd6a7f32.js"><link rel="prefetch" href="/assets/js/84.001574eb.js"><link rel="prefetch" href="/assets/js/85.d1bdde68.js"><link rel="prefetch" href="/assets/js/9.fc00dd7a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.40e6d409.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Zenghr</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/guide/" class="nav-link">
  最新
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java 基础与面向对象</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/passages/2021-04-09-java-lan-basic.html" class="nav-link">
  Java 基础知识
</a></li><li class="dropdown-subitem"><a href="/passages/2021-04-09-java-basic-oop.html" class="nav-link">
  Java 面向对象
</a></li></ul></li><li class="dropdown-item"><h4>Java进阶 - 集合框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/passages/2021-04-25-java-collection-frame.html" class="nav-link">
  Java 集合框架
</a></li></ul></li><li class="dropdown-item"><h4>Java进阶 - IO框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/passages/2021-05-05-java-io-basic.html" class="nav-link">
  Java I/O知识详解
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><span class="title">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/passages/2021-07-21-activiti7-note.html" class="nav-link">
  Activity7 系列
</a></li><li class="dropdown-item"><!----> <a href="/passages/2021-08-18-springboot-argument-resolver.html" class="nav-link">
  SpringBoot 系列
</a></li><li class="dropdown-item"><!----> <a href="/passages/2021-07-27-spring-cloud-alibaba.html" class="nav-link">
  Spring Cloud 基础
</a></li></ul></div></div><div class="nav-item"><a href="/passages/go-catalog.html" class="nav-link">
  Golang
</a></div><div class="nav-item"><a href="/passages/2020-08-12-kubernetes-deploy-ready.html" class="nav-link">
  Kubernetes
</a></div><div class="nav-item"><a href="/passages/2020-02-25-nginx-install.html" class="nav-link">
  Linux系列
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发环境" class="dropdown-title"><span class="title">开发环境</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/passages/tool-list-overview.html" class="nav-link">
  开发工具
</a></li><li class="dropdown-item"><!----> <a href="/passages/2021-06-28-git-common-cmd.html" class="nav-link">
  git 环境
</a></li><li class="dropdown-item"><h4>数据库系列</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/passages/2021-06-29-mysql-manage-auth.html" class="nav-link">
  mysql 环境
</a></li><li class="dropdown-subitem"><a href="/passages/2021-08-02-redis-overview.html" class="nav-link">
  Redis 知识体系
</a></li><li class="dropdown-subitem"><a href="/passages/2021-08-15-mongo-overview.html" class="nav-link">
  Mongo 知识体系
</a></li><li class="dropdown-subitem"><a href="/passages/2021-08-06-elasticsearch.html" class="nav-link">
  Elasticsearch 知识体系
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发指南" class="dropdown-title"><span class="title">开发指南</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/passages/code-spec-alibaba.html" class="nav-link">
  代码规范
</a></li><li class="dropdown-item"><!----> <a href="/passages/dev-pattern-overview.html" class="nav-link">
  设计模式详解
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其它" class="dropdown-title"><span class="title">其它</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/passages/2020-01-18-first-blog.html" class="nav-link">
  生活闲谈
</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">
  友情链接
</a></li></ul></div></div> <a href="https://github.com/zenghr0820/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/guide/" class="nav-link">
  最新
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java 基础与面向对象</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/passages/2021-04-09-java-lan-basic.html" class="nav-link">
  Java 基础知识
</a></li><li class="dropdown-subitem"><a href="/passages/2021-04-09-java-basic-oop.html" class="nav-link">
  Java 面向对象
</a></li></ul></li><li class="dropdown-item"><h4>Java进阶 - 集合框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/passages/2021-04-25-java-collection-frame.html" class="nav-link">
  Java 集合框架
</a></li></ul></li><li class="dropdown-item"><h4>Java进阶 - IO框架</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/passages/2021-05-05-java-io-basic.html" class="nav-link">
  Java I/O知识详解
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><span class="title">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/passages/2021-07-21-activiti7-note.html" class="nav-link">
  Activity7 系列
</a></li><li class="dropdown-item"><!----> <a href="/passages/2021-08-18-springboot-argument-resolver.html" class="nav-link">
  SpringBoot 系列
</a></li><li class="dropdown-item"><!----> <a href="/passages/2021-07-27-spring-cloud-alibaba.html" class="nav-link">
  Spring Cloud 基础
</a></li></ul></div></div><div class="nav-item"><a href="/passages/go-catalog.html" class="nav-link">
  Golang
</a></div><div class="nav-item"><a href="/passages/2020-08-12-kubernetes-deploy-ready.html" class="nav-link">
  Kubernetes
</a></div><div class="nav-item"><a href="/passages/2020-02-25-nginx-install.html" class="nav-link">
  Linux系列
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发环境" class="dropdown-title"><span class="title">开发环境</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/passages/tool-list-overview.html" class="nav-link">
  开发工具
</a></li><li class="dropdown-item"><!----> <a href="/passages/2021-06-28-git-common-cmd.html" class="nav-link">
  git 环境
</a></li><li class="dropdown-item"><h4>数据库系列</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/passages/2021-06-29-mysql-manage-auth.html" class="nav-link">
  mysql 环境
</a></li><li class="dropdown-subitem"><a href="/passages/2021-08-02-redis-overview.html" class="nav-link">
  Redis 知识体系
</a></li><li class="dropdown-subitem"><a href="/passages/2021-08-15-mongo-overview.html" class="nav-link">
  Mongo 知识体系
</a></li><li class="dropdown-subitem"><a href="/passages/2021-08-06-elasticsearch.html" class="nav-link">
  Elasticsearch 知识体系
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发指南" class="dropdown-title"><span class="title">开发指南</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/passages/code-spec-alibaba.html" class="nav-link">
  代码规范
</a></li><li class="dropdown-item"><!----> <a href="/passages/dev-pattern-overview.html" class="nav-link">
  设计模式详解
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其它" class="dropdown-title"><span class="title">其它</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/passages/2020-01-18-first-blog.html" class="nav-link">
  生活闲谈
</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">
  友情链接
</a></li></ul></div></div> <a href="https://github.com/zenghr0820/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>kubernetes</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/passages/2020-08-12-kubernetes-deploy-ready.html" class="sidebar-link">在Ubuntu上部署kubernetes集群</a></li><li><a href="/passages/2020-08-12-kubernetes-generate-tls.html" class="sidebar-link">创建TLS证书和秘钥</a></li><li><a href="/passages/2020-08-12-kubernetes-deploy-etcd.html" class="sidebar-link">部署etcd节点</a></li><li><a href="/passages/2020-08-12-kubernetes-deploy-master.html" class="sidebar-link">部署Master节点</a></li><li><a href="/passages/2020-08-13-kubernetes-deploy-worker.html" class="sidebar-link">部署Node节点</a></li><li><a href="/passages/2020-08-13-kubernetes-deploy-cni.html" aria-current="page" class="active sidebar-link">部署CNI网络</a></li><li><a href="/passages/2020-08-13-kubernetes-deploy-dns.html" class="sidebar-link">部署Dashboard和CoreDNS</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="部署cni网络"><a href="#部署cni网络" class="header-anchor">#</a> 部署CNI网络</h1> <h2 id="_1-简介"><a href="#_1-简介" class="header-anchor">#</a> 1.简介</h2> <blockquote><p>kubernetes 要求集群内各节点(包括 master 节点)能通过 Pod 网段互联互通</p></blockquote> <p>通过给 Kubelet 传递 <code>--network-plugin=cni</code> 命令行选项来选择 CNI 插件。 Kubelet 从 <code>--cni-conf-dir</code> （默认是 <code>/etc/cni/net.d</code>） 读取文件并使用该文件中的 CNI 配置来设置每个 pod 的网络。 CNI 配置文件必须与 <a href="https://github.com/containernetworking/cni/blob/master/SPEC.md#network-configuration" target="_blank" rel="noopener noreferrer">CNI 规约<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>匹配，并且配置引用的任何所需的 CNI 插件都必须存在于 <code>--cni-bin-dir</code>（默认是 <code>/opt/cni/bin</code>）</p> <p></p><div class="table-of-contents"><ul><li><a href="#部署cni网络">部署CNI网络</a><ul><li><a href="#_1-简介">1.简介</a></li><li><a href="#_2-下载-cni">2. 下载 CNI</a></li><li><a href="#_3-flannel-插件">3. flannel 插件</a><ul><li><a href="#_3-1-flannel介绍">3.1 Flannel介绍</a></li><li><a href="#_3-2-部署flannel">3.2 部署flannel</a></li></ul></li><li><a href="#_4-calico-插件">4. Calico 插件</a><ul><li><a href="#_4-1-calco组件简介">4.1 Calco组件简介</a></li><li><a href="#_4-2-calico-架构">4.2 Calico 架构</a></li><li><a href="#_4-3-calico-部署步骤过程">4.3 Calico 部署步骤过程</a></li><li><a href="#_4-4-部署-calico">4.4 部署 calico</a></li></ul></li><li><a href="#_5-通过系统服务-docker方式部署">5. 通过系统服务+Docker方式部署</a><ul><li><a href="#_5-1-配置-service-文件">5.1 配置 service 文件</a></li><li><a href="#_5-2-启动-kube-calico-服务">5.2 启动 kube-calico 服务</a></li><li><a href="#_5-3-calico-客户端工具-calicoctl">5.3 calico 客户端工具 calicoctl</a></li><li><a href="#_5-4-查看节点运行情况">5.4 查看节点运行情况</a></li><li><a href="#_5-5-配置-ip-pool">5.5 配置 IP Pool</a></li></ul></li><li><a href="#_6-授权apiserver访问kubelet">6. 授权Apiserver访问kubelet</a></li></ul></li></ul></div><p></p> <h2 id="_2-下载-cni"><a href="#_2-下载-cni" class="header-anchor">#</a> 2. 下载 CNI</h2> <p>准备二进制文件</p> <p>下载地址：<a href="https://github.com/containernetworking/plugins/releases" target="_blank" rel="noopener noreferrer">https://github.com/containernetworking/plugins/releases<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>解压二进制包并移动到默认工作目录：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">mkdir</span> -p /opt/cni/bin
<span class="token function">tar</span> zxvf cni-plugins-linux-amd64-v0.8.6.tgz -C /opt/cni/bin
</code></pre></div><h2 id="_3-flannel-插件"><a href="#_3-flannel-插件" class="header-anchor">#</a> 3. flannel 插件</h2> <h3 id="_3-1-flannel介绍"><a href="#_3-1-flannel介绍" class="header-anchor">#</a> 3.1 Flannel介绍</h3> <blockquote><p>以下内容转载自：<a href="https://www.cnblogs.com/itzgr/p/12558767.html#_label0" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/itzgr/p/12558767.html#_label0<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>Kubernetes的网络模型假定了所有Pod都在一个可以直接连通的扁平网络空间中。若需要实现这个网络假设，需要实现不同节点上的Docker容器之间的互相访问，然后运行Kubernetes。目前已经有多个开源组件支持容器网络模型。如Flannel、Open vSwitch、直接路由和Calico。</p> <p>Flannel之所以可以搭建Kubernetes依赖的底层网络，是因为它能实现以下两点。</p> <ol><li>它能协助Kubernetes，给每一个Node上的Docker容器都分配互相不冲突的IP地址。</li> <li>它能在这些IP地址之间建立一个覆盖网络（Overlay Network），通过这个覆盖网络，将数据包原封不动地传递到目标容器内。</li></ol> <p><strong>Flannel 架构图：</strong></p> <img src="https://media.zenghr.cn/blog/img/Flannel架构图.png" alt="Flannel架构图" style="zoom:75%;"> <p>如上图所示，Flannel首先创建了一个名为 <code>flannel0</code> 的网桥，而且这个网桥的一端连接 <code>docker0</code> 网桥，另一端连接一个叫作flanneld的服务进程。</p> <p>flanneld进程上连etcd，利用etcd来管理可分配的IP地址段资源，同时监控etcd中每个Pod的实际地址，并在内存中建立了一个Pod节点路由表；</p> <p>​	flanneld进程下连docker0和物理网络，使用内存中的Pod节点路由表，将docker0发给它的数据包包装起来，利用物理网络的连接将数据包投递到目标flanneld上，从而完成Pod到Pod之间的直接地址通信。</p> <p>​	Flannel之间的底层通信协议的可选技术包括UDP、VxLan、AWS VPC等多种方式。通过源flanneld封包、目标flanneld解包，最终docker0收到的就是原始的数据，对容器应用来说是透明的，感觉不到中间Flannel的存在。</p> <p>​	Flannel每次分配的地址段都在同一个公共区域获取，从而实现不同Node上的Pod分配的IP不产生冲突。而且在Flannel分配好地址段后，其余操作由Docker完成的，Flannel通过修改Docker的启动参数将分配给它的地址段传递进去：</p> <p>--bip=172.17.18.1/24</p> <p>通过如上方式，Flannel就控制了每个Node上的docker0地址段的地址，从而保障了所有Pod的IP地址在同一个水平网络中且不产生冲突。</p> <p>​	Flannel完美地实现了对Kubernetes网络的支持，但是它引入了多个网络组件，在网络通信时需要转到flannel0网络接口，再转到用户态的flanneld程序，到对端后还需要走这个过程的反过程，所以也会引入一些网络的时延损耗。</p> <p>另外，Flannel模型默认采用了UDP作为底层传输协议，UDP本身是非可靠协议，虽然两端的TCP实现了可靠传输，但在大流量、高并发的应用场景下还建议多次测试。</p> <h3 id="_3-2-部署flannel"><a href="#_3-2-部署flannel" class="header-anchor">#</a> 3.2 部署flannel</h3> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># github 上的文件，可能会下载失败，可以本地下载上传至虚拟机</span>
<span class="token function">wget</span> https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
<span class="token comment"># 替换 docker 源</span>
<span class="token function">sed</span> -i -r <span class="token string">&quot;s#quay.io/coreos/flannel:.*-amd64#registry.cn-shanghai.aliyuncs.com/gcr-k8s/flannel:v0.12.0-amd64#g&quot;</span> kube-flannel.yml
<span class="token comment"># 修改ip配置要与 kube-controller 配置中的 cluster-cidr=172.20.0.0/16 一样</span>
net-conf.json: <span class="token operator">|</span>
<span class="token punctuation">{</span>
	<span class="token string">&quot;Network&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;172.20.0.0/16&quot;</span>,
	<span class="token string">&quot;Backend&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
		<span class="token string">&quot;Type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;vxlan&quot;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment"># 启动</span>
kubectl apply -f kube-flannel.yml
<span class="token comment"># 查看</span>
kubectl get pods --namespace kube-system
kubectl get svc --namespace kube-system
</code></pre></div><div class="custom-block tip"><p>注：如果Node有多个网卡的话，参考 <a href="https://github.com/kubernetes/kubernetes/issues/39701" target="_blank" rel="noopener noreferrer">flannel issues39701<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>， 目前需要在kube-flannel.yml中使用--iface参数指定集群主机内网网卡的名称， 否则可能会出现dns无法解析。容器无法通信的情况，需要将kube-flannel.yml下载到本地， flanneld启动参数加上--iface=iface-name</p></div> <h2 id="_4-calico-插件"><a href="#_4-calico-插件" class="header-anchor">#</a> 4. Calico 插件</h2> <h3 id="_4-1-calco组件简介"><a href="#_4-1-calco组件简介" class="header-anchor">#</a> 4.1 Calco组件简介</h3> <p>​	Calico是一个基于BGP的纯三层的网络方案，与OpenStack、Kubernetes、AWS、GCE等云平台都能够良好地集成。Calico在每个计算节点都利用Linux Kernel实现了一个高效的vRouter来负责数据转发。每个vRouter都通过BGP1协议把在本节点上运行的容器的路由信息向整个Calico网络广播，并自动设置到达其他节点的路由转发规则。</p> <p>​	Calico保证所有容器之间的数据流量都是通过IP路由的方式完成互联互通的。Calico节点组网时可以直接利用数据中心的网络结构（L2或者L3），不需要额外的NAT、隧道或者Overlay Network，没有额外的封包解包，能够节约CPU运算，提高网络效率。</p> <p><img src="https://media.zenghr.cn/blog/img/20200813/qUxtPP.png" alt="qUxtPP"></p> <h3 id="_4-2-calico-架构"><a href="#_4-2-calico-架构" class="header-anchor">#</a> 4.2 Calico 架构</h3> <p><img src="https://media.zenghr.cn/blog/img/20200813/0IZcpm.png" alt="0IZcpm"></p> <p>Calico的主要组件：</p> <ul><li>Felix：Calico Agent，运行在每个Node上，负责为容器设置网络资源（IP地址、路由规则、iptables规则等），保证跨主机容器网络互通。</li> <li>etcd：Calico使用的后端存储。</li> <li>BGP Client：负责把Felix在各Node上设置的路由信息通过BGP协议广播到Calico网络。</li> <li>Route Reflector：通过一个或者多个BGP Route Reflector来完成大规模集群的分级路由分发。</li> <li>CalicoCtl：Calico命令行管理工具。</li></ul> <h3 id="_4-3-calico-部署步骤过程"><a href="#_4-3-calico-部署步骤过程" class="header-anchor">#</a> 4.3 Calico 部署步骤过程</h3> <p>在Kubernetes中部署Calico的主要步骤如下：</p> <ol><li>修改Kubernetes服务的启动参数，并重启服务。</li></ol> <ul><li><ol><li>设置Master上kube-apiserver服务的启动参数：<code>--allow-privileged=true</code>（因为calico-node需要以特权模式运行在各Node上）。</li> <li>设置各Node上kubelet服务的启动参数：<code>--networkplugin=cni</code>（使用CNI网络插件）。</li></ol></li></ul> <ol><li>创建Calico服务，主要包括calico-node和calico policy controller。需要创建的资源对象如下：</li></ol> <ul><li><ol><li>创建ConfigMap calico-config，包含Calico所需的配置参数。</li> <li>创建Secret calico-etcd-secrets，用于使用TLS方式连接etcd。</li> <li>在每个Node上都运行calico/node容器，部署为DaemonSet。</li> <li>在每个Node上都安装Calico CNI二进制文件和网络配置参数（由install-cni容器完成）。</li> <li>部署一个名为calico/kube-policy-controller的Deployment，以对接Kubernetes集群中为Pod设置的Network Policy。</li></ol></li></ul> <h3 id="_4-4-部署-calico"><a href="#_4-4-部署-calico" class="header-anchor">#</a> 4.4 部署 calico</h3> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 下载 yaml 文件</span>
<span class="token function">wget</span> https://docs.projectcalico.org/v3.14/getting-started/kubernetes/installation/hosted/calico.yaml
<span class="token comment"># 修改 - name: CALICO_IPV4POOL_CIDR value: 172.20.0.0/16</span>
<span class="token function">sed</span> -i -e <span class="token string">&quot;s?192.168.0.0/16?172.20.0.0/16?g&quot;</span> canal.yaml
</code></pre></div><h4 id="_4-4-1-需要修改如下几处配置"><a href="#_4-4-1-需要修改如下几处配置" class="header-anchor">#</a> 4.4.1 需要修改如下几处配置：</h4> <p><strong>ConfigMap 配置修改</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">etcd_endpoints</span><span class="token punctuation">:</span> <span class="token string">&quot;http://192.168.10.102:2379&quot;</span>
  <span class="token key atrule">etcd_ca</span><span class="token punctuation">:</span> <span class="token string">&quot;/calico-secrets/etcd-ca&quot;</span>   <span class="token comment"># &quot;/calico-secrets/etcd-ca&quot;</span>
  <span class="token key atrule">etcd_cert</span><span class="token punctuation">:</span> <span class="token string">&quot;calico-secrets/etcd-cert&quot;</span> <span class="token comment"># &quot;/calico-secrets/etcd-cert&quot;</span>
  <span class="token key atrule">etcd_key</span><span class="token punctuation">:</span> <span class="token string">&quot;/calico-secrets/etcd-key&quot;</span>  <span class="token comment"># &quot;/calico-secrets/etcd-key&quot;</span>
  <span class="token key atrule">typha_service_name</span><span class="token punctuation">:</span> <span class="token string">&quot;none&quot;</span>
  <span class="token key atrule">calico_backend</span><span class="token punctuation">:</span> <span class="token string">&quot;bird&quot;</span>
</code></pre></div><p>对主要参数说明如下：</p> <ul><li>etcd_endpoints：Calico使用etcd来保存网络拓扑和状态，该参数指定etcd服务的地址，可手动设置。</li> <li>calico_backend：Calico的后端，默认为bird。</li> <li>cni_network_config：符合CNI规范的网络配置。其中 <code>type=calico</code> 表示kubelet将从 <code>/opt/cni/bin</code> 目录下搜索名为calico的可执行文件，并调用它来完成容器网络的设置。ipam中的 <code>type=calico-ipam</code> 表示kubelet将在 <code>/opt/cni/bin</code> 目录下搜索名为calico-ipam的可执行文件，用于完成容器IP地址的分配。</li></ul> <p><strong>修改 Pods 使用的 <code>IP 网段</code> , 配置文件默认使用 <code>192.168.0.0/16</code> 网段</strong></p> <p><strong>Secret 配置修改</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>etcd<span class="token punctuation">-</span>secrets
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token comment"># Example command for encoding a file contents: cat &lt;file&gt; | base64 -w 0</span>
  <span class="token comment"># 如果配置了TLS ，则需要设置相应的证书和密钥文件路径</span>
  <span class="token key atrule">etcd-key</span><span class="token punctuation">:</span> (cat /etc/kubernetes/ca/server/server<span class="token punctuation">-</span>key.pem <span class="token punctuation">|</span> base64 <span class="token punctuation">-</span>w 0) <span class="token comment"># 将输出结果填写在这</span>
  <span class="token key atrule">etcd-cert</span><span class="token punctuation">:</span> (cat /etc/kubernetes/ca/server/server.pem <span class="token punctuation">|</span> base64 <span class="token punctuation">-</span>w 0) <span class="token comment"># 将输出结果填写在这</span>
  <span class="token key atrule">etcd-ca</span><span class="token punctuation">:</span> (cat /etc/kubernetes/ca/ca.pem <span class="token punctuation">|</span> base64 <span class="token punctuation">-</span>w 0) <span class="token comment"># 将输出结果填写在这</span>
</code></pre></div><p><strong>DaemonSet 配置修改</strong>
添加网卡发现规则</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>node
    <span class="token key atrule">image</span><span class="token punctuation">:</span> calico/node<span class="token punctuation">:</span>v3.14.2
    <span class="token key atrule">env</span><span class="token punctuation">:</span>
      <span class="token comment"># .../</span>
      <span class="token comment"># Auto-detect the BGP IP address.</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> IP
        <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;autodetect&quot;</span>
      <span class="token comment"># Calico 模式设置</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CALICO_IPV4POOL_IPIP
        <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;Always&quot;</span>
      <span class="token comment"># 定义ipv4自动发现网卡规则 </span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> IP_AUTODETECTION_METHOD
        <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;interface=enp.*&quot;</span>
      <span class="token comment"># no effect. This should fall within `--cluster-cidr`.</span>
      <span class="token comment"># 需要修改此处，打开注释替换 pod ip</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CALICO_IPV4POOL_CIDR
        <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;172.20.0.0/16&quot;</span>
</code></pre></div><p>在该Pod中包括如下两个容器：</p> <ul><li>install-cni：在Node上安装CNI二进制文件到 <code>/opt/cni/bin</code> 目录下，并安装相应的网络配置文件到 <code>/etc/cni/net.d</code> 目录下，设置为initContainers并在运行完成后退出。</li> <li>calico-node：Calico服务程序，用于设置Pod的网络资源，保证Pod的网络与各Node互联互通。它还需要以hostNetwork模式运行，直接使用宿主机网络。</li></ul> <p>calico-node服务的主要参数如下。</p> <ul><li>CALICO_IPV4POOL_CIDR：Calico IPAM的IP地址池，Pod的IP地址将从该池中进行分配。</li> <li>CALICO_IPV4POOL_IPIP：是否启用IPIP模式。启用IPIP模式时，Calico将在Node上创建一个名为tunl0的虚拟隧道。</li> <li><code>IP_AUTODETECTION_METHOD</code>：获取Node IP地址的方式，默认使用第1个网络接口的IP地址，对于安装了多块网卡的Node，可以使用正则表达式选择正确的网卡，例如&quot;interface=eth.*&quot;表示选择名称以<code>eth</code>开头的网卡的IP地址。</li> <li>FELIX_IPV6SUPPORT：是否启用IPv6。</li> <li>FELIX_LOGSEVERITYSCREEN：日志级别。</li> <li>securityContext.privileged=true：以特权模式运行。</li></ul> <p>另外，如果启用RBAC权限控制，则可以设置ServiceAccount。</p> <p>IP Pool可以使用两种模式：BGP或IPIP。使用IPIP模式时，设置 <code>CALICO_IPV4POOL_IPIP=&quot;always&quot;</code> ，不使用IPIP模式时，设置<code>CALICO_IPV4POOL_IPIP=&quot;off&quot;</code> ，此时将使用BGP模式。</p> <p><strong>calico-kube-controllers解析配置</strong></p> <p>calico-kube-controllers容器，用于对接Kubernetes集群中为Pod设置的Network Policy</p> <p>如果启用RBAC权限控制，则可以设置ServiceAccount。用户在Kubernetes集群中设置了Pod的Network Policy之后，calicokube-controllers就会自动通知各Node上的calico-node服务，在宿主机上设置相应的iptables规则，完成Pod间网络访问策略的设置。</p> <h4 id="_4-4-2-修改完-yaml-文件-执行部署"><a href="#_4-4-2-修改完-yaml-文件-执行部署" class="header-anchor">#</a> 4.4.2 修改完 yaml 文件，执行部署</h4> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 部署</span>
kubectl apply -f calico.yaml
<span class="token comment"># 查看 calico pods</span>
kubectl  get pods -n kube-system
<span class="token comment"># 查看 node 是否正常，现在 node 服务正常了</span>
kubectl get <span class="token function">node</span>

NAME       			 STATUS   ROLES    AGE    VERSION
<span class="token number">192.168</span>.10.101   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   4d4h   v1.18.6
<span class="token number">192.168</span>.10.102   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   4d4h   v1.18.6

</code></pre></div><h2 id="_5-通过系统服务-docker方式部署"><a href="#_5-通过系统服务-docker方式部署" class="header-anchor">#</a> 5. 通过系统服务+Docker方式部署</h2> <h3 id="_5-1-配置-service-文件"><a href="#_5-1-配置-service-文件" class="header-anchor">#</a> 5.1 配置 service 文件</h3> <p><strong>vim /lib/systemd/system/kube-calico.service</strong></p> <blockquote><p>注意修改 IP 以及证书位置</p></blockquote> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>calico <span class="token function">node</span>
<span class="token assign-left variable">After</span><span class="token operator">=</span>docker.service
<span class="token assign-left variable">Requires</span><span class="token operator">=</span>docker.service
<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">User</span><span class="token operator">=</span>root
<span class="token assign-left variable">PermissionsStartOnly</span><span class="token operator">=</span>true
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/bin/docker run --net<span class="token operator">=</span>host --privileged --name<span class="token operator">=</span>calico-node <span class="token punctuation">\</span>
  -e <span class="token assign-left variable">ETCD_ENDPOINTS</span><span class="token operator">=</span>https://192.168.10.102:2379 <span class="token punctuation">\</span>
  -e <span class="token assign-left variable">ETCD_CA_CERT_FILE</span><span class="token operator">=</span>/etc/kubernetes/ca/ca.pem <span class="token punctuation">\</span>
  -e <span class="token assign-left variable">ETCD_CERT_FILE</span><span class="token operator">=</span>/etc/kubernetes/ca/calico/calico.pem <span class="token punctuation">\</span>
  -e <span class="token assign-left variable">ETCD_KEY_FILE</span><span class="token operator">=</span>/etc/kubernetes/ca/calico/calico-key.pem <span class="token punctuation">\</span>
  -e <span class="token assign-left variable">CALICO_LIBNETWORK_ENABLED</span><span class="token operator">=</span>true <span class="token punctuation">\</span>
  -e <span class="token assign-left variable">CALICO_NETWORKING_BACKEND</span><span class="token operator">=</span>bird <span class="token punctuation">\</span>
  -e <span class="token assign-left variable">CALICO_DISABLE_FILE_LOGGING</span><span class="token operator">=</span>true <span class="token punctuation">\</span>
  -e <span class="token assign-left variable">CALICO_IPV4POOL_CIDR</span><span class="token operator">=</span><span class="token number">172.20</span>.0.0/16 <span class="token punctuation">\</span>
  -e <span class="token assign-left variable">CALICO_IPV4POOL_IPIP</span><span class="token operator">=</span>off <span class="token punctuation">\</span>
  -e <span class="token assign-left variable">FELIX_DEFAULTENDPOINTTOHOSTACTION</span><span class="token operator">=</span>ACCEPT <span class="token punctuation">\</span>
  -e <span class="token assign-left variable">FELIX_IPV6SUPPORT</span><span class="token operator">=</span>false <span class="token punctuation">\</span>
  -e <span class="token assign-left variable">FELIX_LOGSEVERITYSCREEN</span><span class="token operator">=</span>info <span class="token punctuation">\</span>
  -e <span class="token assign-left variable">FELIX_IPINIPMTU</span><span class="token operator">=</span><span class="token number">1440</span> <span class="token punctuation">\</span>
  -e <span class="token assign-left variable">FELIX_HEALTHENABLED</span><span class="token operator">=</span>true <span class="token punctuation">\</span>
  -e <span class="token assign-left variable">IP</span><span class="token operator">=</span><span class="token number">192.168</span>.10.101 <span class="token punctuation">\</span>
  -v /etc/kubernetes/ca:/etc/kubernetes/ca <span class="token punctuation">\</span>
  -v /var/run/calico:/var/run/calico <span class="token punctuation">\</span>
  -v /lib/modules:/lib/modules <span class="token punctuation">\</span>
  -v /run/docker/plugins:/run/docker/plugins <span class="token punctuation">\</span>
  -v /var/run/docker.sock:/var/run/docker.sock <span class="token punctuation">\</span>
  -v /var/log/calico:/var/log/calico <span class="token punctuation">\</span>
  calico/node:v3.14.2
<span class="token assign-left variable">ExecStop</span><span class="token operator">=</span>/usr/bin/docker <span class="token function">rm</span> -f calico-node
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>always
<span class="token assign-left variable">RestartSec</span><span class="token operator">=</span><span class="token number">10</span>
<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre></div><h3 id="_5-2-启动-kube-calico-服务"><a href="#_5-2-启动-kube-calico-服务" class="header-anchor">#</a> 5.2 启动 kube-calico 服务</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>systemctl daemon-reload <span class="token comment"># 修改配置重启的时候用</span>
systemctl <span class="token builtin class-name">enable</span> kube-calico.service
<span class="token function">service</span> kube-calico start
<span class="token comment"># 查看日志</span>
journalctl -f -u kube-calico
</code></pre></div><h3 id="_5-3-calico-客户端工具-calicoctl"><a href="#_5-3-calico-客户端工具-calicoctl" class="header-anchor">#</a> 5.3 calico 客户端工具 calicoctl</h3> <p><strong>下载 calicoctl 二进制文件, 下载地址：<a href="https://github.com/projectcalico/calicoctl/releases" target="_blank" rel="noopener noreferrer">https://github.com/projectcalico/calicoctl/releases<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">chmod</span> <span class="token number">755</span> calicoctl
<span class="token function">mv</span> calicoctl /usr/local/bin/
</code></pre></div><h3 id="_5-4-查看节点运行情况"><a href="#_5-4-查看节点运行情况" class="header-anchor">#</a> 5.4 查看节点运行情况</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>calicoctl <span class="token function">node</span> status
Calico process is running.
IPv4 BGP status
+---------------+-------------------+-------+----------+-------------+
<span class="token operator">|</span> PEER ADDRESS  <span class="token operator">|</span>     PEER TYPE     <span class="token operator">|</span> STATE <span class="token operator">|</span>  SINCE   <span class="token operator">|</span>    INFO     <span class="token operator">|</span>
+---------------+-------------------+-------+----------+-------------+
<span class="token operator">|</span> <span class="token number">192.168</span>.10.101 <span class="token operator">|</span> node-to-node mesh <span class="token operator">|</span> up    <span class="token operator">|</span> <span class="token number">13</span>:13:13 <span class="token operator">|</span> Established <span class="token operator">|</span>
+---------------+-------------------+-------+----------+-------------+
IPv6 BGP status
No IPv6 peers found.
</code></pre></div><p><strong>查看端口BGP 协议是通过TCP 连接来建立邻居的，因此可以用netstat 命令验证 BGP Peer</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">netstat</span> -natp<span class="token operator">|</span><span class="token function">grep</span> ESTABLISHED<span class="token operator">|</span><span class="token function">grep</span> <span class="token number">179</span>
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">192.168</span>.10.102:60959     <span class="token number">192.168</span>.10.103:179       ESTABLISHED <span class="token number">29680</span>/bird
</code></pre></div><h3 id="_5-5-配置-ip-pool"><a href="#_5-5-配置-ip-pool" class="header-anchor">#</a> 5.5 配置 IP Pool</h3> <div class="custom-block tip"><p>注：请看官方配置文件：<a href="https://docs.projectcalico.org/getting-started/clis/calicoctl/configure/overview" target="_blank" rel="noopener noreferrer">https://docs.projectcalico.org/getting-started/clis/calicoctl/configure/overview<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <p>默认情况下，<code>calicoctl</code>将在上查找配置文件<code>/etc/calico/calicoctl.cfg</code>。您可以将该<code>--config</code>选项与需要数据存储访问的命令一起使用，以覆盖此选项。该文件可以是YAML或JSON格式。它必须有效并且可由读取<code>calicoctl</code>。以下是一个YAML示例：</p> <p><strong>vim /etc/calico/calicoctl.cfg</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> projectcalico.org/v3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CalicoAPIConfig
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">etcdEndpoints</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//192.168.10.102<span class="token punctuation">:</span><span class="token number">2379</span>
  <span class="token key atrule">etcdKeyFile</span><span class="token punctuation">:</span> /etc/kubernetes/ca/calico/calico<span class="token punctuation">-</span>key.pem
  <span class="token key atrule">etcdCertFile</span><span class="token punctuation">:</span> /etc/kubernetes/ca/calico/calico.pem
  <span class="token key atrule">etcdCACertFile</span><span class="token punctuation">:</span> /etc/kubernetes/ca/ca.pem
</code></pre></div><p><strong>查看集群ippool情况</strong></p> <p><strong>calicoctl get ipPool -o yaml</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># 输出内容如下</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> projectcalico.org/v3
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> IPPool
  <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
    <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token string">&quot;2020-08-14T10:38:44Z&quot;</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>ipv4<span class="token punctuation">-</span>ippool
    <span class="token key atrule">resourceVersion</span><span class="token punctuation">:</span> <span class="token string">&quot;13109&quot;</span>
    <span class="token key atrule">uid</span><span class="token punctuation">:</span> 3e3b1506<span class="token punctuation">-</span>e9a8<span class="token punctuation">-</span>4d02<span class="token punctuation">-</span>96f7<span class="token punctuation">-</span>2ceb63ade2ea
  <span class="token key atrule">spec</span><span class="token punctuation">:</span>
    <span class="token key atrule">blockSize</span><span class="token punctuation">:</span> <span class="token number">26</span>
    <span class="token key atrule">cidr</span><span class="token punctuation">:</span> 172.20.0.0/16
    <span class="token key atrule">ipipMode</span><span class="token punctuation">:</span> Never
    <span class="token key atrule">natOutgoing</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span> all()
    <span class="token key atrule">vxlanMode</span><span class="token punctuation">:</span> Never
<span class="token key atrule">kind</span><span class="token punctuation">:</span> IPPoolList
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">resourceVersion</span><span class="token punctuation">:</span> <span class="token string">&quot;57796&quot;</span>
</code></pre></div><h2 id="_6-授权apiserver访问kubelet"><a href="#_6-授权apiserver访问kubelet" class="header-anchor">#</a> 6. 授权Apiserver访问kubelet</h2> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/kubernetes/server/cfg/apiserver-to-kubelet-rbac.yaml <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: system:kube-apiserver-to-kubelet
rules:
  - apiGroups:
      - &quot;&quot;
    resources:
      - nodes/proxy
      - nodes/stats
      - nodes/log
      - nodes/spec
      - nodes/metrics
      - pods/log
    verbs:
      - &quot;*&quot;
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: system:kube-apiserver
  namespace: &quot;&quot;
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:kube-apiserver-to-kubelet
subjects:
  - apiGroup: rbac.authorization.k8s.io
    kind: User
    name: kubernetes
EOF</span>

<span class="token comment">#  启动</span>
kubectl apply -f apiserver-to-kubelet-rbac.yaml
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/zenghr0820/blog/edit/master/docs/kubernetes/06.部署CNI网络.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">更新于:</span> <span class="time">2021-06-30 09:18:02</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/passages/2020-08-13-kubernetes-deploy-worker.html" class="prev">
        部署Node节点
      </a></span> <span class="next"><a href="/passages/2020-08-13-kubernetes-deploy-dns.html">
        部署Dashboard和CoreDNS
      </a>
      →
    </span></p></div> <aside class="page-sidebar"><div class="page-side-toolbar"><div class="option-box-toc-fixed"><div class="toc-container-sidebar"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:650px"><div style="font-weight:bold;text-align:center;">部署CNI网络</div> <hr> <div class="toc-box"><ul class="toc-sidebar-links"><li><a href="/passages/2020-08-13-kubernetes-deploy-cni.html#_1-简介" class="toc-sidebar-link">1.简介</a> <ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/passages/2020-08-13-kubernetes-deploy-cni.html#_2-下载-cni" class="toc-sidebar-link">2. 下载 CNI</a> <ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/passages/2020-08-13-kubernetes-deploy-cni.html#_3-flannel-插件" class="toc-sidebar-link">3. flannel 插件</a> <ul class="toc-sidebar-sub-headers"><li><a href="/passages/2020-08-13-kubernetes-deploy-cni.html#_3-1-flannel介绍" class="toc-sidebar-link">3.1 Flannel介绍</a></li><li><a href="/passages/2020-08-13-kubernetes-deploy-cni.html#_3-2-部署flannel" class="toc-sidebar-link">3.2 部署flannel</a></li></ul></li><li><a href="/passages/2020-08-13-kubernetes-deploy-cni.html#_4-calico-插件" class="toc-sidebar-link">4. Calico 插件</a> <ul class="toc-sidebar-sub-headers"><li><a href="/passages/2020-08-13-kubernetes-deploy-cni.html#_4-1-calco组件简介" class="toc-sidebar-link">4.1 Calco组件简介</a></li><li><a href="/passages/2020-08-13-kubernetes-deploy-cni.html#_4-2-calico-架构" class="toc-sidebar-link">4.2 Calico 架构</a></li><li><a href="/passages/2020-08-13-kubernetes-deploy-cni.html#_4-3-calico-部署步骤过程" class="toc-sidebar-link">4.3 Calico 部署步骤过程</a></li><li><a href="/passages/2020-08-13-kubernetes-deploy-cni.html#_4-4-部署-calico" class="toc-sidebar-link">4.4 部署 calico</a></li></ul></li><li><a href="/passages/2020-08-13-kubernetes-deploy-cni.html#_5-通过系统服务-docker方式部署" class="toc-sidebar-link">5. 通过系统服务+Docker方式部署</a> <ul class="toc-sidebar-sub-headers"><li><a href="/passages/2020-08-13-kubernetes-deploy-cni.html#_5-1-配置-service-文件" class="toc-sidebar-link">5.1 配置 service 文件</a></li><li><a href="/passages/2020-08-13-kubernetes-deploy-cni.html#_5-2-启动-kube-calico-服务" class="toc-sidebar-link">5.2 启动 kube-calico 服务</a></li><li><a href="/passages/2020-08-13-kubernetes-deploy-cni.html#_5-3-calico-客户端工具-calicoctl" class="toc-sidebar-link">5.3 calico 客户端工具 calicoctl</a></li><li><a href="/passages/2020-08-13-kubernetes-deploy-cni.html#_5-4-查看节点运行情况" class="toc-sidebar-link">5.4 查看节点运行情况</a></li><li><a href="/passages/2020-08-13-kubernetes-deploy-cni.html#_5-5-配置-ip-pool" class="toc-sidebar-link">5.5 配置 IP Pool</a></li></ul></li><li><a href="/passages/2020-08-13-kubernetes-deploy-cni.html#_6-授权apiserver访问kubelet" class="toc-sidebar-link">6. 授权Apiserver访问kubelet</a> <ul class="toc-sidebar-sub-headers"></ul></li></ul></div></div></div></div></div> <div class="option-box option-box-toc-over"><img src="/toc.png" class="nozoom" style="pointer-events: none; width: 20px"> <span class="show-txt">目录</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:550px"><div style="font-weight:bold;text-align:center;">部署CNI网络</div> <hr> <div class="toc-box"><ul class="toc-sidebar-links"><li><a href="/passages/2020-08-13-kubernetes-deploy-cni.html#_1-简介" class="toc-sidebar-link">1.简介</a> <ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/passages/2020-08-13-kubernetes-deploy-cni.html#_2-下载-cni" class="toc-sidebar-link">2. 下载 CNI</a> <ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/passages/2020-08-13-kubernetes-deploy-cni.html#_3-flannel-插件" class="toc-sidebar-link">3. flannel 插件</a> <ul class="toc-sidebar-sub-headers"><li><a href="/passages/2020-08-13-kubernetes-deploy-cni.html#_3-1-flannel介绍" class="toc-sidebar-link">3.1 Flannel介绍</a></li><li><a href="/passages/2020-08-13-kubernetes-deploy-cni.html#_3-2-部署flannel" class="toc-sidebar-link">3.2 部署flannel</a></li></ul></li><li><a href="/passages/2020-08-13-kubernetes-deploy-cni.html#_4-calico-插件" class="toc-sidebar-link">4. Calico 插件</a> <ul class="toc-sidebar-sub-headers"><li><a href="/passages/2020-08-13-kubernetes-deploy-cni.html#_4-1-calco组件简介" class="toc-sidebar-link">4.1 Calco组件简介</a></li><li><a href="/passages/2020-08-13-kubernetes-deploy-cni.html#_4-2-calico-架构" class="toc-sidebar-link">4.2 Calico 架构</a></li><li><a href="/passages/2020-08-13-kubernetes-deploy-cni.html#_4-3-calico-部署步骤过程" class="toc-sidebar-link">4.3 Calico 部署步骤过程</a></li><li><a href="/passages/2020-08-13-kubernetes-deploy-cni.html#_4-4-部署-calico" class="toc-sidebar-link">4.4 部署 calico</a></li></ul></li><li><a href="/passages/2020-08-13-kubernetes-deploy-cni.html#_5-通过系统服务-docker方式部署" class="toc-sidebar-link">5. 通过系统服务+Docker方式部署</a> <ul class="toc-sidebar-sub-headers"><li><a href="/passages/2020-08-13-kubernetes-deploy-cni.html#_5-1-配置-service-文件" class="toc-sidebar-link">5.1 配置 service 文件</a></li><li><a href="/passages/2020-08-13-kubernetes-deploy-cni.html#_5-2-启动-kube-calico-服务" class="toc-sidebar-link">5.2 启动 kube-calico 服务</a></li><li><a href="/passages/2020-08-13-kubernetes-deploy-cni.html#_5-3-calico-客户端工具-calicoctl" class="toc-sidebar-link">5.3 calico 客户端工具 calicoctl</a></li><li><a href="/passages/2020-08-13-kubernetes-deploy-cni.html#_5-4-查看节点运行情况" class="toc-sidebar-link">5.4 查看节点运行情况</a></li><li><a href="/passages/2020-08-13-kubernetes-deploy-cni.html#_5-5-配置-ip-pool" class="toc-sidebar-link">5.5 配置 IP Pool</a></li></ul></li><li><a href="/passages/2020-08-13-kubernetes-deploy-cni.html#_6-授权apiserver访问kubelet" class="toc-sidebar-link">6. 授权Apiserver访问kubelet</a> <ul class="toc-sidebar-sub-headers"></ul></li></ul></div></div></div></div></div> <div class="option-box"><a title="点击切换全屏" style="text-align: center; padding-left: 2px;"><img src="/full.png" class="nozoom" style="pointer-events: none; width: 27px"> <span class="show-txt">全屏看</span></a></div><div class="option-box"><a title="点击切换全屏" style="text-align: center; padding-left: 2px;"><img src="/toggle.png" class="nozoom" style="pointer-events: none; width: 27px"> <span class="show-txt">侧边栏</span></a></div><div class="option-box"><img src="/iphone.png" class="nozoom" style="pointer-events: none; width: 20px"> <span class="show-txt">手机看</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:550px"><img height="180px" src="https://api.qrserver.com/v1/create-qr-code/?data=https://blog.zenghr.cn/passages/2020-08-13-kubernetes-deploy-cni.html" class="medium-zoom-image" style="margin: 10px;"></div></div></div></div><div class="option-box"><img src="/reward.png" class="nozoom" style="pointer-events: none; width: 20px"> <span class="show-txt">打赏</span> <div class="toc-container"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:550px"><img height="180px" src="/wechat.jpg" class="medium-zoom-image" style="margin: 10px;"></div></div></div></div><div class="option-box"><a title="部署Node节点" href="/passages/2020-08-13-kubernetes-deploy-worker.html" style="text-align: center; padding-left: 2px;"><img src="/prev.png" class="nozoom" style="pointer-events: none; width: 27px"> <span class="show-txt">上一篇</span></a></div><div class="option-box"><a title="部署Dashboard和CoreDNS" href="/passages/2020-08-13-kubernetes-deploy-dns.html" style="text-align: center; padding-left: 2px;"><img src="/next.png" class="nozoom" style="pointer-events: none; width: 27px"> <span class="show-txt">下一篇</span></a></div></div></aside> </main></div><div class="global-ui"><div class="my-loader center" style="display:none;" data-v-354e1a9e><div class="my-loader-circle" data-v-354e1a9e></div></div><div class="my-popup" style="display:none;" data-v-5f98aac3><div class="my-popup-container" data-v-5f98aac3><div class="my-popup-exit" data-v-5f98aac3></div> <img src="" alt data-v-5f98aac3></div></div><!----><!----><div></div><div class="container" data-v-0178ff65><canvas id="live2d" width="280" height="250" class="live2d-right" data-v-0178ff65></canvas></div></div></div>
    <script src="/assets/js/app.61497e9b.js" defer></script><script src="/assets/js/2.3bcbf9c7.js" defer></script><script src="/assets/js/4.6ca913cf.js" defer></script><script src="/assets/js/48.e4b6da20.js" defer></script><script src="/assets/js/5.df73da89.js" defer></script>
  </body>
</html>
