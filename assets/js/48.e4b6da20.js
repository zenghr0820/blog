(window.webpackJsonp=window.webpackJsonp||[]).push([[48],{375:function(t,a,s){"use strict";s.r(a);var e=s(2),n=Object(e.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"部署cni网络"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署cni网络"}},[t._v("#")]),t._v(" 部署CNI网络")]),t._v(" "),a("h2",{attrs:{id:"_1-简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-简介"}},[t._v("#")]),t._v(" 1.简介")]),t._v(" "),a("blockquote",[a("p",[t._v("kubernetes 要求集群内各节点(包括 master 节点)能通过 Pod 网段互联互通")])]),t._v(" "),a("p",[t._v("通过给 Kubelet 传递 "),a("code",[t._v("--network-plugin=cni")]),t._v(" 命令行选项来选择 CNI 插件。 Kubelet 从 "),a("code",[t._v("--cni-conf-dir")]),t._v(" （默认是 "),a("code",[t._v("/etc/cni/net.d")]),t._v("） 读取文件并使用该文件中的 CNI 配置来设置每个 pod 的网络。 CNI 配置文件必须与 "),a("a",{attrs:{href:"https://github.com/containernetworking/cni/blob/master/SPEC.md#network-configuration",target:"_blank",rel:"noopener noreferrer"}},[t._v("CNI 规约"),a("OutboundLink")],1),t._v("匹配，并且配置引用的任何所需的 CNI 插件都必须存在于 "),a("code",[t._v("--cni-bin-dir")]),t._v("（默认是 "),a("code",[t._v("/opt/cni/bin")]),t._v("）")]),t._v(" "),a("p"),a("div",{staticClass:"table-of-contents"},[a("ul",[a("li",[a("a",{attrs:{href:"#部署cni网络"}},[t._v("部署CNI网络")]),a("ul",[a("li",[a("a",{attrs:{href:"#_1-简介"}},[t._v("1.简介")])]),a("li",[a("a",{attrs:{href:"#_2-下载-cni"}},[t._v("2. 下载 CNI")])]),a("li",[a("a",{attrs:{href:"#_3-flannel-插件"}},[t._v("3. flannel 插件")]),a("ul",[a("li",[a("a",{attrs:{href:"#_3-1-flannel介绍"}},[t._v("3.1 Flannel介绍")])]),a("li",[a("a",{attrs:{href:"#_3-2-部署flannel"}},[t._v("3.2 部署flannel")])])])]),a("li",[a("a",{attrs:{href:"#_4-calico-插件"}},[t._v("4. Calico 插件")]),a("ul",[a("li",[a("a",{attrs:{href:"#_4-1-calco组件简介"}},[t._v("4.1 Calco组件简介")])]),a("li",[a("a",{attrs:{href:"#_4-2-calico-架构"}},[t._v("4.2 Calico 架构")])]),a("li",[a("a",{attrs:{href:"#_4-3-calico-部署步骤过程"}},[t._v("4.3 Calico 部署步骤过程")])]),a("li",[a("a",{attrs:{href:"#_4-4-部署-calico"}},[t._v("4.4 部署 calico")])])])]),a("li",[a("a",{attrs:{href:"#_5-通过系统服务-docker方式部署"}},[t._v("5. 通过系统服务+Docker方式部署")]),a("ul",[a("li",[a("a",{attrs:{href:"#_5-1-配置-service-文件"}},[t._v("5.1 配置 service 文件")])]),a("li",[a("a",{attrs:{href:"#_5-2-启动-kube-calico-服务"}},[t._v("5.2 启动 kube-calico 服务")])]),a("li",[a("a",{attrs:{href:"#_5-3-calico-客户端工具-calicoctl"}},[t._v("5.3 calico 客户端工具 calicoctl")])]),a("li",[a("a",{attrs:{href:"#_5-4-查看节点运行情况"}},[t._v("5.4 查看节点运行情况")])]),a("li",[a("a",{attrs:{href:"#_5-5-配置-ip-pool"}},[t._v("5.5 配置 IP Pool")])])])]),a("li",[a("a",{attrs:{href:"#_6-授权apiserver访问kubelet"}},[t._v("6. 授权Apiserver访问kubelet")])])])])])]),a("p"),t._v(" "),a("h2",{attrs:{id:"_2-下载-cni"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-下载-cni"}},[t._v("#")]),t._v(" 2. 下载 CNI")]),t._v(" "),a("p",[t._v("准备二进制文件")]),t._v(" "),a("p",[t._v("下载地址："),a("a",{attrs:{href:"https://github.com/containernetworking/plugins/releases",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/containernetworking/plugins/releases"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("解压二进制包并移动到默认工作目录：")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" -p /opt/cni/bin\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("tar")]),t._v(" zxvf cni-plugins-linux-amd64-v0.8.6.tgz -C /opt/cni/bin\n")])])]),a("h2",{attrs:{id:"_3-flannel-插件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-flannel-插件"}},[t._v("#")]),t._v(" 3. flannel 插件")]),t._v(" "),a("h3",{attrs:{id:"_3-1-flannel介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-flannel介绍"}},[t._v("#")]),t._v(" 3.1 Flannel介绍")]),t._v(" "),a("blockquote",[a("p",[t._v("以下内容转载自："),a("a",{attrs:{href:"https://www.cnblogs.com/itzgr/p/12558767.html#_label0",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://www.cnblogs.com/itzgr/p/12558767.html#_label0"),a("OutboundLink")],1)])]),t._v(" "),a("p",[t._v("Kubernetes的网络模型假定了所有Pod都在一个可以直接连通的扁平网络空间中。若需要实现这个网络假设，需要实现不同节点上的Docker容器之间的互相访问，然后运行Kubernetes。目前已经有多个开源组件支持容器网络模型。如Flannel、Open vSwitch、直接路由和Calico。")]),t._v(" "),a("p",[t._v("Flannel之所以可以搭建Kubernetes依赖的底层网络，是因为它能实现以下两点。")]),t._v(" "),a("ol",[a("li",[t._v("它能协助Kubernetes，给每一个Node上的Docker容器都分配互相不冲突的IP地址。")]),t._v(" "),a("li",[t._v("它能在这些IP地址之间建立一个覆盖网络（Overlay Network），通过这个覆盖网络，将数据包原封不动地传递到目标容器内。")])]),t._v(" "),a("p",[a("strong",[t._v("Flannel 架构图：")])]),t._v(" "),a("img",{staticStyle:{zoom:"75%"},attrs:{src:"https://media.zenghr.cn/blog/img/Flannel架构图.png",alt:"Flannel架构图"}}),t._v(" "),a("p",[t._v("如上图所示，Flannel首先创建了一个名为 "),a("code",[t._v("flannel0")]),t._v(" 的网桥，而且这个网桥的一端连接 "),a("code",[t._v("docker0")]),t._v(" 网桥，另一端连接一个叫作flanneld的服务进程。")]),t._v(" "),a("p",[t._v("flanneld进程上连etcd，利用etcd来管理可分配的IP地址段资源，同时监控etcd中每个Pod的实际地址，并在内存中建立了一个Pod节点路由表；")]),t._v(" "),a("p",[t._v("​\tflanneld进程下连docker0和物理网络，使用内存中的Pod节点路由表，将docker0发给它的数据包包装起来，利用物理网络的连接将数据包投递到目标flanneld上，从而完成Pod到Pod之间的直接地址通信。")]),t._v(" "),a("p",[t._v("​\tFlannel之间的底层通信协议的可选技术包括UDP、VxLan、AWS VPC等多种方式。通过源flanneld封包、目标flanneld解包，最终docker0收到的就是原始的数据，对容器应用来说是透明的，感觉不到中间Flannel的存在。")]),t._v(" "),a("p",[t._v("​\tFlannel每次分配的地址段都在同一个公共区域获取，从而实现不同Node上的Pod分配的IP不产生冲突。而且在Flannel分配好地址段后，其余操作由Docker完成的，Flannel通过修改Docker的启动参数将分配给它的地址段传递进去：")]),t._v(" "),a("p",[t._v("--bip=172.17.18.1/24")]),t._v(" "),a("p",[t._v("通过如上方式，Flannel就控制了每个Node上的docker0地址段的地址，从而保障了所有Pod的IP地址在同一个水平网络中且不产生冲突。")]),t._v(" "),a("p",[t._v("​\tFlannel完美地实现了对Kubernetes网络的支持，但是它引入了多个网络组件，在网络通信时需要转到flannel0网络接口，再转到用户态的flanneld程序，到对端后还需要走这个过程的反过程，所以也会引入一些网络的时延损耗。")]),t._v(" "),a("p",[t._v("另外，Flannel模型默认采用了UDP作为底层传输协议，UDP本身是非可靠协议，虽然两端的TCP实现了可靠传输，但在大流量、高并发的应用场景下还建议多次测试。")]),t._v(" "),a("h3",{attrs:{id:"_3-2-部署flannel"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-部署flannel"}},[t._v("#")]),t._v(" 3.2 部署flannel")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# github 上的文件，可能会下载失败，可以本地下载上传至虚拟机")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v(" https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 替换 docker 源")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sed")]),t._v(" -i -r "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"s#quay.io/coreos/flannel:.*-amd64#registry.cn-shanghai.aliyuncs.com/gcr-k8s/flannel:v0.12.0-amd64#g"')]),t._v(" kube-flannel.yml\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 修改ip配置要与 kube-controller 配置中的 cluster-cidr=172.20.0.0/16 一样")]),t._v("\nnet-conf.json: "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Network"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"172.20.0.0/16"')]),t._v(",\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Backend"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Type"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"vxlan"')]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 启动")]),t._v("\nkubectl apply -f kube-flannel.yml\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 查看")]),t._v("\nkubectl get pods --namespace kube-system\nkubectl get svc --namespace kube-system\n")])])]),a("div",{staticClass:"custom-block tip"},[a("p",[t._v("注：如果Node有多个网卡的话，参考 "),a("a",{attrs:{href:"https://github.com/kubernetes/kubernetes/issues/39701",target:"_blank",rel:"noopener noreferrer"}},[t._v("flannel issues39701"),a("OutboundLink")],1),t._v("， 目前需要在kube-flannel.yml中使用--iface参数指定集群主机内网网卡的名称， 否则可能会出现dns无法解析。容器无法通信的情况，需要将kube-flannel.yml下载到本地， flanneld启动参数加上--iface=iface-name")])]),t._v(" "),a("h2",{attrs:{id:"_4-calico-插件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-calico-插件"}},[t._v("#")]),t._v(" 4. Calico 插件")]),t._v(" "),a("h3",{attrs:{id:"_4-1-calco组件简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-calco组件简介"}},[t._v("#")]),t._v(" 4.1 Calco组件简介")]),t._v(" "),a("p",[t._v("​\tCalico是一个基于BGP的纯三层的网络方案，与OpenStack、Kubernetes、AWS、GCE等云平台都能够良好地集成。Calico在每个计算节点都利用Linux Kernel实现了一个高效的vRouter来负责数据转发。每个vRouter都通过BGP1协议把在本节点上运行的容器的路由信息向整个Calico网络广播，并自动设置到达其他节点的路由转发规则。")]),t._v(" "),a("p",[t._v("​\tCalico保证所有容器之间的数据流量都是通过IP路由的方式完成互联互通的。Calico节点组网时可以直接利用数据中心的网络结构（L2或者L3），不需要额外的NAT、隧道或者Overlay Network，没有额外的封包解包，能够节约CPU运算，提高网络效率。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://media.zenghr.cn/blog/img/20200813/qUxtPP.png",alt:"qUxtPP"}})]),t._v(" "),a("h3",{attrs:{id:"_4-2-calico-架构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-calico-架构"}},[t._v("#")]),t._v(" 4.2 Calico 架构")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://media.zenghr.cn/blog/img/20200813/0IZcpm.png",alt:"0IZcpm"}})]),t._v(" "),a("p",[t._v("Calico的主要组件：")]),t._v(" "),a("ul",[a("li",[t._v("Felix：Calico Agent，运行在每个Node上，负责为容器设置网络资源（IP地址、路由规则、iptables规则等），保证跨主机容器网络互通。")]),t._v(" "),a("li",[t._v("etcd：Calico使用的后端存储。")]),t._v(" "),a("li",[t._v("BGP Client：负责把Felix在各Node上设置的路由信息通过BGP协议广播到Calico网络。")]),t._v(" "),a("li",[t._v("Route Reflector：通过一个或者多个BGP Route Reflector来完成大规模集群的分级路由分发。")]),t._v(" "),a("li",[t._v("CalicoCtl：Calico命令行管理工具。")])]),t._v(" "),a("h3",{attrs:{id:"_4-3-calico-部署步骤过程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-calico-部署步骤过程"}},[t._v("#")]),t._v(" 4.3 Calico 部署步骤过程")]),t._v(" "),a("p",[t._v("在Kubernetes中部署Calico的主要步骤如下：")]),t._v(" "),a("ol",[a("li",[t._v("修改Kubernetes服务的启动参数，并重启服务。")])]),t._v(" "),a("ul",[a("li",[a("ol",[a("li",[t._v("设置Master上kube-apiserver服务的启动参数："),a("code",[t._v("--allow-privileged=true")]),t._v("（因为calico-node需要以特权模式运行在各Node上）。")]),t._v(" "),a("li",[t._v("设置各Node上kubelet服务的启动参数："),a("code",[t._v("--networkplugin=cni")]),t._v("（使用CNI网络插件）。")])])])]),t._v(" "),a("ol",[a("li",[t._v("创建Calico服务，主要包括calico-node和calico policy controller。需要创建的资源对象如下：")])]),t._v(" "),a("ul",[a("li",[a("ol",[a("li",[t._v("创建ConfigMap calico-config，包含Calico所需的配置参数。")]),t._v(" "),a("li",[t._v("创建Secret calico-etcd-secrets，用于使用TLS方式连接etcd。")]),t._v(" "),a("li",[t._v("在每个Node上都运行calico/node容器，部署为DaemonSet。")]),t._v(" "),a("li",[t._v("在每个Node上都安装Calico CNI二进制文件和网络配置参数（由install-cni容器完成）。")]),t._v(" "),a("li",[t._v("部署一个名为calico/kube-policy-controller的Deployment，以对接Kubernetes集群中为Pod设置的Network Policy。")])])])]),t._v(" "),a("h3",{attrs:{id:"_4-4-部署-calico"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-部署-calico"}},[t._v("#")]),t._v(" 4.4 部署 calico")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 下载 yaml 文件")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v(" https://docs.projectcalico.org/v3.14/getting-started/kubernetes/installation/hosted/calico.yaml\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 修改 - name: CALICO_IPV4POOL_CIDR value: 172.20.0.0/16")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sed")]),t._v(" -i -e "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"s?192.168.0.0/16?172.20.0.0/16?g"')]),t._v(" canal.yaml\n")])])]),a("h4",{attrs:{id:"_4-4-1-需要修改如下几处配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-1-需要修改如下几处配置"}},[t._v("#")]),t._v(" 4.4.1 需要修改如下几处配置：")]),t._v(" "),a("p",[a("strong",[t._v("ConfigMap 配置修改")])]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ConfigMap\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" calico"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("config\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" kube"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("system\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("data")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("etcd_endpoints")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://192.168.10.102:2379"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("etcd_ca")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/calico-secrets/etcd-ca"')]),t._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# "/calico-secrets/etcd-ca"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("etcd_cert")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"calico-secrets/etcd-cert"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# "/calico-secrets/etcd-cert"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("etcd_key")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/calico-secrets/etcd-key"')]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# "/calico-secrets/etcd-key"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("typha_service_name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"none"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("calico_backend")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"bird"')]),t._v("\n")])])]),a("p",[t._v("对主要参数说明如下：")]),t._v(" "),a("ul",[a("li",[t._v("etcd_endpoints：Calico使用etcd来保存网络拓扑和状态，该参数指定etcd服务的地址，可手动设置。")]),t._v(" "),a("li",[t._v("calico_backend：Calico的后端，默认为bird。")]),t._v(" "),a("li",[t._v("cni_network_config：符合CNI规范的网络配置。其中 "),a("code",[t._v("type=calico")]),t._v(" 表示kubelet将从 "),a("code",[t._v("/opt/cni/bin")]),t._v(" 目录下搜索名为calico的可执行文件，并调用它来完成容器网络的设置。ipam中的 "),a("code",[t._v("type=calico-ipam")]),t._v(" 表示kubelet将在 "),a("code",[t._v("/opt/cni/bin")]),t._v(" 目录下搜索名为calico-ipam的可执行文件，用于完成容器IP地址的分配。")])]),t._v(" "),a("p",[a("strong",[t._v("修改 Pods 使用的 "),a("code",[t._v("IP 网段")]),t._v(" , 配置文件默认使用 "),a("code",[t._v("192.168.0.0/16")]),t._v(" 网段")])]),t._v(" "),a("p",[a("strong",[t._v("Secret 配置修改")])]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Secret\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Opaque\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" calico"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("etcd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("secrets\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" kube"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("system\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("data")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Example command for encoding a file contents: cat <file> | base64 -w 0")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 如果配置了TLS ，则需要设置相应的证书和密钥文件路径")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("etcd-key")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" (cat /etc/kubernetes/ca/server/server"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("key.pem "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),t._v(" base64 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("w 0) "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 将输出结果填写在这")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("etcd-cert")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" (cat /etc/kubernetes/ca/server/server.pem "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),t._v(" base64 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("w 0) "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 将输出结果填写在这")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("etcd-ca")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" (cat /etc/kubernetes/ca/ca.pem "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),t._v(" base64 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("w 0) "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 将输出结果填写在这")]),t._v("\n")])])]),a("p",[a("strong",[t._v("DaemonSet 配置修改")]),t._v("\n添加网卡发现规则")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" calico"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("node\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" calico/node"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("v3.14.2\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("env")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# .../")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Auto-detect the BGP IP address.")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" IP\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"autodetect"')]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Calico 模式设置")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" CALICO_IPV4POOL_IPIP\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Always"')]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 定义ipv4自动发现网卡规则 ")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" IP_AUTODETECTION_METHOD\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"interface=enp.*"')]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# no effect. This should fall within `--cluster-cidr`.")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 需要修改此处，打开注释替换 pod ip")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" CALICO_IPV4POOL_CIDR\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"172.20.0.0/16"')]),t._v("\n")])])]),a("p",[t._v("在该Pod中包括如下两个容器：")]),t._v(" "),a("ul",[a("li",[t._v("install-cni：在Node上安装CNI二进制文件到 "),a("code",[t._v("/opt/cni/bin")]),t._v(" 目录下，并安装相应的网络配置文件到 "),a("code",[t._v("/etc/cni/net.d")]),t._v(" 目录下，设置为initContainers并在运行完成后退出。")]),t._v(" "),a("li",[t._v("calico-node：Calico服务程序，用于设置Pod的网络资源，保证Pod的网络与各Node互联互通。它还需要以hostNetwork模式运行，直接使用宿主机网络。")])]),t._v(" "),a("p",[t._v("calico-node服务的主要参数如下。")]),t._v(" "),a("ul",[a("li",[t._v("CALICO_IPV4POOL_CIDR：Calico IPAM的IP地址池，Pod的IP地址将从该池中进行分配。")]),t._v(" "),a("li",[t._v("CALICO_IPV4POOL_IPIP：是否启用IPIP模式。启用IPIP模式时，Calico将在Node上创建一个名为tunl0的虚拟隧道。")]),t._v(" "),a("li",[a("code",[t._v("IP_AUTODETECTION_METHOD")]),t._v('：获取Node IP地址的方式，默认使用第1个网络接口的IP地址，对于安装了多块网卡的Node，可以使用正则表达式选择正确的网卡，例如"interface=eth.*"表示选择名称以'),a("code",[t._v("eth")]),t._v("开头的网卡的IP地址。")]),t._v(" "),a("li",[t._v("FELIX_IPV6SUPPORT：是否启用IPv6。")]),t._v(" "),a("li",[t._v("FELIX_LOGSEVERITYSCREEN：日志级别。")]),t._v(" "),a("li",[t._v("securityContext.privileged=true：以特权模式运行。")])]),t._v(" "),a("p",[t._v("另外，如果启用RBAC权限控制，则可以设置ServiceAccount。")]),t._v(" "),a("p",[t._v("IP Pool可以使用两种模式：BGP或IPIP。使用IPIP模式时，设置 "),a("code",[t._v('CALICO_IPV4POOL_IPIP="always"')]),t._v(" ，不使用IPIP模式时，设置"),a("code",[t._v('CALICO_IPV4POOL_IPIP="off"')]),t._v(" ，此时将使用BGP模式。")]),t._v(" "),a("p",[a("strong",[t._v("calico-kube-controllers解析配置")])]),t._v(" "),a("p",[t._v("calico-kube-controllers容器，用于对接Kubernetes集群中为Pod设置的Network Policy")]),t._v(" "),a("p",[t._v("如果启用RBAC权限控制，则可以设置ServiceAccount。用户在Kubernetes集群中设置了Pod的Network Policy之后，calicokube-controllers就会自动通知各Node上的calico-node服务，在宿主机上设置相应的iptables规则，完成Pod间网络访问策略的设置。")]),t._v(" "),a("h4",{attrs:{id:"_4-4-2-修改完-yaml-文件-执行部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-2-修改完-yaml-文件-执行部署"}},[t._v("#")]),t._v(" 4.4.2 修改完 yaml 文件，执行部署")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 部署")]),t._v("\nkubectl apply -f calico.yaml\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 查看 calico pods")]),t._v("\nkubectl  get pods -n kube-system\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 查看 node 是否正常，现在 node 服务正常了")]),t._v("\nkubectl get "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("node")]),t._v("\n\nNAME       \t\t\t STATUS   ROLES    AGE    VERSION\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".10.101   Ready    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("   4d4h   v1.18.6\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".10.102   Ready    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("   4d4h   v1.18.6\n\n")])])]),a("h2",{attrs:{id:"_5-通过系统服务-docker方式部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-通过系统服务-docker方式部署"}},[t._v("#")]),t._v(" 5. 通过系统服务+Docker方式部署")]),t._v(" "),a("h3",{attrs:{id:"_5-1-配置-service-文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-配置-service-文件"}},[t._v("#")]),t._v(" 5.1 配置 service 文件")]),t._v(" "),a("p",[a("strong",[t._v("vim /lib/systemd/system/kube-calico.service")])]),t._v(" "),a("blockquote",[a("p",[t._v("注意修改 IP 以及证书位置")])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("Unit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("Description")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("calico "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("node")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("After")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("docker.service\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("Requires")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("docker.service\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("Service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("User")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("root\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("PermissionsStartOnly")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("true\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ExecStart")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/usr/bin/docker run --net"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("host --privileged --name"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("calico-node "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  -e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ETCD_ENDPOINTS")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("https://192.168.10.102:2379 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  -e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ETCD_CA_CERT_FILE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/etc/kubernetes/ca/ca.pem "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  -e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ETCD_CERT_FILE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/etc/kubernetes/ca/calico/calico.pem "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  -e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ETCD_KEY_FILE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/etc/kubernetes/ca/calico/calico-key.pem "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  -e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("CALICO_LIBNETWORK_ENABLED")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("true "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  -e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("CALICO_NETWORKING_BACKEND")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("bird "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  -e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("CALICO_DISABLE_FILE_LOGGING")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("true "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  -e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("CALICO_IPV4POOL_CIDR")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("172.20")]),t._v(".0.0/16 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  -e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("CALICO_IPV4POOL_IPIP")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("off "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  -e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("FELIX_DEFAULTENDPOINTTOHOSTACTION")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("ACCEPT "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  -e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("FELIX_IPV6SUPPORT")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("false "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  -e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("FELIX_LOGSEVERITYSCREEN")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("info "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  -e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("FELIX_IPINIPMTU")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1440")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  -e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("FELIX_HEALTHENABLED")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("true "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  -e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("IP")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".10.101 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  -v /etc/kubernetes/ca:/etc/kubernetes/ca "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  -v /var/run/calico:/var/run/calico "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  -v /lib/modules:/lib/modules "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  -v /run/docker/plugins:/run/docker/plugins "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  -v /var/run/docker.sock:/var/run/docker.sock "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  -v /var/log/calico:/var/log/calico "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  calico/node:v3.14.2\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ExecStop")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/usr/bin/docker "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("rm")]),t._v(" -f calico-node\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("Restart")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("always\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("RestartSec")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("Install"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("WantedBy")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("multi-user.target\n")])])]),a("h3",{attrs:{id:"_5-2-启动-kube-calico-服务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-启动-kube-calico-服务"}},[t._v("#")]),t._v(" 5.2 启动 kube-calico 服务")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("systemctl daemon-reload "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 修改配置重启的时候用")]),t._v("\nsystemctl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("enable")]),t._v(" kube-calico.service\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" kube-calico start\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 查看日志")]),t._v("\njournalctl -f -u kube-calico\n")])])]),a("h3",{attrs:{id:"_5-3-calico-客户端工具-calicoctl"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-calico-客户端工具-calicoctl"}},[t._v("#")]),t._v(" 5.3 calico 客户端工具 calicoctl")]),t._v(" "),a("p",[a("strong",[t._v("下载 calicoctl 二进制文件, 下载地址："),a("a",{attrs:{href:"https://github.com/projectcalico/calicoctl/releases",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/projectcalico/calicoctl/releases"),a("OutboundLink")],1)])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("chmod")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("755")]),t._v(" calicoctl\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mv")]),t._v(" calicoctl /usr/local/bin/\n")])])]),a("h3",{attrs:{id:"_5-4-查看节点运行情况"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-4-查看节点运行情况"}},[t._v("#")]),t._v(" 5.4 查看节点运行情况")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("calicoctl "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("node")]),t._v(" status\nCalico process is running.\nIPv4 BGP status\n+---------------+-------------------+-------+----------+-------------+\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" PEER ADDRESS  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("     PEER TYPE     "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" STATE "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("  SINCE   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("    INFO     "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n+---------------+-------------------+-------+----------+-------------+\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".10.101 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" node-to-node mesh "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" up    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("13")]),t._v(":13:13 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Established "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n+---------------+-------------------+-------+----------+-------------+\nIPv6 BGP status\nNo IPv6 peers found.\n")])])]),a("p",[a("strong",[t._v("查看端口BGP 协议是通过TCP 连接来建立邻居的，因此可以用netstat 命令验证 BGP Peer")])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("netstat")]),t._v(" -natp"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" ESTABLISHED"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("179")]),t._v("\ntcp        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".10.102:60959     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".10.103:179       ESTABLISHED "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("29680")]),t._v("/bird\n")])])]),a("h3",{attrs:{id:"_5-5-配置-ip-pool"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-5-配置-ip-pool"}},[t._v("#")]),t._v(" 5.5 配置 IP Pool")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",[t._v("注：请看官方配置文件："),a("a",{attrs:{href:"https://docs.projectcalico.org/getting-started/clis/calicoctl/configure/overview",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://docs.projectcalico.org/getting-started/clis/calicoctl/configure/overview"),a("OutboundLink")],1)])]),t._v(" "),a("p",[t._v("默认情况下，"),a("code",[t._v("calicoctl")]),t._v("将在上查找配置文件"),a("code",[t._v("/etc/calico/calicoctl.cfg")]),t._v("。您可以将该"),a("code",[t._v("--config")]),t._v("选项与需要数据存储访问的命令一起使用，以覆盖此选项。该文件可以是YAML或JSON格式。它必须有效并且可由读取"),a("code",[t._v("calicoctl")]),t._v("。以下是一个YAML示例：")]),t._v(" "),a("p",[a("strong",[t._v("vim /etc/calico/calicoctl.cfg")])]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" projectcalico.org/v3\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" CalicoAPIConfig\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("etcdEndpoints")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//192.168.10.102"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2379")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("etcdKeyFile")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /etc/kubernetes/ca/calico/calico"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("key.pem\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("etcdCertFile")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /etc/kubernetes/ca/calico/calico.pem\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("etcdCACertFile")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /etc/kubernetes/ca/ca.pem\n")])])]),a("p",[a("strong",[t._v("查看集群ippool情况")])]),t._v(" "),a("p",[a("strong",[t._v("calicoctl get ipPool -o yaml")])]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 输出内容如下")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" projectcalico.org/v3\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" IPPool\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("creationTimestamp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2020-08-14T10:38:44Z"')]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" default"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("ipv4"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("ippool\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resourceVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"13109"')]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("uid")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 3e3b1506"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("e9a8"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("4d02"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("96f7"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("2ceb63ade2ea\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("blockSize")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("26")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cidr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 172.20.0.0/16\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ipipMode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Never\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("natOutgoing")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nodeSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" all()\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("vxlanMode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Never\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" IPPoolList\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resourceVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"57796"')]),t._v("\n")])])]),a("h2",{attrs:{id:"_6-授权apiserver访问kubelet"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-授权apiserver访问kubelet"}},[t._v("#")]),t._v(" 6. 授权Apiserver访问kubelet")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /etc/kubernetes/server/cfg/apiserver-to-kubelet-rbac.yaml "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('EOF\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  annotations:\n    rbac.authorization.kubernetes.io/autoupdate: "true"\n  labels:\n    kubernetes.io/bootstrapping: rbac-defaults\n  name: system:kube-apiserver-to-kubelet\nrules:\n  - apiGroups:\n      - ""\n    resources:\n      - nodes/proxy\n      - nodes/stats\n      - nodes/log\n      - nodes/spec\n      - nodes/metrics\n      - pods/log\n    verbs:\n      - "*"\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: system:kube-apiserver\n  namespace: ""\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: system:kube-apiserver-to-kubelet\nsubjects:\n  - apiGroup: rbac.authorization.k8s.io\n    kind: User\n    name: kubernetes\nEOF')]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#  启动")]),t._v("\nkubectl apply -f apiserver-to-kubelet-rbac.yaml\n")])])])])}),[],!1,null,null,null);a.default=n.exports}}]);