---
title: "Elasticsearch-é«˜äº®æŸ¥è¯¢"
date: 2021-08-18 19:00:00
re: elasticsearch-highlight
---

# Elasticsearch é«˜äº®æŸ¥è¯¢

æ—¥å¸¸ç”Ÿæ´»ä¸­æˆ‘ä»¬ä½¿ç”¨æœç´¢å·¥å…·å°è¯•æŸ¥è¯¢ä¸€äº›ä¿¡æ¯çš„æ—¶å€™ï¼Œå¸¸å¸¸å¯ä»¥çœ‹åˆ°è¿”å›çš„ç»“æœé›†ä¸­å’Œæˆ‘ä»¬æŸ¥è¯¢æ¡ä»¶ç›¸ç¬¦åˆçš„å­—æ®µè¢«ç‰¹æ®Šçš„é¢œè‰²æ‰€æ ‡è®°ï¼Œè¿™å°±æ˜¯ç»“æœé«˜äº®æ˜¾ç¤ºã€‚é€šè¿‡é«˜äº®æ˜¾ç¤ºç”¨æˆ·å¯ä»¥æ˜æ˜¾çš„å‘ç°æŸ¥è¯¢åŒ¹é…çš„ä½ç½®ï¼ŒElasticsearch ä½¿ç”¨ `highlight` æ¥å®ç°æœç´¢ç»“æœä¸­ä¸€ä¸ªæˆ–å¤šä¸ªå­—æ®µçªå‡ºæ˜¾ç¤º

## ä¾‹å­ğŸŒ°

ä¸¾ä¸ªğŸŒ° - *æŸ¥è¯¢ æ”»ç•¥ä¸­å¸¦ä¸Šæµ·çš„æ•°æ® - å¤šå­—æ®µåŒ¹é…*

### æ˜ å°„ç»“æ„

ä¸‹é¢æ˜¯ä¾‹å­æ‰€ä½¿ç”¨çš„æ˜ å°„ç»“æ„

> æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨äº† `IK` åˆ†è¯å™¨ï¼Œå¦‚éœ€äº†è§£ IK åˆ†è¯å™¨è¯·çœ‹ [Elasticsearch ä¸­æ–‡åˆ†è¯å™¨](/passages/2021-08-16-elasticsearch-ik.html)

```json
{
  "mappings": {
    "_doc": {
      "properties": {
        "id": {
          "type": "keyword"
        },
        "subTitle": {
          "type": "text",
          "store": true,
          "analyzer": "ik_max_word"
        },
        "summary": {
          "type": "text",
          "store": true,
          "analyzer": "ik_max_word"
        },
        "title": {
          "type": "text",
          "store": true,
          "analyzer": "ik_max_word"
        }
      }
    }
  }
}
```

æ‰§è¡Œå¦‚ä¸‹è¯·æ±‚ä¹‹åä¼šå¾—åˆ°è¿”å›å†…å®¹ï¼Œåœ¨ `hits` ä¸­é™¤äº†å¸¸è§„æ•°æ®å¤–ï¼Œè¿˜ä¼šæœ‰ **`highlight`** å¯¹è±¡

```json
{
  "query": {
    "multi_match": {
      "query": "ä¸Šæµ·",
      "fields": ["title", "subTitle", "summary"]
    }
  },
  "highlight": {
    "fields": {
      "title": {
        "pre_tags": "<b>",
        "post_tags": "</b>"
      },
      "subTitle": {},
      "summary": {
        "pre_tags": "<b>",
        "post_tags": "</b>",
        "number_of_fragments": 2,
        "fragment_size": 10
      }
    }
  }
}
```

è¿”å›çš„ç»“æœé‡Œé¢æ¯ä¸ª hit å¤šäº†ä¸€ä¸ªç±»ä¼¼è¿™æ ·éƒ¨åˆ†ï¼š

```json
{
  "hits" : {
    "hits" : [
      {
        "_index" : "strategy_es",
        "_type" : "_doc",
        "_id" : "7",
        "_score" : 2.4005952,
        "_source" : {
          "id" : 7,
          "title" : "æ‡’äººåƒè´§æŒ‡å— | è½»æ¾åƒéåœ°é“ä¸Šæµ·å°åƒ",
          "subTitle" : "è½»æ¾åƒéåœ°é“ä¸Šæµ·å°åƒ",
          "summary" : "å»ä¸€ä¸ªåœ°æ–¹æ—…è¡Œå½“ç„¶è¦å°å°å½“åœ°çš„ç‰¹è‰²ç¾é£Ÿï¼Œä¸ç„¶æ€»è§‰å¾—è¿™è¶Ÿæ—…è¡Œä¸å®Œæ•´ã€‚ä½†æ˜¯å¯¹äºä¸ç†Ÿæ‚‰ä¸Šæµ·çš„æ¸¸å®¢æ¥è¯´ï¼Œâ€œå“ªäº›æ˜¯è€ä¸Šæµ·å°åƒï¼Ÿå»å“ªé‡Œèƒ½åƒåˆ°åœ°é“çš„ï¼Ÿâ€è¿™äº›éƒ½æ˜¯å¤´ç–¼çš„é—®é¢˜ã€‚è¿™ç¯‡æ”»ç•¥å°†ä¼šç»™å¤§å®¶ä»‹ç»è€ä¸Šæµ·å°åƒï¼Œæ¨èä¸€äº›è€å­—å·ï¼Œå¹¶é™„ä¸Šå‘¨è¾¹æ¸¸ç©å°Tips"
        },
        "highlight" : {
          "summary" : [
            "ä½†æ˜¯å¯¹äºä¸ç†Ÿæ‚‰<b>ä¸Šæµ·</b>çš„æ¸¸å®¢æ¥è¯´",
            "ï¼Œâ€œå“ªäº›æ˜¯è€<b>ä¸Šæµ·</b>å°åƒï¼Ÿ"
          ],
          "subTitle" : [
            "è½»æ¾åƒéåœ°é“<em>ä¸Šæµ·</em>å°åƒ"
          ],
          "title" : [
            "æ‡’äººåƒè´§æŒ‡å— | è½»æ¾åƒéåœ°é“<b>ä¸Šæµ·</b>å°åƒ"
          ]
        }
      }
    ]
  }
}
```

## é«˜äº®è®¾ç½®

å¯ä»¥çœ‹åˆ°æˆ‘ä»¬é¢„è®¾äº† é«˜äº®å…³é”®å­— çš„HTMLæ ‡ç­¾è¿›è¡ŒåŒ…è£¹ï¼Œä¸‹é¢æˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹é«˜äº® **highlight** çš„å‚æ•°å®šä¹‰ï¼Œä¸‹é¢çš„å‚æ•°å¯ä»¥è®¾ç½®åœ¨ `highlight` çš„ä¸‹ä¸€çº§æ­¤æ—¶ä¸º **å…¨å±€è®¾ç½®**ï¼Œä¹Ÿå¯ä»¥è®¾ç½®åœ¨å­—æ®µçš„ä¸‹ä¸€çº§ï¼Œæ­¤æ—¶ä¸º **å­—æ®µè®¾ç½®**

> å•ä¸ªå­—æ®µçš„è®¾ç½®ä¼˜å…ˆçº§é«˜äºå…¨å±€è®¾ç½®

### number_of_fragments

è¦è¿”å›çš„æœ€å¤§ç‰‡æ®µæ•°ï¼Œå¦‚æœç‰‡æ®µæ•°è®¾ç½®ä¸º 0ï¼Œåˆ™ä¸è¿”å›ä»»ä½•ç‰‡æ®µï¼Œ**è€Œæ˜¯çªå‡ºæ˜¾ç¤ºå¹¶è¿”å›æ•´ä¸ªå­—æ®µå†…å®¹**ã€‚

å½“æ‚¨éœ€è¦çªå‡ºæ˜¾ç¤ºæ ‡é¢˜æˆ–åœ°å€ç­‰çŸ­æ–‡æœ¬æ—¶ï¼Œè¿™ä¼šå¾ˆæ–¹ä¾¿ï¼Œä½†ä¸éœ€è¦åˆ†æ®µã€‚å¦‚æœ`number_of_fragments` ä¸º 0ï¼Œ`fragment_size`åˆ™å¿½ç•¥ã€‚é»˜è®¤ä¸º 5

ä¾‹å¦‚ä¸Šé¢ğŸ‘†æˆ‘ä»¬è®¾ç½®äº† *number_of_fragments: 2* ï¼Œé‚£ä¹ˆ summary å­—æ®µè¿”å›äº†ä¸¤æ®µæ•°æ®

```json
{
    "summary" : [
        "ä½†æ˜¯å¯¹äºä¸ç†Ÿæ‚‰<b>ä¸Šæµ·</b>çš„æ¸¸å®¢æ¥è¯´",
        "ï¼Œâ€œå“ªäº›æ˜¯è€<b>ä¸Šæµ·</b>å°åƒï¼Ÿ"
    ]
}
```

å¦‚æœè®¾ç½®æˆ 0 ï¼Œå°±è¿”å›åŸæœ¬æ•°æ®

```json
{
    "summary" : [
            "å»ä¸€ä¸ªåœ°æ–¹æ—…è¡Œå½“ç„¶è¦å°å°å½“åœ°çš„ç‰¹è‰²ç¾é£Ÿï¼Œä¸ç„¶æ€»è§‰å¾—è¿™è¶Ÿæ—…è¡Œä¸å®Œæ•´ã€‚ä½†æ˜¯å¯¹äºä¸ç†Ÿæ‚‰<b>ä¸Šæµ·</b>çš„æ¸¸å®¢æ¥è¯´ï¼Œâ€œå“ªäº›æ˜¯è€<b>ä¸Šæµ·</b>å°åƒï¼Ÿå»å“ªé‡Œèƒ½åƒåˆ°åœ°é“çš„ï¼Ÿâ€è¿™äº›éƒ½æ˜¯å¤´ç–¼çš„é—®é¢˜ã€‚è¿™ç¯‡æ”»ç•¥å°†ä¼šç»™å¤§å®¶ä»‹ç»è€<b>ä¸Šæµ·</b>å°åƒï¼Œæ¨èä¸€äº›è€å­—å·ï¼Œå¹¶é™„ä¸Šå‘¨è¾¹æ¸¸ç©å°Tips"
    ]
}
```

### fragment_size

ä¸€æ®µ fragment åŒ…å«å¤šå°‘ä¸ªå­—ç¬¦ï¼ˆä»¥å­—ç¬¦ä¸ºå•ä½ï¼‰é»˜è®¤ä¸º 100

### pre_tags

æ ‡è®° highlight çš„å¼€å§‹æ ‡ç­¾ï¼Œä¾‹å¦‚ä¸Šé¢çš„ `<b>` æ ‡ç­¾

### post_tags

æ ‡è®° highlight çš„ç»“æŸæ ‡ç­¾ï¼Œä¾‹å¦‚ä¸Šé¢çš„ `</b>` æ ‡ç­¾

> ç³»ç»Ÿé¢„è®¾çš„æ ‡ç­¾ä¸º `<em>`

### order

orderæ§åˆ¶äº†è¿”å›å¯¹è±¡ä¸­ `highlight` ç‰‡æ®µçš„æ’åºã€‚ä¸‹é¢ä¾‹å­ä¸­è¿”å›çš„é«˜äº®ç‰‡æ®µå°†ä¼šæ ¹æ®åˆ†æ•°é¡ºåºè¾“å‡ºã€‚å‡å¦‚è®¾ç½®äº†noneåˆ™æ˜¯æŒ‰ç…§é¡ºåºè¾“å‡º

:::tip

æœ€å‡†ç¡®çš„æ–‡æ¡£è¿˜æ˜¯å®˜ç½‘ï¼Œæ›´å¤šçš„å‚æ•°è¯·å‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-highlighting.html#highlighting-settings)ã€‚

:::

## Java ä»£ç å®ç°é«˜äº®æŸ¥è¯¢

:::tip

åœ¨è¿™é‡Œæˆ‘ä»¬å°±ä¸ä»‹ç» Elasticsearch å’Œ SpringBoot çš„é›†æˆï¼Œå¦‚æœä¸ä¼šè¯·çœ‹ä¸Šä¸€ç¯‡æ–‡ç«  [SpringBoot é›†æˆ Elasticsearch](/passages/2021-08-18-elasticsearch-integrate-springboot.html)

:::

| æ¡†æ¶                      | ç‰ˆæœ¬   |
| ------------------------- | ------ |
| SpringBoot                | 2.5.3  |
| Elasticsearch             | 7.14.0 |
| Spring Data Elasticsearch | 4.2.3  |

```java
@Autowired
private ElasticsearchRestTemplate restTemplate;
// ----------------------------------------------
// æ„å»ºæŸ¥è¯¢å¯¹è±¡
NativeSearchQueryBuilder builder = new NativeSearchQueryBuilder();
// è·å–å­—æ®µ
String[] fields = new String[]{"title", "subTitle", "summary"};

// å¤šå­—æ®µåŒ¹é…
MultiMatchQueryBuilder multiMatchQueryBuilder =
    QueryBuilders.multiMatchQuery("ä¸Šæµ·", fields);

// è®¾ç½®é«˜äº®
HighlightBuilder highlightBuilder = new HighlightBuilder();
for (String field : fields) {
    highlightBuilder.field(field);
}

highlightBuilder.requireFieldMatch(false); // å¦‚æœè¦å¤šä¸ªå­—æ®µé«˜äº®,è¿™é¡¹è¦ä¸ºfalse
highlightBuilder.preTags("<span style='color:red'>"); // é«˜äº®è®¾ç½®
highlightBuilder.postTags("</span>");
highlightBuilder.numOfFragments(0); // è¿”å›ç»“æœæœ€å¤šå¯ä»¥åŒ…å«å‡ æ®µä¸è¿ç»­çš„æ–‡å­—ã€‚é»˜è®¤æ˜¯5, è¿™é‡Œä¸åˆ†æ®µæ˜¾ç¤º

// åˆ†é¡µ
Pageable pageable = PageRequest.of(0, 10,
                                   Sort.Direction.ASC, "_id");// è®¾ç½®åˆ†é¡µå‚æ•°

// å°è£…æŸ¥è¯¢
builder.withQuery(multiMatchQueryBuilder)
    .withPageable(pageable) // å°è£…åˆ†é¡µ
    .withHighlightBuilder(highlightBuilder);
NativeSearchQuery searchQuery = builder.build();

// å‘èµ·æ£€ç´¢è¯·æ±‚
// å‚æ•°ï¼šæŸ¥è¯¢æ¡ä»¶å¯¹è±¡ï¼Œè¿”å›æ³›å‹ï¼Œç´¢å¼•åç§°
SearchHits<Strategy> searchHits = restTemplate.search(searchQuery, Strategy.class, IndexCoordinates.of("strategy_es"));

// ... è¾“å‡ºé«˜äº®å†…å®¹
```