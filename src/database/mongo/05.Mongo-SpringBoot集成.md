---
title: "Mongo-SpringBooté›†æˆ"
date: 2021-08-27 16:50:20
re: mongo-springboot
---

# Mongo é›†æˆ SpringBoot

> å¼€å‘ç¯å¢ƒé…ç½®å¦‚ä¸‹ğŸ‘‡

| æ¡†æ¶                             | ç‰ˆæœ¬  |
| -------------------------------- | ----- |
| SpringBoot                       | 2.5.4 |
| mongodb                          | 5.0.2 |
| spring-boot-starter-data-mongodb | 2.5.4 |

## å¯¼å…¥ pom æ–‡ä»¶

æˆ‘ä»¬æƒ³è¦åœ¨ SpringBoot ä¸­é›†æˆ mongoï¼Œç¬¬ä¸€æ­¥â˜ï¸å°±æ˜¯å¯¼å…¥ç›¸åº”çš„ pom æ–‡ä»¶

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-mongodb</artifactId>
</dependency>
```

## é…ç½®æ–‡ä»¶

```yaml
spring:
  data:
    # mongodb é…ç½®
    mongodb:
      database: xxx
      host: 127.0.0.1
      port: 27017
```

## å¼€å¯æ³¨è§£

```java
@EnableMongoRepositories(basePackages = "xx.xxx.xxx")
```

å› ä¸ºä½¿ç”¨äº† Spring-data æ¡†æ¶ï¼Œæ‰€ä»¥éœ€è¦å¼€å¯æ³¨è§£æ‰«æ Repository ç±»

## ç¼–å†™å¯¹åº”çš„ JavaBean

å…ˆå®šä¹‰ä¸€ä¸ª JavaBean ç±»ï¼ŒæŒ‡å®šé›†åˆåç§°

```java
@Data
@Document("entries")
// ä¸ºåºåˆ—åŒ–ä¸­çš„å±æ€§é€‰æ‹©å‘½åç­–ç•¥
// æ‰€æœ‰å­—æ¯å‡ä¸ºå°å†™ï¼Œå¹¶åœ¨åç§°å…ƒç´ ä¹‹é—´ä½¿ç”¨ä¸‹åˆ’çº¿ä½œä¸ºåˆ†éš”ç¬¦
@JsonNaming(PropertyNamingStrategies.SnakeCaseStrategy.class)
public class Entry {
    @Id
    private String id;
    private String title;
    private String link;
    @Field("image_url")
    private String imageUrl;
    @Field("icon_url")
    private String iconUrl;
    @Field("title_color")
    private String titleColor;
    private String description;
    private int price;
    @Field("is_in_serving")
    private String isInServing;
}
```

## åˆ›å»º Repository

Spring Data çš„å¼ºå¤§ä¹‹å¤„ï¼Œå°±åœ¨äºä½ ä¸ç”¨å†™ä»»ä½•DAOå¤„ç†ï¼Œè‡ªåŠ¨æ ¹æ®æ–¹æ³•åæˆ–ç±»çš„ä¿¡æ¯è¿›è¡ŒCRUDæ“ä½œã€‚åªè¦ä½ å®šä¹‰ä¸€ä¸ªæ¥å£ï¼Œç„¶åç»§æ‰¿Repositoryæä¾›çš„ä¸€äº›å­æ¥å£ï¼Œå°±èƒ½å…·å¤‡å„ç§åŸºæœ¬çš„CRUDåŠŸèƒ½

```java
@Repository
public interface EntryRepository extends CrudRepository<Entry, String> {
}
```

## mongoTemplate API æ–¹æ³•å¤§å…¨

Spring Data MongoDB æ˜¯Springæ¡†æ¶è®¿é—®mongodbçš„ç¥å™¨ï¼Œå€ŸåŠ©å®ƒå¯ä»¥éå¸¸æ–¹ä¾¿çš„è¯»å†™mongoåº“ã€‚æœ¬æ–‡ä»‹ç»ä½¿ç”¨Spring Data MongoDBæ¥è®¿é—®mongodbæ•°æ®åº“çš„å‡ ç§æ–¹æ³•ï¼š

- ä½¿ç”¨Queryå’ŒCriteriaç±»
- JPAè‡ªåŠ¨ç”Ÿæˆçš„æŸ¥è¯¢æ–¹æ³•
- ä½¿ç”¨@Query æ³¨è§£åŸºäºJSONæŸ¥è¯¢

> ä½¿ç”¨Spring Dataæ¥æŸ¥è¯¢MongoDBçš„æœ€å¸¸ç”¨æ–¹æ³•ä¹‹ä¸€æ˜¯ä½¿ç”¨ `Query` å’Œ `Criteria` ç±»

### is æŸ¥è¯¢

åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ - æˆ‘ä»¬æ­£åœ¨å¯»æ‰¾ **title** åä¸º *æœè”¬ç”Ÿèœ* çš„æ•°æ®

```java
Query query = new Query();
query.addCriteria(Criteria.where("title").is("æœè”¬ç”Ÿèœ"));
List<Entry> entrys = mongoTemplate.find(query, Entry.class);
```

### æ¨¡ç³ŠæŸ¥è¯¢ - æ­£åˆ™

åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ - æˆ‘ä»¬æ­£åœ¨å¯»æ‰¾ **title**ã€å’Œ **description** ä¸­å¸¦æœ‰ *æ—©é¤* çš„æ•°æ®

```java
//æ¨¡ç³ŠåŒ¹é…
Pattern pattern = Pattern.compile(".*?æ—©é¤.*?");
query.addCriteria(Criteria.where("")
              .orOperator(Criteria.where("title").regex(pattern),Criteria.where("description").regex(pattern)));
List<Entry> entrys = mongoTemplate.find(query, Entry.class);
```

### LTå’ŒGT

$ ltï¼ˆå°äºï¼‰è¿ç®—ç¬¦å’Œ$ gtï¼ˆå¤§äºï¼‰

ä¸¾ä¸ªğŸŒ° - æŸ¥æ‰¾ä»·æ ¼åœ¨ 100 ~ 500 ä¹‹é—´çš„æ•°æ®

```java
Query query = new Query();
query.addCriteria(Criteria.where("price").lt(100).gt(500));
List<Entry> users = mongoTemplate.find(query, Entry.class);
```

### ç»“æœæ’åº

Sort ç”¨äºæŒ‡å®šç»“æœçš„æ’åºé¡ºåº

åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ - æ ¹æ®ä»·æ ¼æ¥æ’åº

```java
Query query = new Query();
query.with(new Sort(Sort.Direction.ASC, "price"));
List<Entry> entrys = mongoTemplate.find(query, Entry.class);
```

### åˆ†é¡µ

ä¸€ä¸ªä½¿ç”¨åˆ†é¡µçš„ç®€å•ä¾‹å­ - æ¯é¡µæ˜¾ç¤º 5 æ¡æ•°æ®ï¼Œä¸”æ ¹æ®ä»·æ ¼æ’åº

```java
// æ’åº
Sort sort = new Sort(Sort.Direction.ASC, "price")
Pageable pageableRequest = new PageRequest(0, 5, sort);
Query query = new Query();
query.with(pageableRequest);
List<Entry> entrys = mongoTemplate.find(query, Entry.class);
```

## Repository ä½¿ç”¨

ç”ŸæˆæŸ¥è¯¢æ–¹æ³•æ˜¯JPAçš„ä¸€ä¸ªç‰¹æ€§ï¼Œåœ¨Spring Data Mongodbé‡Œä¹Ÿå¯ä»¥ä½¿ç”¨

### FindByX

 é€šè¿‡ *title* æŸ¥æ‰¾ï¼Œåªéœ€è¦åœ¨æ¥å£ä¸Šå£°æ˜æ–¹æ³•å³å¯

```java
@Repository
public interface EntryRepository extends CrudRepository<Entry, String> {
    List<Entry> findByTitle(String title);
}
```

### StartingWith and endingWith

```java
List<Entry> findByTitleStartingWith(String regexp);
List<Entry> findByTitleEndingWith(String regexp);
```

### Between

ç±»ä¼¼ä»·æ ¼åŒºé—´æŸ¥è¯¢æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Between ï¼š

```java
List<Entry> findByPriceBetween(int minPrice, int maxPrice);
List<Entry> entrys = entryRepository.findByPriceBetween(100, 500);
```

### Likeå’ŒOrderBy

ç¤ºä¾‹ - æˆ‘ä»¬å°†è¦æŸ¥æ‰¾ *title* ä¸­åŒ…å« *æ—©é¤* çš„æ‰€æœ‰æ•°æ®ï¼Œæˆ‘ä»¬ä¹Ÿå°†æŒ‰ *ä»·æ ¼* é¡ºåºæ’åˆ—ç»“æœï¼š

```java
List<Entry> entrys = entryRepository.findByTitleLikeOrderByPriceAsc("æ—©é¤");
```

## åŸå§‹æŸ¥è¯¢

ä½¿ç”¨@Queryæ³¨è§£ - æˆ‘ä»¬å¯ä»¥æŒ‡å®šä¸€ä¸ªåŸå§‹æŸ¥è¯¢ - ä½œä¸ºä¸€ä¸ªMongo JSONæŸ¥è¯¢å­—ç¬¦ä¸²

### FindBy

```java
@Query("{ 'title' : ?0 }")
List<Entry> findEntryByTitle(String title);
```

### $regex

æ­£åˆ™è¡¨è¾¾å¼é©±åŠ¨çš„æŸ¥è¯¢

```java
@Query("{ 'title' : { $regex: ?0 } }")
List<Entry> findEntryByRegexpTitle(String regexp);
```

