---
title: "Activiti7 è¿›é˜¶ç¬”è®°"
date: 2021-07-22 10:00:00
re: activiti7-note-advanced
category:
  - Activiti7
---

# Activiti7 è¿›é˜¶

:::tip

æ¶‰åŠ æµç¨‹å®šä¹‰ç›¸å…³ã€æµç¨‹å®ä¾‹ç›¸å…³ã€ä»»åŠ¡åˆ†é…ã€æµç¨‹å˜é‡ã€ä»»åŠ¡å€™é€‰äººã€ç½‘å…³ç­‰æ“ä½œ

:::

## æµç¨‹å®šä¹‰ç›¸å…³

> æ¶‰åŠæµç¨‹å®šä¹‰ä¿¡æ¯æŸ¥è¯¢ã€åˆ é™¤ä»¥åŠå¯¹åº”çš„èµ„æºæŸ¥è¯¢ä¸‹è½½ç­‰æ“ä½œ

### æŸ¥è¯¢æµç¨‹å®šä¹‰

```java
@Test
public void testDefinitionQuery(){
    //åˆ›å»ºProcessEngineå¯¹è±¡
    ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();
    //è·å–ä»“åº“æœåŠ¡
    RepositoryService repositoryService = processEngine.getRepositoryService();
    //è·å–æµç¨‹å®šä¹‰é›†åˆ
    List<ProcessDefinition> processDefinitionList = repositoryService
            .createProcessDefinitionQuery()
            .processDefinitionKey("leaveProcess")
            .list();
    //éå†é›†åˆ
    for (ProcessDefinition definition:processDefinitionList){
        System.out.println("æµç¨‹å®šä¹‰ID:"+definition.getId());
        System.out.println("æµç¨‹å®šä¹‰åç§°:"+definition.getName());
        System.out.println("æµç¨‹å®šä¹‰key:"+definition.getKey());
        System.out.println("æµç¨‹å®šä¹‰ç‰ˆæœ¬:"+definition.getVersion());
        System.out.println("æµç¨‹éƒ¨ç½²ID:"+definition.getDeploymentId());
        System.out.println("====================");
    }
}
```

### åˆ é™¤æµç¨‹å®šä¹‰

```java
@Test
public void testDeleteDeploy(){
    //æµç¨‹éƒ¨ç½²Id
    String deploymentId = "10001";
    //åˆ›å»ºProcessEngineå¯¹è±¡
    ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();
    //è·å–ä»“åº“æœåŠ¡
    RepositoryService repositoryService = processEngine.getRepositoryService();
    //åˆ é™¤æµç¨‹å®šä¹‰ï¼Œå¦‚æœè¯¥æµç¨‹å®šä¹‰å·²æœ‰æµç¨‹å®ä¾‹å¯åŠ¨åˆ™åˆ é™¤æ—¶å‡ºé”™
    repositoryService.deleteDeployment(deploymentId);
    //è®¾ç½®true çº§è”åˆ é™¤æµç¨‹å®šä¹‰ï¼Œå³ä½¿è¯¥æµç¨‹æœ‰æµç¨‹å®ä¾‹å¯åŠ¨ä¹Ÿå¯ä»¥åˆ é™¤ï¼Œè®¾ç½®ä¸ºfalseéçº§åˆ«åˆ é™¤æ–¹å¼ï¼Œå¦‚æœæµç¨‹
    //repositoryService.deleteDeployment(deploymentId,true);
}
```

è¯´æ˜ï¼š

  1)  å¦‚æœè¯¥æµç¨‹å®šä¹‰ä¸‹æ²¡æœ‰æ­£åœ¨è¿è¡Œçš„æµç¨‹ï¼Œåˆ™å¯ä»¥ç”¨æ™®é€šåˆ é™¤

  2)  å¦‚æœè¯¥æµç¨‹å®šä¹‰ä¸‹å­˜åœ¨å·²ç»è¿è¡Œçš„æµç¨‹ï¼Œä½¿ç”¨æ™®é€šåˆ é™¤æŠ¥é”™ï¼Œå¯ç”¨çº§è”åˆ é™¤æ–¹æ³•å°†æµç¨‹åŠç›¸å…³è®°å½•å…¨éƒ¨åˆ é™¤ã€‚

  3)  é¡¹ç›®å¼€å‘ä¸­çº§è”åˆ é™¤æ“ä½œä¸€èˆ¬åªå¼€æ”¾ç»™è¶…çº§ç®¡ç†å‘˜ä½¿ç”¨.

### æµç¨‹èµ„æºä¸‹è½½

> æˆ‘ä»¬çš„æµç¨‹èµ„æºæ–‡ä»¶å·²ç»ä¸Šä¼ åˆ°æ•°æ®åº“äº†ï¼Œå¦‚æœå…¶ä»–ç”¨æˆ·æƒ³è¦æŸ¥çœ‹è¿™äº›èµ„æºæ–‡ä»¶ï¼Œå¯ä»¥ä»æ•°æ®åº“ä¸­æŠŠèµ„æºæ–‡ä»¶ä¸‹è½½åˆ°æœ¬åœ°

```java
@Test
public void testDownloadResource() throws Exception {
    //åˆ›å»ºProcessEngineå¯¹è±¡
    ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();
    //è·å–ä»“åº“æœåŠ¡
    RepositoryService repositoryService = processEngine.getRepositoryService();
    //è·å–æµç¨‹å®šä¹‰é›†åˆ
    List<ProcessDefinition> list = repositoryService
            .createProcessDefinitionQuery()
            .processDefinitionKey("leaveProcess")
            .orderByProcessDefinitionVersion() //æŒ‰ç…§ç‰ˆæœ¬æ’åº
            .desc()//é™åº
            .list();
    //è·å–æœ€æ–°é‚£ä¸ª
    ProcessDefinition definition =list.get(0);
    //è·å–éƒ¨ç½²ID
    String deploymentId = definition.getDeploymentId();
    //è·å–bpmnçš„è¾“å…¥æµ
    InputStream bpmnInput = repositoryService.getResourceAsStream(
                                        deploymentId,
                                        definition.getResourceName());
    //è·å–pngçš„è¾“å…¥æµ
    InputStream pngInput = repositoryService.getResourceAsStream(
                                        deploymentId,
                                        definition.getDiagramResourceName());
    //è®¾ç½®bpmnè¾“å…¥
    FileOutputStream bpmnOutPut = new FileOutputStream("D:/leave.bpmn");
    //è®¾ç½®pngè¾“å…¥
    FileOutputStream pngOutPut = new FileOutputStream("D:/leave.png");
    IOUtils.copy(bpmnInput,bpmnOutPut);
    IOUtils.copy(pngInput,pngOutPut);
}
```

## æµç¨‹å®ä¾‹ç›¸å…³

:::tip

æµç¨‹å‘èµ·ä¹‹åï¼Œç›®å‰è®¾å®šçš„éƒ¨é—¨å®¡æ‰¹äººéƒ½æ˜¯æå››ï¼Œæå››åœ¨å®¡æ‰¹ä¹‹å‰éœ€è¦çœ‹åˆ°ç”³è¯·äººç”³è¯·çš„æ—¶é—´å’Œç”³è¯·çš„ç†ç”±ï¼Œæ‰èƒ½å†³å®šæ˜¯å¦åŒæ„

é‚£ä¹ˆç”³è¯·äººçš„è¯·å‡ä¿¡æ¯ã€è¯·å‡æ—¶é—´ã€è¯·å‡ç†ç”±ã€‘æ˜¯å¦‚ä½•ç»‘å®šåˆ°æµç¨‹ä¸­çš„å‘¢? 

æ­¤æ—¶å°±éœ€è¦ä½¿ç”¨åˆ°`BusinessKey`

:::

### ä¸šåŠ¡æ ‡è¯†ï¼ˆBusinessKeyï¼‰

- å¯åŠ¨æµç¨‹å®ä¾‹æ—¶ï¼ŒæŒ‡å®šçš„ **businessKey** å°±ä¼šåœ¨ **act_run_execution** è¡¨ä¸­å­˜å‚¨ businessKeyã€‚
- **BusinessKey**ï¼šä¸šåŠ¡æ ‡è¯†ï¼Œé€šå¸¸ä¸ºä¸šåŠ¡è¡¨çš„ä¸»é”®ï¼Œä¸šåŠ¡æ ‡è¯†å’Œæµç¨‹å®ä¾‹ä¸€ä¸€å¯¹åº”ã€‚ä¸šåŠ¡æ ‡è¯†æ¥æºäºä¸šåŠ¡ç³»ç»Ÿã€‚å­˜å‚¨ä¸šåŠ¡æ ‡è¯†å°±æ˜¯æ ¹æ®ä¸šåŠ¡æ ‡è¯†æ¥å…³è”æŸ¥è¯¢ä¸šåŠ¡ç³»ç»Ÿçš„æ•°æ®ã€‚
- æ¯”å¦‚ï¼šè¯·å‡æµç¨‹å¯åŠ¨ä¸€ä¸ªæµç¨‹å®ä¾‹ï¼Œå°±å¯ä»¥å°†è¯·å‡å•çš„idä½œä¸ºä¸šåŠ¡æ ‡è¯†å­˜å‚¨åˆ°Activitiä¸­ï¼Œå°†æ¥æŸ¥è¯¢Activitiçš„æµç¨‹å®ä¾‹ä¿¡æ¯å°±å¯ä»¥è·å–è¯·å‡å•çš„idä»è€Œå…³è”æŸ¥è¯¢ä¸šåŠ¡ç³»ç»Ÿæ•°æ®åº“å¾—åˆ°è¯·å‡å•ä¿¡æ¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºğŸ‘‡

<img src="https://media.zenghr.cn/blog/img/20210722/hTmP6C.png" alt="hTmP6C"  />

```java
@Test
public void testStartProcess(){
    String businessKey = "8001";
    //åˆ›å»ºProcessEngineå¯¹è±¡
    ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();
    //è·å–RuntimeServiceå¯¹è±¡
    RuntimeService runtimeService = processEngine.getRuntimeService();
    // è®¾ç½®å¯¹åº”çš„å‚æ•°
    Map<String, Object> variables = new HashMap<String, Object>();
    // è®¾ç½®éƒ¨é—¨å®¡æ ¸äºº
    variables.put("deptLeader", "å¼ ä¸‰");
    //æ ¹æ®æµç¨‹å®šä¹‰çš„keyå¯åŠ¨æµç¨‹å®ä¾‹,è¿™ä¸ªkeyæ˜¯åœ¨å®šä¹‰bpmnçš„æ—¶å€™è®¾ç½®çš„
    //åœ¨å¯åŠ¨æµç¨‹çš„æ—¶å€™å°†ä¸šåŠ¡keyåŠ å…¥è¿›å»
    ProcessInstance instance = runtimeService
            .startProcessInstanceByKey("leaveProcess", businessKey, variables);
    //è·å–æµç¨‹å®ä¾‹çš„ç›¸å…³ä¿¡æ¯
    System.out.println("æµç¨‹å®šä¹‰çš„id = " + instance.getProcessDefinitionId());
    System.out.println("æµç¨‹å®ä¾‹çš„id = " + instance.getId());
}
```

> è·å–`BusinessKey`å¹¶å…³è”å¯¹åº”çš„ä¸šåŠ¡ä¿¡æ¯

```java
//è·å–ä»»åŠ¡é›†åˆ
List<Task> taskList = taskService.createTaskQuery()
  .processDefinitionKey("leaveProcess")
  .taskAssignee(assignee)
  .list();
//éå†ä»»åŠ¡åˆ—è¡¨
for(Task task:taskList){
  System.out.println("æµç¨‹å®šä¹‰id = " + task.getProcessDefinitionId());
  System.out.println("æµç¨‹å®ä¾‹id = " + task.getProcessInstanceId());
  System.out.println("ä»»åŠ¡id = " + task.getId());
  System.out.println("ä»»åŠ¡åç§° = " + task.getName());
  //æ ¹æ®ä»»åŠ¡ä¸Šçš„æµç¨‹å®ä¾‹IdæŸ¥è¯¢å‡ºå¯¹åº”çš„æµç¨‹å®ä¾‹å¯¹è±¡ï¼Œä»æµç¨‹å®ä¾‹å¯¹è±¡ä¸­è·å–BusinessKey
  ProcessInstance instance = runtimeService
    .createProcessInstanceQuery()
    .processInstanceId(task.getProcessInstanceId())
    .singleResult();
  System.out.println("ä¸šåŠ¡key:"+instance.getBusinessKey());
  System.out.println("===================");
}
```

### æµç¨‹æŒ‚èµ·ã€æ¿€æ´»

```java
@Test
public void testSuspendAllProcessInstance(){
    //åˆ›å»ºProcessEngineå¯¹è±¡
    ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();
    //è·å–RepositoryService
    RepositoryService repositoryService = processEngine.getRepositoryService();
    //è·å–æµç¨‹å®šä¹‰å¯¹è±¡
    ProcessDefinition processDefinition = repositoryService
            .createProcessDefinitionQuery()
            .processDefinitionKey("leaveProcess")
            .singleResult();
    boolean suspended = processDefinition.isSuspended();
    //è¾“å‡ºæµç¨‹å®šä¹‰çŠ¶æ€
    System.out.println("æµç¨‹å®šä¹‰çŠ¶æ€:"+(suspended ?"å·²æŒ‚èµ·":"å·²æ¿€æ´»"));
    String processDefinitionId = processDefinition.getId();
    if(suspended){
        //å¦‚æœæ˜¯æŒ‚èµ·ï¼Œå¯ä»¥æ‰§è¡Œæ¿€æ´»æ“ä½œ ,å‚æ•°1 ï¼šæµç¨‹å®šä¹‰id ï¼Œå‚æ•°2ï¼šæ˜¯å¦æ¿€æ´»æµç¨‹å®ä¾‹ï¼Œå‚æ•°3ï¼šæ¿€æ´»æ—¶é—´
        repositoryService.activateProcessDefinitionById(processDefinitionId,true,null);
        System.out.println("æµç¨‹ID:"+processDefinitionId+",å·²æ¿€æ´»");
    }else{
        //å¦‚æœæ˜¯æ¿€æ´»ï¼Œå¯ä»¥æ‰§è¡ŒæŒ‚èµ·æ“ä½œ ,å‚æ•°1 ï¼šæµç¨‹å®šä¹‰id ï¼Œå‚æ•°2ï¼šæ˜¯å¦æš‚åœæµç¨‹å®ä¾‹ï¼Œå‚æ•°3ï¼šæ¿€æ´»æ—¶é—´
        repositoryService.suspendProcessDefinitionById(processDefinitionId,true,null);
        System.out.println("æµç¨‹ID:"+processDefinitionId+",å·²æŒ‚èµ·");
    }
}
```

- æ“ä½œæµç¨‹å®šä¹‰ä¸ºæŒ‚èµ·çŠ¶æ€ï¼Œè¯¥æ“ä½œå®šä¹‰ä¸‹é¢çš„æ‰€æœ‰çš„æµç¨‹å®ä¾‹å°†å…¨éƒ¨æš‚åœ
- æµç¨‹å®šä¹‰ä¸ºæŒ‚èµ·çŠ¶æ€ï¼Œè¯¥æµç¨‹å®šä¹‰ä¸‹å°†ä¸å…è®¸å¯åŠ¨æ–°çš„æµç¨‹å®ä¾‹ï¼ŒåŒæ—¶è¯¥æµç¨‹å®šä¹‰ä¸‹çš„æ‰€æœ‰æµç¨‹å®ä¾‹å°†å…¨éƒ¨æŒ‚èµ·æš‚åœæ‰§è¡Œ

**æµç¨‹å®ä¾‹æŒ‚èµ·ã€æ¿€æ´»**

```java
@Test
public void testSuspendSingleProcessInstance(){
    //æµç¨‹å®ä¾‹Id
    String processInstanceId = "2501";
    //åˆ›å»ºProcessEngineå¯¹è±¡
    ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();
    //è·å–RepositoryService
    RuntimeService runtimeService = processEngine.getRuntimeService();
    //æ ¹æ®æµç¨‹å®ä¾‹Idè·å–æµç¨‹å®ä¾‹å¯¹è±¡
    ProcessInstance processInstance = runtimeService
            .createProcessInstanceQuery()
            .processInstanceId(processInstanceId)
            .singleResult();
    //çŠ¶æ€
    boolean suspended = processInstance.isSuspended();
    System.out.println("æµç¨‹å®ä¾‹ID:"+processInstanceId+",çŠ¶æ€:"+ (suspended?"å·²æŒ‚èµ·":"å·²æ¿€æ´»"));
    if(suspended){
        runtimeService.activateProcessInstanceById(processInstanceId);
        System.out.println("æµç¨‹å®ä¾‹ID:"+processInstanceId+",çŠ¶æ€ä¿®æ”¹ä¸ºå·²æ¿€æ´»");
    }else{
        runtimeService.suspendProcessInstanceById(processInstanceId);
        System.out.println("æµç¨‹å®ä¾‹ID:"+processInstanceId+",çŠ¶æ€ä¿®æ”¹ä¸ºå·²æŒ‚èµ·");
    }
}
```

## ä»»åŠ¡åˆ†é…è´Ÿè´£äºº

### å›ºå®šåˆ†é…

åœ¨è¿›è¡Œä¸šåŠ¡æµç¨‹å»ºæ¨¡çš„æ—¶å€™æŒ‡å®šå›ºå®šçš„ä»»åŠ¡è´Ÿè´£äºº

![ASn38W](https://media.zenghr.cn/blog/img/20210722/ASn38W.png)

### UEL è¡¨è¾¾å¼åˆ†é…

Activiti ä½¿ç”¨ UEL è¡¨è¾¾å¼ï¼Œ UEL æ˜¯ java EE6 è§„èŒƒçš„ä¸€éƒ¨åˆ†ï¼Œ UELï¼ˆUnified Expression Languageï¼‰å³ ç»Ÿä¸€è¡¨è¾¾å¼è¯­è¨€

![posPxS](https://media.zenghr.cn/blog/img/20210722/posPxS.png)

### ç›‘å¬å™¨åˆ†é…(ä½¿ç”¨éº»çƒ¦,æå°‘ä½¿ç”¨)

- ä»»åŠ¡ç›‘å¬å™¨æ˜¯å‘ç”Ÿå¯¹åº”çš„ä»»åŠ¡ç›¸å…³äº‹ä»¶æ—¶æ‰§è¡Œè‡ªå®šä¹‰çš„Javaé€»è¾‘æˆ–è¡¨è¾¾å¼
- ä»»åŠ¡ç›¸å…³äº‹ä»¶åŒ…æ‹¬ï¼š
  - **Eventï¼š**
    - Createï¼šä»»åŠ¡åˆ›å»ºåè§¦å‘ã€‚
    - Assignmentï¼šä»»åŠ¡åˆ†é…åè§¦å‘ã€‚
    - Deleteï¼šä»»åŠ¡å®Œæˆåè§¦å‘ã€‚
    - Allï¼šæ‰€æœ‰äº‹ä»¶å‘ç”Ÿéƒ½è§¦å‘ã€‚

**1. è‡ªå®šä¹‰ä¸€ä¸ªä»»åŠ¡ç›‘å¬å™¨ç±»ï¼Œç„¶åæ­¤ç±»å¿…é¡»å®ç°org.activiti.engine.delegate.TaskListeneræ¥å£**

```java
public class MyTaskListener implements TaskListener {
  @Override
  public void notify(DelegateTask delegateTask) {
    //è¿™é‡ŒæŒ‡å®šä»»åŠ¡è´Ÿè´£äºº
    if (delegateTask.getName().equals("éƒ¨é—¨ç»ç†å®¡æ‰¹")) {
      delegateTask.setAssignee("èµµå…­");
    } else if (delegateTask.getName().equals("éƒ¨é—¨ç»ç†å®¡æ‰¹")) {
      delegateTask.setAssignee("å­™ä¸ƒ");
    }
  }
}
```

**2. åœ¨bpmnæ–‡ä»¶ä¸­é…ç½®ç›‘å¬å™¨**

![upZLYx](https://media.zenghr.cn/blog/img/20210722/upZLYx.png)

## æµç¨‹å˜é‡

:::tip

æµç¨‹å˜é‡åœ¨Activitiä¸­æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„è§’è‰²ï¼Œæµç¨‹è¿è½¬æœ‰æ—¶éœ€è¦é æµç¨‹å˜é‡ï¼Œä¸šåŠ¡ç³»ç»Ÿå’ŒActivitiç»“åˆæ—¶å°‘ä¸äº†æµç¨‹å˜é‡ï¼Œæµç¨‹å˜é‡å°±æ˜¯Activitiåœ¨ç®¡ç†å·¥ä½œæµæ—¶æ ¹æ®ç®¡ç†éœ€è¦è€Œè®¾ç½®çš„å˜é‡

æ¯”å¦‚åœ¨è¯·å‡æµç¨‹æµè½¬æ—¶å¦‚æœ **è¯·å‡å¤©æ•°>3** å¤©åˆ™æœ‰æ€»ç»ç†å®¡æ‰¹ï¼Œå¦åˆ™ç”±äººäº‹ç›´æ¥å®¡æ‰¹ï¼Œè¯·å‡å¤©æ•°å°±å¯ä»¥è®¾ç½®æµç¨‹å˜é‡ï¼Œåœ¨æµç¨‹æµè½¬æ—¶ä½¿ç”¨

:::

### æµç¨‹å˜é‡ç±»å‹

![JdYxvc](https://media.zenghr.cn/blog/img/20210722/JdYxvc.png)

> æ³¨æ„ï¼šå¦‚æœå°†POJOå­˜å‚¨åˆ°æµç¨‹å˜é‡ä¸­ï¼Œå¿…é¡»å®ç°åºåˆ—åŒ–æ¥å£Serializableï¼Œä¸ºäº†é˜²æ­¢ç”±äºæ–°å¢å­—æ®µæ— æ³•ååºåˆ—åŒ–

### æµç¨‹å˜é‡çš„ä½œç”¨åŸŸ

æµç¨‹å˜é‡çš„ä½œç”¨åŸŸèŒƒå›´å¯ä»¥æ˜¯ä¸€ä¸ªæµç¨‹å®ä¾‹ï¼ˆProcessInstanceï¼‰ã€ä¸€ä¸ªä»»åŠ¡ï¼ˆTaskï¼‰æˆ–ä¸€ä¸ªæ‰§è¡Œå®ä¾‹ï¼ˆExecutionï¼‰

- **globalå˜é‡** : æµç¨‹å˜é‡çš„ä½œç”¨åŸŸèŒƒå›´çš„é»˜è®¤å€¼æ˜¯æµç¨‹å®ä¾‹ï¼Œä½œç”¨åŸŸèŒƒå›´æœ€å¤§ã€‚
- **localå˜é‡** : æµç¨‹å˜é‡çš„ä½œç”¨åŸŸèŒƒå›´å¦‚æœä»…ä»…é’ˆå¯¹ä¸€ä¸ªä»»åŠ¡æˆ–ä¸€ä¸ªæ‰§è¡Œå®ä¾‹ï¼Œé‚£ä¹ˆä½œç”¨åŸŸèŒƒå›´æ²¡æœ‰æµç¨‹å®ä¾‹å¤§

> å®é™…å¼€å‘ä¸­ä¸€èˆ¬ä¸ç”¨localå˜é‡ï¼Œäº†è§£å³å¯

### æµç¨‹å˜é‡çš„ä½¿ç”¨æ–¹æ³• 

- **åœ¨å±æ€§ä¸Šä½¿ç”¨UELè¡¨è¾¾å¼**

  å¯ä»¥åœ¨ assignee å¤„è®¾ç½® UEL è¡¨è¾¾å¼ï¼Œè¡¨è¾¾å¼çš„å€¼ä¸ºä»»åŠ¡çš„è´Ÿè´£äººï¼Œæ¯”å¦‚ï¼š `${assignee}ï¼Œ assignee` å°±æ˜¯ä¸€ä¸ªæµç¨‹å˜é‡åç§°ã€‚

  Activitiè·å– UELè¡¨è¾¾å¼ çš„å€¼ï¼Œå³æµç¨‹å˜é‡ assignee çš„å€¼ ï¼Œå°† assignee çš„å€¼ä½œä¸ºä»»åŠ¡çš„è´Ÿè´£äººè¿›è¡Œä»»åŠ¡åˆ†é…

- **åœ¨è¿çº¿ä¸Šä½¿ç”¨UELè¡¨è¾¾å¼**

  å¯ä»¥åœ¨è¿çº¿ä¸Šè®¾ç½®UELè¡¨è¾¾å¼ï¼Œå†³å®šæµç¨‹èµ°å‘ã€‚

  æ¯”å¦‚ï¼š`${price<10000}` priceå°±æ˜¯ä¸€ä¸ªæµç¨‹å˜é‡åç§°ï¼Œuelè¡¨è¾¾å¼ç»“æœç±»å‹ä¸ºå¸ƒå°”ç±»å‹ã€‚

  å¦‚æœUELè¡¨è¾¾å¼æ˜¯trueï¼Œè¦å†³å®š æµç¨‹æ‰§è¡Œèµ°å‘

### ä½¿ç”¨globalå˜é‡æ§åˆ¶æµç¨‹

åœ¨è¿çº¿å¤„æ·»åŠ åˆ¤æ–­æ¡ä»¶

![eI0vjg](https://media.zenghr.cn/blog/img/20210722/eI0vjg.png)

```java
@Test
public void testStartProcess(){
    //åˆ›å»ºProcessEngineå¯¹è±¡
    ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();
    //è·å–RuntimeServiceå¯¹è±¡
    RuntimeService runtimeService = processEngine.getRuntimeService();
    Map<String,Object> variables = new HashMap<String,Object>();
    variables.put("day",2);
    //æ ¹æ®æµç¨‹å®šä¹‰çš„keyå¯åŠ¨æµç¨‹å®ä¾‹,è¿™ä¸ªkeyæ˜¯åœ¨å®šä¹‰bpmnçš„æ—¶å€™è®¾ç½®çš„
    ProcessInstance instance = runtimeService.startProcessInstanceByKey("leaveVariablesProcess",variables);
    //è·å–æµç¨‹å®ä¾‹çš„ç›¸å…³ä¿¡æ¯
    System.out.println("æµç¨‹å®šä¹‰çš„id = " + instance.getProcessDefinitionId());
    System.out.println("æµç¨‹å®ä¾‹çš„id = " + instance.getId());
}
```

### æ‰§è¡Œtask è®¾ç½®æµç¨‹å˜é‡

**`taskService.setVariable(taskId,variableName,variableValue)`**

- **taskId** - ä»»åŠ¡ ID
- **variableName** - å˜é‡åç§°
- **variableValue** - å˜é‡å®é™…çš„å€¼

::: warning

1.å¦‚æœUELè¡¨è¾¾å¼ä¸­æµç¨‹å˜é‡åä¸å­˜åœ¨åˆ™æŠ¥é”™ã€‚
2.å¦‚æœå¦‚æœUELè¡¨è¾¾å¼éƒ½ä¸ç¬¦åˆæ¡ä»¶,æµç¨‹æŠ¥é”™ã€‚
3.å¦‚æœè¿æ¥ä¸è®¾ç½®æ¡ä»¶/æ¡ä»¶éƒ½æ»¡è¶³,æ¯ä¸ªè¿çº¿éƒ½ä¼šèµ°

:::

## ä»»åŠ¡å€™é€‰äºº

åœ¨æµç¨‹å®šä¹‰ä¸­åœ¨ä»»åŠ¡ç»“ç‚¹çš„ assignee å›ºå®šè®¾ç½®ä»»åŠ¡è´Ÿè´£äººï¼Œåœ¨æµç¨‹å®šä¹‰æ—¶å°†å‚ä¸è€…å›ºå®šè®¾ç½®åœ¨.bpmn æ–‡ä»¶ä¸­ï¼Œå¦‚æœä¸´æ—¶ä»»åŠ¡è´Ÿè´£äººå˜æ›´åˆ™éœ€è¦ä¿®æ”¹æµç¨‹å®šä¹‰ï¼Œç³»ç»Ÿå¯æ‰©å±•æ€§å·®ã€‚

é’ˆå¯¹è¿™ç§æƒ…å†µå¯ä»¥ç»™ä»»åŠ¡è®¾ç½®å¤šä¸ªå€™é€‰äººï¼Œå¯ä»¥ä»å€™é€‰äººä¸­é€‰æ‹©å‚ä¸è€…æ¥å®Œæˆä»»åŠ¡

### è®¾ç½®ä»»åŠ¡å€™é€‰äºº 

åœ¨æµç¨‹å›¾ä¸­ä»»åŠ¡èŠ‚ç‚¹çš„é…ç½®ä¸­è®¾ç½® candidate-users(å€™é€‰äºº)ï¼Œå¤šä¸ªå€™é€‰äººä¹‹é—´ç”¨é€—å·åˆ†å¼€

![YywESD](https://media.zenghr.cn/blog/img/20210722/YywESD.png)

**ä½¿ç”¨ Api è®¾ç½®å€™é€‰äºº**

**`taskService.addCandidateUser(taskId,candidateUser)`**

- **taskIdï¼š** ä»»åŠ¡ Id
- **candidateUser:** å€™é€‰äºº

### æŸ¥è¯¢å€™é€‰äººä»»åŠ¡

```java {11, 14}
//æŸ¥è¯¢å€™é€‰ä»»åŠ¡
@Test
public void testSelectCandidateTaskList(){
    //ä»»åŠ¡è´Ÿè´£äºº
    String candidateUser = "æå››";
    //åˆ›å»ºProcessEngineå¯¹è±¡
    ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();
    //è·å–TaskService
    TaskService taskService = processEngine.getTaskService();
    //è·å–ä»»åŠ¡é›†åˆ
    List<Task> taskList = taskService.createTaskQuery()
            .processDefinitionKey("leaveCandidateProcess")
            .taskCandidateUser(candidateUser)
            .list();
    //éå†ä»»åŠ¡åˆ—è¡¨
    for(Task task:taskList){
        System.out.println("æµç¨‹å®šä¹‰id = " + task.getProcessDefinitionId());
        System.out.println("æµç¨‹å®ä¾‹id = " + task.getProcessInstanceId());
        System.out.println("ä»»åŠ¡id = " + task.getId());
        System.out.println("ä»»åŠ¡åç§° = " + task.getName());
    }
}
```

::: warning

æ³¨æ„ï¼šåœ¨ SpringBoot é›†æˆ Activiti7 ä¸­ï¼Œä½¿ç”¨è¯¥ Api æŸ¥è¯¢å€™é€‰äººæ—¶ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¼‚å¸¸è¯¦ç»†ä»¥åŠè§£å†³æ–¹æ¡ˆè¯·çœ‹ [Activiti7 å¡«å‘ç¬”è®°](/passages/2021-07-22-activiti7-error-note.html)

:::

### é¢†å–ã€å®Œæˆå€™é€‰äººä»»åŠ¡

> å¦‚æœå€™é€‰ä»»åŠ¡æ²¡æœ‰è¿›è¡Œé¢†å–å°±ç›´æ¥å®Œæˆçš„è¯ï¼Œé‚£ä¹ˆåœ¨å†å²è®°å½•ä¸­å°±ä¸ä¼šè®°å½•æ˜¯å“ªä¸ªç”¨æˆ·æ‰§è¡Œäº†è¿™ä¸ªä»»åŠ¡
>
> æ‰€ä»¥å¯¹äºè¿™ç§å€™é€‰äººçš„ä»»åŠ¡ï¼Œæˆ‘ä»¬éœ€è¦å…ˆé¢†å–å†å®Œæˆ

```java
@Test
public void testClaimTask(){
    //ä»»åŠ¡ID
    String taskId = "2505";
    String assignee = "å¼ ä¸‰";
    //åˆ›å»ºProcessEngineå¯¹è±¡
    ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();
    //è·å–TaskService
    TaskService taskService = processEngine.getTaskService();
    //é¢†å–ä»»åŠ¡
    taskService.claim(taskId,assignee);
    // å®Œæˆä»»åŠ¡
  	taskService.complete(taskId);
}
```

## ç½‘å…³ç›¸å…³

### æ’ä»–ç½‘å…³

æ’ä»–ç½‘å…³(ExclusiveGateway)ï¼ˆå¼‚æˆ–ç½‘å…³æˆ–åŸºäºæ•°æ®çš„æ’ä»–ç½‘å…³ï¼‰ï¼Œç”¨æ¥åœ¨æµç¨‹ä¸­å®ç°å†³ç­–ã€‚å½“æµç¨‹æ‰§è¡Œåˆ°è¿™ä¸ªç½‘å…³çš„æ—¶å€™ï¼Œæ‰€æœ‰åˆ†æ”¯éƒ½ä¼šåˆ¤æ–­æ¡ä»¶æ˜¯å¦ä¸ºtrueï¼Œå¦‚æœä¸ºtrueåˆ™æ‰§è¡Œè¯¥åˆ†æ”¯

![fdgdQz](https://media.zenghr.cn/blog/img/20210722/fdgdQz.png)

### å¹¶è¡Œç½‘å…³

å¹¶è¡Œç½‘å…³(InclusiveGateway)å…è®¸å°†æµç¨‹åˆ†æˆå¤šæ¡åˆ†æ”¯ï¼Œä¹Ÿå¯ä»¥æŠŠå¤šæ¡åˆ†æ”¯æ±‡èšåˆ°ä¸€èµ·ï¼Œå¹¶è¡Œç½‘å…³çš„åŠŸèƒ½æ˜¯åŸºäºè¿›å…¥å’Œå¤–å‡ºçš„é¡ºåºæµçš„

> å¹¶è¡Œç½‘å…³ä¸ä¼šè§£ææ¡ä»¶ã€‚å³ä½¿é¡ºåºæµä¸­å®šä¹‰äº†æ¡ä»¶ï¼Œä¹Ÿä¼šè¢«å¿½ç•¥

![J4KD0z](https://media.zenghr.cn/blog/img/20210722/J4KD0z.png)

### åŒ…å«ç½‘å…³

åŒ…å«ç½‘å…³å¯ä»¥çœ‹åšæ˜¯æ’ä»–ç½‘å…³å’Œå¹¶è¡Œç½‘å…³çš„ç»“åˆä½“

![bVI3wP](https://media.zenghr.cn/blog/img/20210722/bVI3wP.png)

